<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code</title>
<!-- SEO Elements -->
<meta name="description" content="Notes2LLM: A free tool for post-processing HTML, CSS, and JavaScript generated in a chat interface with AI. Edit text, change image sources, add comments for LLMs and refine code.">
<meta name="keywords" content="notes2llm, ai coding, html editor, css editor, javascript editor, llm, large language model, code refining, web development, ai assistant, code editing">
<meta name="author" content="Luke Liniewicz">
<meta property="og:title" content="Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code">
<meta property="og:description" content="Edit and refine code generated by AI language models with this free, browser-based tool. Add comments, modify elements, and send back for further refinement.">
<meta property="og:image" content="https://notes2llm.liniewicz.info/logo.png">
<meta property="og:url" content="https://notes2llm.liniewicz.info">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code">
<meta name="twitter:description" content="Edit and refine code generated by AI language models with this free, browser-based tool.">
<meta name="twitter:image" content="https://notes2llm.liniewicz.info/logo.png">
<link rel="canonical" href="https://notes2llm.liniewicz.info">
<style>
/* Basic Reset & Body Styling */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { 
	height: 100%; 
	overflow: hidden; 
	font-family: 'Roboto', sans-serif; 
	color: #384D68;
}
	 /* App Layout */
	.n2l-app-container {
		display: flex;
		height: 100vh;
	}

	/* Sidebar */
	.n2l-sidebar {
		width: 350px; /* Initial width */
		min-width: 250px; /* Minimum width */
		max-width: 60%;  /* Maximum width */
		background-color: #f0f0f0;
		border-right: 1px solid #ccc;
		padding: 15px;
		display: flex;
		flex-direction: column;
		overflow-y: auto;
	}

	/* Sidebar Header with Logo */
	.n2l-sidebar-header {
		display: flex;
		align-items: center;
		margin-bottom: 15px;
	}

	.n2l-sidebar-logo {
		height: 24px;
		margin-right: 10px;
	}

	/* Resizer Handle */
	.n2l-resizer {
		width: 5px;
		background-color: #ccc;
		cursor: ew-resize;
		height: 100%;
	}
	.n2l-resizer:hover {
		background-color: #aaa;
	}

	/* Preview Pane */
	.n2l-preview-pane {
		flex-grow: 1; /* Takes remaining space */
		height: 100%;
		background-color: #fff;
		position: relative; /* Needed for absolute positioning context of iframe */
	}

	#n2l-preview-iframe {
		width: 100%;
		height: 100%;
		border: none;
		background-color: #fff; /* Ensure iframe bg is white */
	}

	/* Controls Styling (Sidebar) */
	.n2l-sidebar h3 {
		margin-top: 9px;
		margin-bottom: 5px;
		padding-bottom: 3px;
		color: #384D68;
		font-weight: 300;
	}
	.n2l-sidebar label {
		display: block;
		margin-top: 10px;
		font-size: 0.9em;
		font-weight: bold;
		color: #384D68;
	}
	.n2l-sidebar input[type="text"],
	.n2l-sidebar input[type="color"],
	.n2l-sidebar input[type="number"],
	.n2l-sidebar textarea {
		width: 100%;
		padding: 8px;
		margin-top: 4px;
		border: 1px solid #ccc;
		border-radius: 0;
		font-size: 0.9em;
		font-family: 'Roboto', sans-serif;
	}

	.n2l-sidebar textarea {
		min-height: 80px;
		resize: vertical;
		font-family: monospace;
		width: 100%;
		padding: 8px;
		margin-top: 4px;
		border: 1px solid #ccc;
		border-radius: 0;
		font-size: 0.9em;
	}
	.n2l-sidebar button { /* Updated button style */
		background-color: white;
		color: #384D68;
		border: 1px solid #384D68;
		border-radius: 0;
		padding: 8px 12px;
		margin-top: 10px;
		margin-right: 5px;
		cursor: pointer;
		transition: background-color 0.2s ease;
		font-family: 'Roboto', sans-serif;
	}
	.n2l-sidebar button:hover {
		background-color: #f0f0f0;
	}
	 .n2l-sidebar button.secondary {
		background-color: white;
	 }
	 .n2l-sidebar button.secondary:hover {
		background-color: #f0f0f0;
	 }
	
	.n2l-sidebar button.preview-active {
		background-color: #28a745;
		color: white;
		border-color: #28a745;
	}
	.n2l-sidebar button.preview-active:hover {
		background-color: #218838;
	}

	#n2l-controls-panel {
		margin-top: 20px;
		border-top: 2px solid #ccc;
		padding-top: 15px;
	}
	 #n2l-element-info {
		 font-size: 0.8em;
		 color: #384D68;
		 margin-bottom: 10px;
		 word-wrap: break-word;
	 }
	.n2l-control-group {
		margin-bottom: 15px;
		padding: 10px;
		background-color: #e9e9e9;
		border-radius: 0;
		border: 1px solid #ddd;
	}
	.n2l-inline-controls label {
		display: inline-block;
		margin-right: 5px;
		width: auto;
	}
	 .n2l-inline-controls input {
		 width: 60px;
		 margin-right: 10px;
	 }
	 .n2l-inline-controls input[type="color"] {
		 width: 40px;
		 padding: 2px;
		 vertical-align: middle;
	 }

	/* Action Toolbar (Floating) */
	#n2l-action-toolbar {
		position: absolute; /* Position relative to main viewport */
		display: none; /* Hidden by default */
		background-color: rgba(0, 0, 0, 0.85);
		padding: 5px 8px;
		border-radius: 0;
		border: 1px solid #ccc;
		z-index: 1000; /* Ensure it's above iframe content */
		box-shadow: 0 2px 5px rgba(0,0,0,0.3);
		white-space: nowrap; /* Prevent wrapping */
	}
	
	/* Selector indicator above the toolbar */
	#n2l-selector-indicator {
		position: absolute;
		display: none; /* Hidden by default */
		background-color: rgba(56, 77, 104, 0.9);
		color: white;
		padding: 3px 6px;
		font-size: 0.8em;
		border-radius: 0;
		z-index: 1001; /* Above toolbar */
		max-width: 300px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		box-shadow: 0 1px 3px rgba(0,0,0,0.2);
	}
	
	#n2l-action-toolbar button {
		background: none;
		border: none;
		color: white;
		cursor: pointer;
		padding: 4px 6px;
		font-size: 1.1em; /* Slightly larger icons/text */
		margin: 0 3px;
		vertical-align: middle;
		transition: color 0.2s ease;
	}
	#n2l-action-toolbar button:hover {
		color: #384D68; /* Updated hover color */
	}
	#n2l-action-toolbar button.danger:hover {
		color: #ff4d4d; /* Lighter red hover for danger */
	}

	/* Style for selected element in iframe */
	.N2L_EDITOR_SELECTED {
		outline: 2px dashed #384D68 !important;
		box-shadow: 0 0 10px rgba(56, 77, 104, 0.5);
	}
	
	/* CSS Rules Editor */
	#n2l-css-rules-editor {
		max-height: 300px;
		overflow-y: auto;
	}
	
	/* Integrated class/ID and CSS management section */
	.n2l-selector-manager {
		margin-bottom: 15px;
		padding: 10px;
		background-color: #f0f0f0;
		border: 1px solid #ddd;
		border-radius: 0;
	}
	
	.n2l-selector-inputs {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
		margin-bottom: 10px;
	}
	
	.n2l-selector-inputs > div {
		flex: 1;
		min-width: 100px;
	}
	
	.n2l-selector-manager h4 {
		margin-bottom: 8px;
		color: #384D68;
	}
	
	.n2l-css-rule-item {
		margin-bottom: 10px;
		padding: 8px;
		background-color: #f8f8f8;
		border: 1px solid #ddd;
		border-radius: 0;
	}
	
	.n2l-css-selector {
		font-weight: bold;
		color: #384D68;
		margin-bottom: 4px;
	}
	
	.n2l-css-properties {
		width: 100%;
		font-family: monospace;
		height: 60px;
		margin-bottom: 5px;
	}
	
	.n2l-rule-actions {
		display: flex;
		justify-content: flex-end;
	}
	
	.n2l-rule-actions button {
		padding: 3px 8px;
		font-size: 0.8em;
		margin-left: 5px;
	}

	/* Checkbox slider for "Apply to element" */
	.n2l-slider-container {
		display: flex;
		align-items: center;
		margin-top: 8px;
	}
	
	.n2l-slider {
		position: relative;
		display: inline-block;
		width: 40px;
		height: 20px;
		margin-right: 8px;
	}
	
	.n2l-slider input {
		opacity: 0;
		width: 0;
		height: 0;
	}
	
	.n2l-slider-switch {
		position: absolute;
		cursor: pointer;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: #ccc;
		transition: .4s;
		border-radius: 20px;
	}
	
	.n2l-slider-switch:before {
		position: absolute;
		content: "";
		height: 16px;
		width: 16px;
		left: 2px;
		bottom: 2px;
		background-color: white;
		transition: .4s;
		border-radius: 50%;
	}
	
	input:checked + .n2l-slider-switch {
		background-color: #384D68;
	}
	
	input:checked + .n2l-slider-switch:before {
		transform: translateX(20px);
	}
	
	.n2l-slider-label {
		font-size: 0.8em;
		color: #555;
	}

	/* Modal buttons */
	.modal-button {
		background-color: white;
		color: #384D68;
		border: 1px solid #384D68;
		border-radius: 0;
		padding: 5px 10px;
		margin-top: 10px;
		margin-right: 10px;
		cursor: pointer;
	}
	.modal-button:hover {
		background-color: #f0f0f0;
	}
	
	/* Preview mode indicator */
	.preview-mode-frame {
		border: 3px solid #28a745 !important;
	}
	
	/* Preview mode notification */
	#n2l-preview-mode-indicator {
		position: absolute;
		bottom: 10px;
		right: 10px;
		background-color: rgba(40, 167, 69, 0.8);
		color: white;
		padding: 5px 10px;
		border-radius: 3px;
		font-size: 12px;
		z-index: 1000;
		display: none;
	}

	/* Terms Modal Styles */
	.n2l-modal {
		display: none; 
		position: fixed;
		z-index: 2000;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		overflow: auto;
		background-color: rgba(0,0,0,0.6);
	}

	.n2l-modal-content {
		background-color: #fefefe;
		margin: 5% auto;
		padding: 25px;
		border: 1px solid #888;
		width: 75%;
		max-width: 800px;
		box-shadow: 0 4px 15px rgba(0,0,0,0.2);
		border-radius: 0;
	}

	.n2l-modal-header {
		display: flex;
		align-items: center;
		margin-bottom: 20px;
		border-bottom: 1px solid #ddd;
		padding-bottom: 15px;
	}

	.n2l-logo {
		height: 60px;
		margin-right: 20px;
	}

	.n2l-modal-header h2 {
		color: #384D68;
		margin: 0;
		font-size: 28px;
		font-weight: 400;
	}

	.n2l-modal-body {
		margin-bottom: 25px;
	}

	.n2l-modal-body p {
		line-height: 1.6;
		margin-bottom: 20px;
		color: #384D68;
	}

	.n2l-modal-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-top: 20px;
		padding-top: 15px;
		border-top: 1px solid #ddd;
		font-size: 14px;
		color: #666;
	}

	.n2l-close {
		position: absolute;
		top: 15px;
		right: 20px;
		color: #999;
		font-size: 28px;
		font-weight: bold;
		cursor: pointer;
	}

	.n2l-close:hover {
		color: #555;
	}

	/* Welcome Page Styles - UPDATED */
	.n2l-welcome-page {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: #f5f5f5;
		z-index: 2000;
		overflow-y: auto;
	}

	.n2l-welcome-container {
		display: flex;
		width: 100%;
		height: 100%;
		max-width: 1800px;
		margin: 0 auto;
		background-color: #f5f5f5; 
	}

	.n2l-welcome-left {
		flex: 2; 
		padding: 20px;
		display: flex;
		flex-direction: column;
		border-right: 1px solid #ddd;
	}

	.n2l-welcome-right {
		flex: 1; 
		padding: 10px;
		display: flex;
		flex-direction: column;
	}

	/* Updated welcome header with GitHub link */
	.n2l-welcome-header {
		display: flex;
		align-items: center;
		margin-bottom: 10px;
	}

	.n2l-welcome-logo {
		width: 150px;
		height: auto;
		margin-right: 20px;
	}

	.n2l-title-container {
		display: flex;
		flex-direction: column;
		justify-content: center;
		height: 100%;
	}

	.n2l-welcome-left h1 {
		font-size: 36px;
		color: #384D68;
		font-weight: 400;
		margin: 0;
		line-height: 1.2;
	}

	/* New donation link style */
	.n2l-donation-link {
		color: #384D68;
		text-decoration: none;
		font-size: 15px;
		margin-top: 8px;
		display: inline-block;
		padding: 3px 10px;
		border: 1px dashed #384D68;
		background-color: rgba(56, 77, 104, 0.05);
		transition: all 0.2s ease;
	}

	.n2l-donation-link:hover {
		background-color: rgba(56, 77, 104, 0.1);
		text-decoration: underline;
	}

	.n2l-donation-link i {
		margin-right: 5px;
	}

	/* External links container */
	.n2l-external-links {
		display: flex;
		gap: 15px;
		margin-top: 4px;
	}

	.n2l-github-link, .n2l-pandrator-link {
		color: #384D68;
		text-decoration: none;
		font-size: 14px;
		display: flex;
		align-items: center;
		transition: color 0.2s ease;
	}

	.n2l-github-link:hover, .n2l-pandrator-link:hover {
		text-decoration: underline;
	}

	.n2l-github-link i, .n2l-pandrator-link i {
		margin-right: 5px;
	}

	.n2l-welcome-text {
		flex: 1;
	}

	.n2l-welcome-text p {
		line-height: 1.6;
		margin-bottom: 10px;
		color: #384D68;
		font-size: 16px;
	}

	.n2l-example-prompt {
		margin: 30px 0;
		border: 1px solid #ddd;
		padding: 20px;
		background-color: #f9f9f9;
	}

	.n2l-example-prompt h3 {
		color: #384D68;
		margin-bottom: 15px;
		font-weight: 500;
	}

	.n2l-prompt-box {
		background-color: #f0f0f0;
		padding: 15px;
		border: 1px solid #ddd;
	}

	.n2l-prompt-box code {
		display: block;
		color: #384D68;
		line-height: 1.5;
		font-family: monospace;
	}

	/* UPDATED: Feature cards */
	.n2l-features {
		margin-top: 30px;
	}

	.n2l-features h3 {
		color: #384D68;
		margin-bottom: 20px;
		font-weight: 500;
	}

	.n2l-feature-cards {
		display: flex;
		flex-wrap: wrap;
		gap: 15px;
	}

	.n2l-feature-card {
		flex: 1;
		min-width: 200px;
		background-color: #f9f9f9;
		border: 1px solid #ddd;
		padding: 15px;
		border-radius: 0;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	.n2l-feature-card:hover {
		transform: translateY(-3px);
		box-shadow: 0 5px 15px rgba(0,0,0,0.1);
	}

	.n2l-feature-card i {
		font-size: 24px;
		color: #384D68;
		margin-bottom: 10px;
		display: block;
	}

	.n2l-feature-card p {
		color: #384D68;
		margin: 0;
	}

	.n2l-welcome-right h2 {
		color: #384D68;
		margin-bottom: 20px;
		font-weight: 400;
	}

	.n2l-welcome-right p {
		margin-bottom: 20px;
		color: #555;
	}

	.n2l-code-input-container {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	#n2l-welcome-code-input {
		flex: 1;
		min-height: 400px;
		padding: 15px;
		border: 1px solid #ddd;
		font-family: monospace;
		font-size: 14px;
		resize: none;
		margin-bottom: 20px;
	}

	.n2l-input-buttons {
		display: flex;
		justify-content: space-around;
	}

	.n2l-welcome-btn {
		padding: 12px 12px;
		cursor: pointer;
		font-size: 14px;
		border: 1px solid #384D68;
		transition: background-color 0.3s;
	}

	.n2l-welcome-btn.primary {
		background-color: #384D68;
		color: white;
	}

	.n2l-welcome-btn.primary:hover {
		background-color: #2a3a4d;
	}

	.n2l-welcome-btn.secondary {
		background-color: white;
		color: #384D68;
	}

	.n2l-welcome-btn.secondary:hover {
		background-color: #f0f0f0;
	}

	.n2l-footer-links {
		margin-top: 30px;
		padding-top: 20px;
		border-top: 1px solid #ddd;
		display: flex;
		flex-wrap: wrap;
		gap: 20px;
		font-size: 14px;
		color: #666;
	}

	.n2l-footer-links a {
		color: #384D68;
		text-decoration: none;
	}

	.n2l-footer-links a:hover {
		text-decoration: underline;
	}

	.n2l-workflow-steps {
		display: flex;
		justify-content: space-between;
		margin: 30px 0;
	}

	.n2l-step {
		flex: 1;
		padding: 15px;
		border: 1px solid #ddd;
		margin: 0 10px;
		text-align: center;
		background-color: #f9f9f9;
	}

	.n2l-step i {
		font-size: 24px;
		color: #384D68;
		margin-bottom: 10px;
	}

	.n2l-step h4 {
		margin-bottom: 10px;
		color: #384D68;
	}

	.n2l-step p {
		font-size: 14px;
		color: #666;
	}
	
	/* New CSS Rule form */
	.n2l-new-rule-form {
		background-color: #f0f0f0;
		padding: 10px;
		border: 1px dashed #ccc;
		margin-top: 10px;
	}
	
	.n2l-new-rule-form input,
	.n2l-new-rule-form textarea {
		width: 100%;
		margin-bottom: 8px;
	}
	
	.n2l-new-rule-form label {
		display: block;
		margin-bottom: 5px;
		font-size: 0.9em;
	}
	
	.n2l-add-rule-btn {
		display: block;
		width: 100%;
		text-align: center;
		padding: 8px;
		margin-top: 8px;
		background-color: #f0f0f0;
		border: 1px dashed #384D68;
		color: #384D68;
		cursor: pointer;
	}
	
	.n2l-add-rule-btn:hover {
		background-color: #e0e0e0;
	}

	/* Prompt Generator Modal Styles */
	.n2l-prompt-modal-content {
		width: 90%;
		max-width: 1200px;
		height: 85vh;
		max-height: 85vh;
		overflow: hidden;
		padding: 20px;
	}

	#n2l-prompt-generator-iframe {
		width: 100%;
		height: calc(100% - 70px); /* Subtract header height */
		border: none;
		overflow: auto;
	}

	.n2l-prompt-generator-container {
		padding: 0;
		height: calc(100% - 70px);
		overflow: hidden;
	}
	
	/* Prompt Generator Button - Welcome Page */
	.n2l-prompt-gen-container {
		margin: 20px 0;
		background-color: #f9f9f9;
		border: 1px solid #ddd;
		padding: 15px;
		border-radius: 0;
	}
	
	.n2l-prompt-gen-container h3 {
		color: #384D68;
		margin-bottom: 10px;
		font-weight: 500;
		font-size: 16px;
	}
	
	.n2l-prompt-gen-container p {
		margin-bottom: 15px;
		color: #555;
		font-size: 14px;
	}
	
	.n2l-prompt-gen-btn {
		display: inline-block;
		background-color: white;
		color: #384D68;
		border: 1px solid #384D68;
		padding: 8px 15px;
		cursor: pointer;
		transition: all 0.2s ease;
	}
	
	.n2l-prompt-gen-btn:hover {
		background-color: #f0f0f0;
	}
	
	.n2l-prompt-gen-btn i {
		margin-right: 5px;
	}
</style>
<!-- Include Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Include Roboto font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
   
</head>
<body>
<!-- Welcome Page -->
<div id="n2l-welcome-page" class="n2l-welcome-page">
	<div class="n2l-welcome-container">
		<div class="n2l-welcome-left">
			<!-- Updated header with logo and title/github link -->
			<div class="n2l-welcome-header">
				<img src="logo.png" alt="Notes2LLM Logo" class="n2l-welcome-logo">
				<div class="n2l-title-container">
					<h1>Notes2LLM</h1>
					<!-- New donation link -->
					<a href="https://iarf.net/support-us/" class="n2l-donation-link" target="_blank">
						<i class="fas fa-heart"></i> If you found this app useful, please consider donating to the IARF
					</a>
					<!-- Updated external links container -->
					<div class="n2l-external-links">
						<a href="https://github.com/liniewicz/notes2llm" class="n2l-github-link" target="_blank">
							<i class="fab fa-github"></i> View on GitHub
						</a>
						<a href="https://github.com/lukaszliniewicz/Pandrator" class="n2l-pandrator-link" target="_blank">
							<i class="fas fa-headphones"></i> Check out Pandrator: audiobook and dubbing generator
						</a>
					</div>
				</div>
			</div>
			
			<div class="n2l-welcome-text">
				<p>The purpose of this tool is to help you post-process HTML, CSS and Javascript generated in a chat interface - you can easily edit the text, change image source URLs, duplicate elements, remove them, edit their CSS and HTML and add comments for the LLM with notes how to refine or expand an element or a section.</p>
				
				<p>This can be used for static pages, Wordpress posts, pages and custom widgets, email newsletters and so on.</p>
				
				<div class="n2l-workflow-steps">
					<div class="n2l-step">
						<i class="fas fa-code"></i>
						<h4>Generate Code</h4>
						<p>Get code from your favorite LLM assistant</p>
					</div>
					<div class="n2l-step">
						<i class="fas fa-edit"></i>
						<h4>Edit & Comment</h4>
						<p>Modify elements and add revision comments</p>
					</div>
					<div class="n2l-step">
						<i class="fas fa-sync-alt"></i>
						<h4>Refine with LLM</h4>
						<p>Send back for further refinement</p>
					</div>
				</div>

				<p>Either paste all code elements (HTML, CSS, JS) one by one (please use &lt;style&gt; and &lt;script&gt; tags), or ask the LLM to give you a single code block.</p>
				
				<div class="n2l-example-prompt">
					<h3>Example prompt:</h3>
					<div class="n2l-prompt-box">
						<code>Please give me a single code block that can be used in a Wordpress custom html widget with HTML, CSS and JS - within style and script tags.</code>
					</div>
				</div>
				
				<!-- Updated features as cards -->
				<div class="n2l-features">
					<h3>With Notes2LLM you can:</h3>
					<div class="n2l-feature-cards">
						<div class="n2l-feature-card">
							<i class="fas fa-edit"></i>
							<p>Edit text content and image sources directly</p>
						</div>
						<div class="n2l-feature-card">
							<i class="fas fa-clone"></i>
							<p>Duplicate elements above or below existing ones</p>
						</div>
						<div class="n2l-feature-card">
							<i class="fas fa-trash-alt"></i>
							<p>Remove unwanted elements with a single click</p>
						</div>
						<div class="n2l-feature-card">
							<i class="fas fa-comment"></i>
							<p>Add revision comments for LLMs to improve specific sections</p>
						</div>
						<div class="n2l-feature-card">
							<i class="fas fa-code"></i>
							<p>Edit HTML and CSS directly with a real-time preview</p>
						</div>
						<div class="n2l-feature-card">
							<i class="fas fa-eye"></i>
							<p>Toggle preview mode to test interactions</p>
						</div>
					</div>
				</div>
			</div>
			<div class="n2l-footer-links">
				<a href="#" id="n2l-terms-link">Terms and Conditions</a>
				<span>MIT License &copy; Luke Liniewicz, 2025</span>
			</div>
		</div>
		<div class="n2l-welcome-right">
			<h2>Get Started</h2>
			<p>Paste your code below or use our example:</p>
			
			<!-- Added Prompt Generator section -->
			<div class="n2l-prompt-gen-container">
				<h3>Need help creating code?</h3>
				<p>Our prompt generator helps you create effective prompts for LLMs to generate exactly the code you need.</p>
				<button id="n2l-open-prompt-gen-btn" class="n2l-prompt-gen-btn">
					<i class="fas fa-magic"></i> Generate LLM Prompt for Code
				</button>
			</div>
			
			<div class="n2l-code-input-container">
				<textarea id="n2l-welcome-code-input" placeholder="Paste your HTML, CSS (<style>), and JS (<script>) block here..."></textarea>
				<div class="n2l-input-buttons">
					<button id="n2l-use-example-btn" class="n2l-welcome-btn secondary"><i class="fas fa-lightbulb"></i> Use Example Code</button>
					<button id="n2l-welcome-load-btn" class="n2l-welcome-btn primary"><i class="fas fa-play"></i> Load & Render Code</button>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Terms and Conditions Modal -->
<div id="n2l-terms-modal" class="n2l-modal">
	<div class="n2l-modal-content">
		<span class="n2l-close">&times;</span>
		<div class="n2l-modal-header">
			<h2>Terms and Conditions</h2>
		</div>
		<div class="n2l-modal-body">
			<p>This tool is made available for use as-is, free of charge, without any warranties or guarantees of any kind, either expressed or implied. The author is not liable for any damages or issues arising from the use of this tool.</p>
			<p>No data whatsoever is collected when using Notes2LLM. All processing happens entirely in your browser.</p>
		</div>
	</div>
</div>

<!-- Prompt Generator Modal -->
<div id="n2l-prompt-generator-modal" class="n2l-modal">
	<div class="n2l-modal-content n2l-prompt-modal-content">
		<span class="n2l-close">&times;</span>
		<div class="n2l-modal-header">
			<h2>Notes2LLM Prompt Generator</h2>
		</div>
		<div class="n2l-modal-body n2l-prompt-generator-container">
			<iframe id="n2l-prompt-generator-iframe" src="prompt_generator.html" frameborder="0"></iframe>
		</div>
	</div>
</div>

<div class="n2l-app-container">
<div class="n2l-sidebar" id="n2l-sidebar">
<!-- Added sidebar header with logo -->
<div class="n2l-sidebar-header">
	<img src="logo.png" alt="Notes2LLM Logo" class="n2l-sidebar-logo">
	<h3>Notes2LLM</h3>
</div>
<button id="n2l-get-code-btn" class="secondary">Get Processed Code</button>
<button id="n2l-preview-mode-btn">Enter Preview Mode</button>

	 <div id="n2l-controls-panel" style="display: none;">
			<h3>Selected Element</h3>
			<div id="n2l-element-info">Tag: N/A</div>

			<!-- Text Editing - Reorganized -->
			<div id="n2l-text-edit-control" class="n2l-control-group" style="display: none;">
				<h3>Text</h3>
				<p>Edit text content directly:</p>
				<textarea id="n2l-text-editor"></textarea>
				<button id="n2l-apply-text-change">Apply Text</button>
			</div>

			 <!-- Image Source Editing - Reorganized -->
			<div id="n2l-image-src-control" class="n2l-control-group" style="display: none;">
				<h3>Image</h3>
				<label for="n2l-image-src-input">Image Source (URL):</label>
				<input type="text" id="n2l-image-src-input">
				<button id="n2l-apply-src-change">Apply Source</button>
			</div>

			<!-- CSS Control - Reorganized -->
			<div id="n2l-css-control" class="n2l-control-group">
				<h3>Style</h3>
				
				<!-- Selector inputs (was part of selector manager) -->
				<div class="n2l-selector-inputs">
					<div>
						<label for="n2l-element-class">Classes:</label>
						<input type="text" id="n2l-element-class" placeholder="e.g. btn primary">
					</div>
					<div>
						<label for="n2l-element-id">ID:</label>
						<input type="text" id="n2l-element-id" placeholder="e.g. main-header">
					</div>
				</div>
				
				<!-- Two buttons for operations -->
				<div style="display: flex; gap: 5px;">
					<button id="n2l-apply-class-id">Add/Modify Selector</button>
					<button id="n2l-add-css-rule-btn">Add Rule</button>
				</div>
				
				<!-- CSS rules editor -->
				<div id="n2l-css-rules-editor" style="margin-top: 15px;">
					<!-- CSS rules will be populated here -->
					<div class="n2l-no-rules-message">No CSS rules found for this element.</div>
				</div>
			</div>

			<!-- Full HTML Editor -->
			<div id="n2l-html-control" class="n2l-control-group">
				<h3>HTML</h3>
				<label for="n2l-element-html-editor">Edit Element HTML:</label>
				<textarea id="n2l-element-html-editor"></textarea>
				<button id="n2l-apply-html-changes">Apply HTML</button>
			</div>
		</div>
	</div>

	<div class="n2l-resizer" id="n2l-resizer"></div>

	<div class="n2l-preview-pane">
		<iframe id="n2l-preview-iframe"></iframe>
		<div id="n2l-preview-mode-indicator">Preview Mode: Click elements to interact</div>
	</div>
</div>

<!-- Selector Indicator (appears above toolbar) -->
<div id="n2l-selector-indicator"></div>

<!-- Floating Action Toolbar -->
<div id="n2l-action-toolbar">
	<button id="n2l-copy-above-btn" title="Copy Above"><i class="fas fa-arrow-up"></i> <i class="far fa-copy"></i></button>
	<button id="n2l-copy-below-btn" title="Copy Below"><i class="far fa-copy"></i> <i class="fas fa-arrow-down"></i></button>
	<button id="n2l-add-comment-above-btn" title="Comment Above"><i class="fas fa-arrow-up"></i> <i class="far fa-comment-dots"></i></button>
	<button id="n2l-add-comment-below-btn" title="Comment Below"><i class="far fa-comment-dots"></i> <i class="fas fa-arrow-down"></i></button>
	<button id="n2l-toggle-state-btn" title="Toggle Element State"><i class="fas fa-exchange-alt"></i></button>
	<button id="n2l-remove-btn" class="danger" title="Remove Element"><i class="fas fa-trash-alt"></i></button>
</div>


<script>
	// CSS Parser and Manager
	class Notes2LLMCssManager {
		constructor() {
			this.cssRules = [];
			this.originalCssText = '';
		}
		
		parseCss(cssText) {
			this.originalCssText = cssText;
			this.cssRules = [];
			
			// Simple CSS parser - handles most common cases
			const ruleRegex = /([\s\S]*?)\s*\{([\s\S]*?)\}/g;
			let match;
			
			while ((match = ruleRegex.exec(cssText)) !== null) {
				const selector = match[1].trim();
				const cssProperties = match[2].trim();
				
				if (selector && cssProperties) {
					this.cssRules.push({
						selector: selector,
						properties: cssProperties
					});
				}
			}
			
			return this.cssRules;
		}
		
		getMatchingRules(element) {
			if (!element) return [];
			
			const matchingRules = [];
			
			this.cssRules.forEach(rule => {
				try {
					// Special case for selectors that contain a comma (multiple selectors in one rule)
					const selectors = rule.selector.split(',').map(s => s.trim());
					
					// Check each selector in the rule
					for (const selector of selectors) {
						try {
							// Check if this single selector matches the element
							if (element.matches(selector)) {
								matchingRules.push({...rule, matchedBy: selector});
								break; // One match within the comma-separated list is enough
							}
						} catch (selectorError) {
							console.warn(`Invalid selector part "${selector}" in rule "${rule.selector}"`, selectorError);
						}
					}
				} catch (error) {
					console.warn(`Error checking if element matches selector "${rule.selector}"`, error);
				}
			});
			
			return matchingRules;
		}
		
		updateRule(selector, newProperties) {
			const ruleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (ruleIndex !== -1) {
				this.cssRules[ruleIndex].properties = newProperties;
			}
		}
		
		addRule(selector, properties) {
			// Check if rule with this selector already exists
			const existingRuleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (existingRuleIndex !== -1) {
				// Merge with existing rule
				this.cssRules[existingRuleIndex].properties = properties;
			} else {
				// Add new rule
				this.cssRules.push({
					selector: selector,
					properties: properties
				});
			}
		}
		
		deleteRule(selector) {
			const ruleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (ruleIndex !== -1) {
				this.cssRules.splice(ruleIndex, 1);
			}
		}
		
		generateCss() {
			let cssText = '';
			
			this.cssRules.forEach(rule => {
				cssText += `${rule.selector} {\n`;
				
				// Format properties with each on new line and indented
				const formattedProperties = rule.properties
					.split(';')
					.map(prop => prop.trim())
					.filter(prop => prop) // Remove empty properties
					.map(prop => `    ${prop};`)
					.join('\n');
				
				cssText += `${formattedProperties}\n}\n\n`;
			});
			
			return cssText;
		}
	}

	// DOM Elements
	const welcomeCodeInput = document.getElementById('n2l-welcome-code-input');
	const welcomeLoadBtn = document.getElementById('n2l-welcome-load-btn');
	const useExampleBtn = document.getElementById('n2l-use-example-btn');
	const getCodeBtn = document.getElementById('n2l-get-code-btn');
	const previewIframe = document.getElementById('n2l-preview-iframe');
	const sidebar = document.getElementById('n2l-sidebar');
	const resizer = document.getElementById('n2l-resizer');
	const controlsPanel = document.getElementById('n2l-controls-panel');
	const elementInfo = document.getElementById('n2l-element-info');
	const actionToolbar = document.getElementById('n2l-action-toolbar');
	const selectorIndicator = document.getElementById('n2l-selector-indicator');
	const previewModeBtn = document.getElementById('n2l-preview-mode-btn');
	const previewModeIndicator = document.getElementById('n2l-preview-mode-indicator');
	const welcomePage = document.getElementById('n2l-welcome-page');
	const termsModal = document.getElementById('n2l-terms-modal');
	const termsLink = document.getElementById('n2l-terms-link');
	const closeButtons = document.querySelectorAll('.n2l-close');
	const promptGeneratorModal = document.getElementById('n2l-prompt-generator-modal');
	const openPromptGenBtn = document.getElementById('n2l-open-prompt-gen-btn');

	// Control Elements
	const elementClassInput = document.getElementById('n2l-element-class');
	const elementIdInput = document.getElementById('n2l-element-id');
	const applyClassIdBtn = document.getElementById('n2l-apply-class-id');
	const textEditControl = document.getElementById('n2l-text-edit-control');
	const textEditor = document.getElementById('n2l-text-editor');
	const applyTextChange = document.getElementById('n2l-apply-text-change');
	const imageSrcControl = document.getElementById('n2l-image-src-control');
	const imageSrcInput = document.getElementById('n2l-image-src-input');
	const applySrcChange = document.getElementById('n2l-apply-src-change');
	const cssRulesEditor = document.getElementById('n2l-css-rules-editor');
	const addCssRuleBtn = document.getElementById('n2l-add-css-rule-btn');
	const htmlControl = document.getElementById('n2l-html-control');
	const elementHtmlEditor = document.getElementById('n2l-element-html-editor');
	const applyHtmlChangesBtn = document.getElementById('n2l-apply-html-changes');

	// Action Toolbar Buttons
	const copyAboveBtn = document.getElementById('n2l-copy-above-btn');
	const copyBelowBtn = document.getElementById('n2l-copy-below-btn');
	const addCommentAboveBtn = document.getElementById('n2l-add-comment-above-btn');
	const addCommentBelowBtn = document.getElementById('n2l-add-comment-below-btn');
	const toggleStateBtn = document.getElementById('n2l-toggle-state-btn');
	const removeBtn = document.getElementById('n2l-remove-btn');

	// State Variables
	let iframeDoc = null;
	let iframeWin = null;
	let selectedElement = null;
	let isResizing = false;
	let originalJs = '';  // Store original JS content
	let previewModeActive = false; // Track preview mode state
	const cssManager = new Notes2LLMCssManager(); // Create CSS Manager

	// Example code for demonstration
	const exampleCode = `
<div class="example-container">
  <header class="example-header">
	<h1>My Example Page</h1>
	<nav>
	  <ul>
		<li><a href="#">Home</a></li>
		<li><a href="#">About</a></li>
		<li><a href="#">Contact</a></li>
	  </ul>
	</nav>
  </header>
  
  <main>
	<section class="hero">
	  <h2>Welcome to My Page</h2>
	  <p>This is a simple example to demonstrate Notes2LLM features.</p>
	  <button id="demo-btn">Click Me</button>
	</section>
	
	<section class="content">
	  <div class="card">
		<img src="https://via.placeholder.com/150" alt="Placeholder">
		<h3>Feature One</h3>
		<p>Description of feature one goes here.</p>
	  </div>
	  <div class="card">
		<img src="https://via.placeholder.com/150" alt="Placeholder">
		<h3>Feature Two</h3>
		<p>Description of feature two goes here.</p>
	  </div>
	</section>
  </main>
  
  <footer>
	<p>&copy; 2025 Example Page</p>
  </footer>
</div>

<style>
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  color: #333;
}

.example-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.example-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0;
  border-bottom: 1px solid #eee;
}

nav ul {
  display: flex;
  list-style: none;
  gap: 20px;
}

nav a {
  text-decoration: none;
  color: #384D68;
  font-weight: bold;
}

.hero {
  text-align: center;
  padding: 60px 0;
  background-color: #f5f7fa;
  margin: 20px 0;
}

.hero h2 {
  color: #384D68;
  margin-bottom: 15px;
}

#demo-btn {
  background-color: #384D68;
  color: white;
  border: none;
  padding: 10px 20px;
  margin-top: 20px;
  cursor: pointer;
}

.content {
  display: flex;
  gap: 30px;
  margin: 40px 0;
}

.card {
  flex: 1;
  border: 1px solid #eee;
  padding: 20px;
  text-align: center;
}

.card img {
  max-width: 100%;
  margin-bottom: 15px;
}

.card h3 {
  color: #384D68;
}

footer {
  text-align: center;
  padding: 20px 0;
  border-top: 1px solid #eee;
  margin-top: 40px;
}
</style>

<script>
  document.getElementById('demo-btn').addEventListener('click', function() {
	alert('Button clicked! This is a simple JavaScript demo.');
  });
<\/script>
`;

	// --- Initialization ---
	function init() {
		// Show welcome page on load
		welcomePage.style.display = 'block';
		
		// Add event listener for "Use example code" button
		useExampleBtn.addEventListener('click', function() {
			welcomeCodeInput.value = exampleCode.trim();
		});
		
		// Modal events
		welcomeLoadBtn.addEventListener('click', function() {
			if (welcomeCodeInput.value.trim() === '') {
				alert('Please paste some code first or use the example code.');
				return;
			}
			loadCodeIntoIframe();
			welcomePage.style.display = 'none';
		});
		
		termsLink.addEventListener('click', function(e) {
			e.preventDefault();
			termsModal.style.display = 'block';
		});
		
		closeButtons.forEach(button => {
			button.addEventListener('click', function() {
				this.closest('.n2l-modal').style.display = 'none';
			});
		});
		
		// Open prompt generator modal
		openPromptGenBtn.addEventListener('click', function() {
			promptGeneratorModal.style.display = 'block';
		});
		
		// Close modals when clicking outside
		window.addEventListener('click', function(e) {
			if (e.target === termsModal) {
				termsModal.style.display = 'none';
			}
			if (e.target === promptGeneratorModal) {
				promptGeneratorModal.style.display = 'none';
			}
		});
		
		getCodeBtn.addEventListener('click', showProcessedCode);
		resizer.addEventListener('mousedown', startResize);
		document.addEventListener('mousemove', resizeSidebar);
		document.addEventListener('mouseup', stopResize);
		previewModeBtn.addEventListener('click', togglePreviewMode);

		// Add listeners for sidebar control panel actions
		applyClassIdBtn.addEventListener('click', applyClassAndId);
		applyTextChange.addEventListener('click', applyText);
		applySrcChange.addEventListener('click', applyImageSource);
		applyHtmlChangesBtn.addEventListener('click', applyHtmlChanges);
		addCssRuleBtn.addEventListener('click', showAddCssRuleForm);

		// Add listeners for action toolbar buttons
		removeBtn.addEventListener('click', removeSelectedElement);
		copyAboveBtn.addEventListener('click', () => copyElement(true));
		copyBelowBtn.addEventListener('click', () => copyElement(false));
		addCommentAboveBtn.addEventListener('click', () => addComment(true));
		addCommentBelowBtn.addEventListener('click', () => addComment(false));
		toggleStateBtn.addEventListener('click', toggleElementState);

		// Hide toolbar if clicking outside the iframe
		document.addEventListener('click', (e) => {
			if (!previewIframe.contains(e.target) && !actionToolbar.contains(e.target) && selectedElement) {
				// Basic check; might need refinement if sidebar interaction should keep toolbar open
				// deselectElement(); // Option: deselect if clicking outside completely
			}
		});

		// Hide toolbar on main window scroll
		window.addEventListener('scroll', hideActionToolbar);
	}

	// --- Resizing Logic ---
	function startResize(e) {
		isResizing = true;
		document.body.style.userSelect = 'none';
		document.body.style.pointerEvents = 'none';
		previewIframe.style.pointerEvents = 'none';
		hideActionToolbar();
	}
	
	function resizeSidebar(e) {
		if (!isResizing) return;
		const sidebarWidth = e.clientX;
		const minWidth = parseInt(getComputedStyle(sidebar).minWidth, 10);
		const maxWidth = window.innerWidth * (parseInt(getComputedStyle(sidebar).maxWidth, 10) / 100);
		
		if (sidebarWidth > minWidth && sidebarWidth < maxWidth) {
			sidebar.style.width = `${sidebarWidth}px`;
		}
	}
	
	function stopResize(e) {
		if (isResizing) {
			isResizing = false;
			document.body.style.userSelect = '';
			document.body.style.pointerEvents = '';
			previewIframe.style.pointerEvents = '';
		}
	}

	// --- Code Loading & Iframe Setup ---
	function loadCodeIntoIframe() {
		const rawCode = welcomeCodeInput.value;
		selectedElement = null;
		hideControls();
		hideActionToolbar();
		originalJs = ''; // Reset stored JS content
		
		// Exit preview mode if active
		if (previewModeActive) {
			togglePreviewMode();
		}

		let htmlContent = rawCode;
		let extractedCss = '';
		let extractedJs = '';

		// Extract <style> blocks and store content
		const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
		htmlContent = htmlContent.replace(styleRegex, (match, css) => {
			extractedCss += css + '\n';
			return ''; // Remove from HTML source for initial render
		});

		// Extract <script> blocks (inline only) and store content
		const scriptRegex = /<script[^>]*>([\s\S]*?)<\/script>/gi;
		htmlContent = htmlContent.replace(scriptRegex, (match, js) => {
			if (!match.toLowerCase().includes('src=')) {
				extractedJs += js + '\n';
				return ''; // Remove inline script from HTML source for initial render
			}
			return match; // Keep external scripts in HTML part
		});
		originalJs = extractedJs.trim(); // Store the extracted JS

		// Parse CSS with our manager
		cssManager.parseCss(extractedCss.trim());

		// Prepare iframe content - NOT including the original JS directly
		const iframeContent = `
			<!DOCTYPE html>
			<html>
			<head>
				<meta charset="UTF-8">
				<title>Preview</title>
				<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
				<link rel="preconnect" href="https://fonts.googleapis.com">
				<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
				<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Open+Sans&display=swap" rel="stylesheet">
				<style>
					body { margin: 8px; padding: 0; font-family: 'Roboto', sans-serif; }
					.N2L_EDITOR_SELECTED { 
						outline: 2px dashed #384D68 !important; 
						box-shadow: 0 0 10px rgba(56, 77, 104, 0.5); 
						cursor: default; 
					}
					a { pointer-events: none; } /* Basic link prevention */
					
					/* Inject parsed CSS rules */
					${cssManager.generateCss()}
				</style>
				<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>
			</head>
			<body>
				${htmlContent.trim()}
			</body>
			</html>
		`;

		previewIframe.srcdoc = iframeContent;

		previewIframe.onload = () => {
			try {
				iframeWin = previewIframe.contentWindow;
				iframeDoc = previewIframe.contentDocument || iframeWin.document;

				if (!iframeDoc || !iframeDoc.body) {
					console.error("Could not access iframe document or body.");
					alert("Error: Could not initialize preview iframe.");
					return;
				}

				iframeDoc.body.addEventListener('click', handleIframeClick, true);

				const links = iframeDoc.getElementsByTagName('a');
				for (const link of links) {
					link.addEventListener('click', (event) => {
						event.preventDefault();
						console.log(`Link clicked but navigation prevented: ${link.href}`);
					});
					link.style.pointerEvents = 'auto';
				}

				// Add scroll listener to iframe window to reposition toolbar
				iframeWin.addEventListener('scroll', positionActionToolbar);

			} catch (e) {
				console.error("Error accessing iframe content:", e);
				alert("Error initializing iframe.");
			}
		};
	}

	 // --- Element Selection & Control/Toolbar Management ---
	 function handleIframeClick(event) {
		// If in preview mode, don't handle clicks for selection
		if (previewModeActive) return;
		
		event.preventDefault();
		event.stopPropagation();
		const clickedElement = event.target;

		if (clickedElement === iframeDoc.body || clickedElement === iframeDoc.documentElement) {
			deselectElement();
			return;
		}
		selectElement(clickedElement);
	 }

	 function selectElement(element) {
		 // Ignore selection in preview mode
		 if (previewModeActive) return;
		 
		 if (selectedElement === element) {
			 positionActionToolbar(); // Reposition even if same element clicked
			 return;
		 }

		 deselectElement();

		 selectedElement = element;
		 selectedElement.classList.add('N2L_EDITOR_SELECTED');

		 populateControls(selectedElement);
		 controlsPanel.style.display = 'block';
		 positionActionToolbar(); // Position and show toolbar
		 actionToolbar.style.display = 'block';
		 
		 // Show selector indicator
		 positionSelectorIndicator();
	 }

	 function deselectElement() {
		 if (selectedElement) {
			 selectedElement.classList.remove('N2L_EDITOR_SELECTED');
		 }
		 selectedElement = null;
		 hideControls();
		 hideActionToolbar();
		 selectorIndicator.style.display = 'none';
	 }

	 function hideControls() {
		 controlsPanel.style.display = 'none';
	 }

	 function hideActionToolbar() {
		actionToolbar.style.display = 'none';
		selectorIndicator.style.display = 'none';
	 }

	function positionActionToolbar() {
		if (!selectedElement || previewModeActive) {
			hideActionToolbar();
			return;
		}

		const iframeRect = previewIframe.getBoundingClientRect(); // iframe position in main viewport
		const elementRect = selectedElement.getBoundingClientRect(); // selected element position in iframe viewport

		// Calculate position relative to the main document viewport
		const toolbarHeight = actionToolbar.offsetHeight;
		const scrollY = window.scrollY; // Main window scroll
		const scrollX = window.scrollX;

		// Position above the element, slightly offset
		let top = iframeRect.top + elementRect.top - toolbarHeight - 5 + scrollY;
		let left = iframeRect.left + elementRect.left + scrollX;

		// Adjust if too close to the top of the main viewport
		if (top < scrollY + 5) {
			// Position below instead
			top = iframeRect.top + elementRect.bottom + 5 + scrollY;
		}

		// Basic adjustment if too far left/right
		left = Math.max(scrollX + 5, left); // Ensure not off-screen left
		left = Math.min(scrollX + window.innerWidth - actionToolbar.offsetWidth - 5, left); // Ensure not off-screen right

		actionToolbar.style.top = `${top}px`;
		actionToolbar.style.left = `${left}px`;
		actionToolbar.style.display = 'block'; // Ensure visible if called directly
		
		// Also update selector indicator position
		positionSelectorIndicator();
	}
	
	// Position the selector indicator
	function positionSelectorIndicator() {
		if (!selectedElement || previewModeActive) {
			selectorIndicator.style.display = 'none';
			return;
		}
		
		// Get info about selected element
		const tagName = selectedElement.tagName.toLowerCase();
		const id = selectedElement.id ? `#${selectedElement.id}` : '';
		const classes = selectedElement.classList.length > 0 ? 
			Array.from(selectedElement.classList)
				.filter(c => c !== 'N2L_EDITOR_SELECTED')
				.map(c => `.${c}`)
				.join('') : '';
				
		// Create selector string
		let selectorText = '';
		if (id) {
			selectorText = id;
		} else if (classes) {
			selectorText = `${tagName}${classes}`;
		} else {
			selectorText = tagName;
		}
		
		// Set the text
		selectorIndicator.textContent = selectorText;
		
		// Position above the toolbar
		const toolbarRect = actionToolbar.getBoundingClientRect();
		const indicatorHeight = 22; // Approximate height
		
		selectorIndicator.style.top = `${parseInt(actionToolbar.style.top) - indicatorHeight}px`;
		selectorIndicator.style.left = actionToolbar.style.left;
		selectorIndicator.style.display = 'block';
	}

	function populateControls(el) {
		// Set basic element info
		const tagName = el.tagName.toLowerCase();
		const id = el.id ? `#${el.id}` : '';
		const classes = el.classList.length > 0 ? 
			`.${Array.from(el.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
		elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;

		// Populate class/ID inputs
		elementClassInput.value = Array.from(el.classList)
			.filter(c => c !== 'N2L_EDITOR_SELECTED')
			.join(' ');
		elementIdInput.value = el.id || '';

		// Handle text editing for text-containing elements
		const textEditableTags = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'a', 'span', 'div', 'td', 'th', 'button', 'label'];
		if (textEditableTags.includes(tagName) || (el.hasChildNodes() && Array.from(el.childNodes).some(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== ''))) {
			let directText = Array.from(el.childNodes)
				.filter(node => node.nodeType === Node.TEXT_NODE)
				.map(node => node.textContent)
				.join('')
				.trim();
			if (!directText && el.innerText && !el.children.length) { 
				directText = el.innerText.trim(); 
			}
			else if (!directText && tagName === 'textarea') { 
				directText = el.value; 
			}
			textEditor.value = directText;
			textEditControl.style.display = 'block';
            imageSrcControl.style.display = 'none';
		} else if (tagName === 'img') {
			// Handle image source editing - show this instead of text control
			imageSrcInput.value = el.src || '';
			imageSrcControl.style.display = 'block';
            textEditControl.style.display = 'none';
		} else {
			textEditControl.style.display = 'none';
            imageSrcControl.style.display = 'none';
		}

		// Populate CSS rules that match this element
		populateCssRules(el);

		// Create a clean version of the HTML without the N2L_EDITOR_SELECTED class
		const tempEl = el.cloneNode(true);
		tempEl.classList.remove('N2L_EDITOR_SELECTED');
		// If no classes left, remove the class attribute entirely
		if (tempEl.classList.length === 0) {
			tempEl.removeAttribute('class');
		}
		let cleanHtml = tempEl.outerHTML;
		
		// Additional regex cleaning for any remaining instances
		cleanHtml = cleanHtml.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ');
		cleanHtml = cleanHtml.replace(/class="\s*"/g, '');
		cleanHtml = cleanHtml.replace(/class='\s*'/g, '');
		cleanHtml = cleanHtml.replace(/\s+class=""/g, '');
		cleanHtml = cleanHtml.replace(/\s+class=''/g, '');

		// Set HTML editor with element's clean HTML
		elementHtmlEditor.value = cleanHtml;
		htmlControl.style.display = 'block';
	}

	function applyHtmlChanges() {
		if (!selectedElement) return;
		
		const parentNode = selectedElement.parentNode;
		if (!parentNode) return;
		
		// Get the HTML from the editor and clean it further to ensure no editor classes remain
		let cleanHtml = elementHtmlEditor.value.trim();
		cleanHtml = cleanHtml.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ');
		cleanHtml = cleanHtml.replace(/class="\s*"/g, '');
		cleanHtml = cleanHtml.replace(/class='\s*'/g, '');
		cleanHtml = cleanHtml.replace(/\s+class=""/g, '');
		cleanHtml = cleanHtml.replace(/\s+class=''/g, '');
		
		// Create a temporary container
		const temp = iframeDoc.createElement('div');
		temp.innerHTML = cleanHtml;
		
		// Replace the selected element with the new content
		if (temp.firstChild) {
			// Store reference to current element to deselect it
			const oldElement = selectedElement;
			
			// Replace the element in the DOM
			parentNode.replaceChild(temp.firstChild, selectedElement);
			
			// Select the new element
			selectElement(temp.firstChild);
		} else {
			console.error('Invalid HTML: No element created');
			alert('The HTML is invalid or empty.');
		}
	}

	// --- Toggle Element State ---
	function toggleElementState() {
		if (!selectedElement) return;
		
		// Store current selection
		const currentElement = selectedElement;
		
		// Temporarily remove click capturing to allow the click to go through
		iframeDoc.body.removeEventListener('click', handleIframeClick, true);
		
		// Create and dispatch a click event on the element
		const clickEvent = new MouseEvent('click', {
			bubbles: true,
			cancelable: true,
			view: iframeWin
		});
		
		// Dispatch the click event to toggle state
		currentElement.dispatchEvent(clickEvent);
		
		// Restore click capturing after a brief delay to allow event to process
		setTimeout(() => {
			if (!previewModeActive) { // Only restore if not in preview mode
				iframeDoc.body.addEventListener('click', handleIframeClick, true);
				// Keep the element selected
				selectElement(currentElement);
			}
		}, 100);
	}

	// --- Preview Mode Toggle ---
	function togglePreviewMode() {
		previewModeActive = !previewModeActive;
		
		if (previewModeActive) {
			// Disable editor functionality
			iframeDoc.body.removeEventListener('click', handleIframeClick, true);
			deselectElement();
			
			// Enable normal link behavior
			const links = iframeDoc.getElementsByTagName('a');
			for (const link of links) {
				link.style.pointerEvents = 'auto';
				// Remove the click event listeners that prevent navigation
				const clone = link.cloneNode(true);
				link.parentNode.replaceChild(clone, link);
			}
			
			// Execute user JavaScript in preview mode
			if (originalJs && originalJs.trim() !== '') {
				try {
					// Create a temporary script element to execute the JavaScript
					const scriptElement = iframeDoc.createElement('script');
					scriptElement.textContent = originalJs;
					iframeDoc.body.appendChild(scriptElement);
					
					// Clean up - if needed later, currently keeping for preview functionality
					iframeDoc.n2lTempScript = scriptElement;
				} catch (error) {
					console.error("Error executing user JavaScript in preview mode:", error);
				}
			}
			
			// Update UI to show preview mode is active
			previewModeBtn.textContent = 'Exit Preview Mode';
			previewModeBtn.classList.add('preview-active');
			previewIframe.classList.add('preview-mode-frame');
			previewModeIndicator.style.display = 'block';
		} else {
			// Re-enable editor functionality
			iframeDoc.body.addEventListener('click', handleIframeClick, true);
			
			// Disable normal link behavior again
			const links = iframeDoc.getElementsByTagName('a');
			for (const link of links) {
				link.addEventListener('click', (event) => {
					event.preventDefault();
					console.log(`Link clicked but navigation prevented: ${link.href}`);
				});
				link.style.pointerEvents = 'auto';
			}
			
			// Update UI to show editor mode is active
			previewModeBtn.textContent = 'Enter Preview Mode';
			previewModeBtn.classList.remove('preview-active');
			previewIframe.classList.remove('preview-mode-frame');
			previewModeIndicator.style.display = 'none';
			
			// Remove any injected scripts
			if (iframeDoc.n2lTempScript && iframeDoc.n2lTempScript.parentNode) {
				iframeDoc.n2lTempScript.parentNode.removeChild(iframeDoc.n2lTempScript);
			}
		}
	}

	// --- CSS Rule Handling ---
	function populateCssRules(element) {
		// Clear previous rules
		cssRulesEditor.innerHTML = '';
		
		// Get matching CSS rules
		const matchingRules = cssManager.getMatchingRules(element);
		
		if (matchingRules.length === 0) {
			// Instead of just showing "No rules", we now show that message
			// but still allow the user to add rules
			cssRulesEditor.innerHTML = '<div class="n2l-no-rules-message">No CSS rules found for this element.</div>';
			
			// The "Add CSS Rule" button is now displayed outside this function,
			// always visible in the CSS control group
		} else {
			// Create rule editor for each matching rule
			matchingRules.forEach(rule => {
				const ruleDiv = document.createElement('div');
				ruleDiv.className = 'n2l-css-rule-item';
				
				const selectorDiv = document.createElement('div');
				selectorDiv.className = 'n2l-css-selector';
				selectorDiv.textContent = rule.selector;
				
				const propertiesTextarea = document.createElement('textarea');
				propertiesTextarea.className = 'n2l-css-properties';
				propertiesTextarea.value = rule.properties;
				
				const actionsDiv = document.createElement('div');
				actionsDiv.className = 'n2l-rule-actions';
				
				const updateButton = document.createElement('button');
				updateButton.textContent = 'Update';
				updateButton.className = 'n2l-update-rule-btn';
				updateButton.addEventListener('click', () => {
					cssManager.updateRule(rule.selector, propertiesTextarea.value);
					refreshIframeStyles();
				});
				
				actionsDiv.appendChild(updateButton);
				
				ruleDiv.appendChild(selectorDiv);
				ruleDiv.appendChild(propertiesTextarea);
				ruleDiv.appendChild(actionsDiv);
				
				cssRulesEditor.appendChild(ruleDiv);
			});
		}
	}
	
	// Function to show the improved "Add CSS Rule" form with apply-to-element option
	function showAddCssRuleForm() {
		if (!selectedElement) return;
		
		// Check if form already exists
		if (document.getElementById('n2l-new-rule-form')) {
			return; // Form already shown
		}
		
		// Create a new rule form
		const formDiv = document.createElement('div');
		formDiv.id = 'n2l-new-rule-form';
		formDiv.className = 'n2l-new-rule-form';
		
		// Generate default selector suggestion based on element
		let selectorSuggestion = '';
		let suggestedId = '';
		let suggestedClass = '';
		
		// If element has ID, suggest that first
		if (selectedElement.id) {
			selectorSuggestion = `#${selectedElement.id}`;
			suggestedId = selectedElement.id;
		} 
		// If element has classes, suggest the first class
		else if (selectedElement.classList.length > 0) {
			const classes = Array.from(selectedElement.classList)
				.filter(c => c !== 'N2L_EDITOR_SELECTED');
			if (classes.length > 0) {
				selectorSuggestion = `.${classes[0]}`;
				suggestedClass = classes[0];
			}
		}
		// Otherwise, suggest a new class based on the tag
		else {
			const tagName = selectedElement.tagName.toLowerCase();
			suggestedClass = `${tagName}-custom`;
			selectorSuggestion = `.${suggestedClass}`;
		}
		
		// Build the form HTML with apply-to-element option
		formDiv.innerHTML = `
			<label for="n2l-new-rule-selector">CSS Selector:</label>
			<input type="text" id="n2l-new-rule-selector" value="${selectorSuggestion}" placeholder="e.g., .my-class, #my-id, div">
			
			<label for="n2l-new-rule-properties">CSS Properties:</label>
			<textarea id="n2l-new-rule-properties" placeholder="color: red;\nfont-size: 16px;\nmargin: 10px;"></textarea>
			
			<div class="n2l-slider-container">
				<label class="n2l-slider">
					<input type="checkbox" id="n2l-apply-selector-toggle" ${!suggestedId && suggestedClass ? 'checked' : ''}>
					<span class="n2l-slider-switch"></span>
				</label>
				<span class="n2l-slider-label">Apply this selector to element</span>
			</div>
			
			<div class="n2l-rule-actions">
				<button id="n2l-cancel-new-rule-btn">Cancel</button>
				<button id="n2l-add-new-rule-btn">Add Rule</button>
			</div>
		`;
		
		// Add the form to the CSS rules editor
		cssRulesEditor.appendChild(formDiv);
		
		// Add event listeners for the form buttons
		document.getElementById('n2l-add-new-rule-btn').addEventListener('click', addNewCssRule);
		document.getElementById('n2l-cancel-new-rule-btn').addEventListener('click', () => {
			formDiv.remove();
		});
		
		// Focus the properties textarea
		document.getElementById('n2l-new-rule-properties').focus();
	}
	
	// Function to add a new CSS rule
	function addNewCssRule() {
		const selector = document.getElementById('n2l-new-rule-selector').value.trim();
		const properties = document.getElementById('n2l-new-rule-properties').value.trim();
		const applyToElement = document.getElementById('n2l-apply-selector-toggle').checked;
		
		if (!selector || !properties) {
			alert('Please enter both a selector and properties for the new CSS rule.');
			return;
		}
		
		// Add the rule to the CSS manager
		cssManager.addRule(selector, properties);
		
		// If "Apply to element" is checked, add the selector to the element
		if (applyToElement && selectedElement) {
			// Parse the selector to determine if it's a class or ID
			if (selector.startsWith('.')) {
				// It's a class selector
				const className = selector.substring(1);
				if (!selectedElement.classList.contains(className)) {
					selectedElement.classList.add(className);
					
					// Update class input field
					const currentClasses = elementClassInput.value.trim();
					elementClassInput.value = currentClasses ? 
						`${currentClasses} ${className}` : className;
				}
			} else if (selector.startsWith('#')) {
				// It's an ID selector
				const idName = selector.substring(1);
				selectedElement.id = idName;
				
				// Update ID input field
				elementIdInput.value = idName;
			}
			
			// Update element info display
			updateElementInfo();
		}
		
		// Refresh styles in the iframe
		refreshIframeStyles();
		
		// Remove the form
		document.getElementById('n2l-new-rule-form').remove();
		
		// Re-populate the rules display
		if (selectedElement) {
			populateCssRules(selectedElement);
			
			// Update selector indicator
			positionSelectorIndicator();
		}
	}
	
	function refreshIframeStyles() {
		if (!iframeDoc) return;
		
		// Update <style> tag in iframe
		const styleTag = iframeDoc.querySelector('style');
		if (styleTag) {
			// Preserve the editor styles at the beginning
			const editorStyles = `
				body { margin: 8px; padding: 0; font-family: 'Roboto', sans-serif; }
				.N2L_EDITOR_SELECTED { 
					outline: 2px dashed #384D68 !important; 
					box-shadow: 0 0 10px rgba(56, 77, 104, 0.5); 
					cursor: default; 
				}
				a { pointer-events: none; } /* Basic link prevention */
			`;
			
			styleTag.textContent = editorStyles + cssManager.generateCss();
		}
		
		// Re-populate controls to show updated rules
		if (selectedElement) {
			populateCssRules(selectedElement);
		}
	}

	// --- Update element info display ---
	function updateElementInfo() {
		if (!selectedElement) return;
		
		const tagName = selectedElement.tagName.toLowerCase();
		const id = selectedElement.id ? `#${selectedElement.id}` : '';
		const classes = selectedElement.classList.length > 0 ? 
			`.${Array.from(selectedElement.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
		elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;
	}

	// --- Control Actions ---
	function applyClassAndId() {
		if (!selectedElement) return;
		
		// Update classes
		const newClasses = elementClassInput.value.trim().split(/\s+/).filter(Boolean);
		
		// Remove all existing classes except editor class
		Array.from(selectedElement.classList)
			.filter(cls => cls !== 'N2L_EDITOR_SELECTED')
			.forEach(cls => selectedElement.classList.remove(cls));
		
		// Add new classes
		newClasses.forEach(cls => selectedElement.classList.add(cls));
		
		// Update ID
		selectedElement.id = elementIdInput.value.trim();
		
		// Update element info display
		updateElementInfo();
		
		// Update CSS rules display since classes/IDs changed
		populateCssRules(selectedElement);
		
		// Update selector indicator
		positionSelectorIndicator();
	}
	
	function applyText() {
		if (!selectedElement) return;
		
		const tagName = selectedElement.tagName.toLowerCase();
		if (tagName === 'textarea') {
			selectedElement.value = textEditor.value;
		} else {
			let foundTextNode = false;
			Array.from(selectedElement.childNodes).forEach(node => {
				if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') {
					node.textContent = textEditor.value;
					foundTextNode = true;
				}
			});
			
			if (!foundTextNode || selectedElement.childNodes.length === 0) {
				selectedElement.textContent = textEditor.value;
			}
		}
	}
	
	function applyImageSource() {
		if (!selectedElement || selectedElement.tagName.toLowerCase() !== 'img') return;
		selectedElement.src = imageSrcInput.value;
	}
	

	// --- Toolbar Actions ---
	function removeSelectedElement() {
		if (!selectedElement) return;
		const elementToRemove = selectedElement; // Keep reference
		deselectElement(); // Deselect first to hide toolbar etc.
		elementToRemove.remove();
	}

	function copyElement(above) {
		if (!selectedElement) return;
		const clone = selectedElement.cloneNode(true);
		clone.classList.remove('N2L_EDITOR_SELECTED');
		
		if (above) {
			selectedElement.parentNode.insertBefore(clone, selectedElement);
		} else {
			selectedElement.parentNode.insertBefore(clone, selectedElement.nextSibling);
		}
	}

	function addComment(above) {
		if (!selectedElement) return;
		const commentText = prompt("Enter comment text for the LLM:", "TODO: Refine this section");
		if (commentText === null || commentText.trim() === "") return;

		const commentNode = iframeDoc.createComment(` N2L_COMMENT: ${commentText.trim()} `);

		if (above) {
			selectedElement.parentNode.insertBefore(commentNode, selectedElement);
		} else {
			selectedElement.parentNode.insertBefore(commentNode, selectedElement.nextSibling);
		}
	}

	// --- Get Processed Code ---
	function showProcessedCode() {
		if (!iframeDoc || !iframeDoc.body) {
			alert("Please load some code first.");
			return;
		}

		try {
			// 1. Get Modified HTML from iframe
			const bodyClone = iframeDoc.body.cloneNode(true);
				
			// Remove all instances of N2L_EDITOR_SELECTED class from clone
			const selectedElements = bodyClone.querySelectorAll('.N2L_EDITOR_SELECTED');
			selectedElements.forEach(el => {
				el.classList.remove('N2L_EDITOR_SELECTED');
				// If element has no classes left, remove the class attribute entirely
				if (el.classList.length === 0) {
					el.removeAttribute('class');
				}
			});
				
			// Process the HTML to remove any internal attributes we may have added
			let processedHTML = bodyClone.innerHTML.trim();
			
			// Remove any script tags that might have been injected during preview mode
			processedHTML = processedHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
			
			// Additional cleaning: use regex to ensure all instances of the class are removed from the HTML string
			processedHTML = processedHTML.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ');
			processedHTML = processedHTML.replace(/class="\s*"/g, '');
			processedHTML = processedHTML.replace(/class='\s*'/g, '');
			
			// Clean up any trailing spaces in class attributes
			processedHTML = processedHTML.replace(/class="\s+/g, 'class="');
			processedHTML = processedHTML.replace(/class='\s+/g, "class='");
			
			// Remove empty class attributes
			processedHTML = processedHTML.replace(/\s+class=""/g, '');
			processedHTML = processedHTML.replace(/\s+class=''/g, '');

			// 2. Generate processed CSS
			const processedCSS = cssManager.generateCss();

			// 3. Combine processed HTML with CSS and JS
			let finalCode = processedHTML; // Start with the modified HTML

			if (processedCSS) {
				finalCode += `\n\n<style>\n${processedCSS}</style>`;
			}

			if (originalJs) {
				finalCode += `\n\n<script>\n${originalJs}\n<\/script>`;
			}

			// Display the result
			const outputArea = document.createElement('textarea');
			outputArea.style.width = '90%';
			outputArea.style.height = '400px';
			outputArea.style.fontFamily = 'monospace';
			outputArea.value = finalCode;
			outputArea.id = "processed-code-textarea";

			const dialog = document.createElement('div');
			dialog.style.position = 'fixed';
			dialog.style.top = '50px';
			dialog.style.left = '50%';
			dialog.style.transform = 'translateX(-50%)';
			dialog.style.backgroundColor = 'white';
			dialog.style.padding = '20px';
			dialog.style.border = '1px solid black';
			dialog.style.zIndex = '1001';
			dialog.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
			dialog.innerHTML = '<h3>Processed Code (Modified HTML + CSS/JS):</h3>';
			dialog.appendChild(outputArea);
			
			// Add buttons container for better layout
			const buttonContainer = document.createElement('div');
			buttonContainer.style.display = 'flex';
			buttonContainer.style.marginTop = '10px';
			
			// Add copy button
			const copyBtn = document.createElement('button');
			copyBtn.textContent = 'Copy to Clipboard';
			copyBtn.className = 'modal-button';
			copyBtn.onclick = () => {
				const textarea = document.getElementById('processed-code-textarea');
				textarea.select();
				document.execCommand('copy');
				copyBtn.textContent = 'Copied!';
				setTimeout(() => {
					copyBtn.textContent = 'Copy to Clipboard';
				}, 2000);
			};
			buttonContainer.appendChild(copyBtn);
			
			// Close button
			const closeBtn = document.createElement('button');
			closeBtn.textContent = 'Close';
			closeBtn.className = 'modal-button';
			closeBtn.onclick = () => document.body.removeChild(dialog);
			buttonContainer.appendChild(closeBtn);
			
			dialog.appendChild(buttonContainer);

			// Close dialog if already open
			const existingDialog = document.querySelector('.n2l-output-dialog');
			if (existingDialog) {
				document.body.removeChild(existingDialog);
			}
			dialog.classList.add('n2l-output-dialog');

			document.body.appendChild(dialog);

		} catch (e) {
			console.error("Error generating processed code:", e);
			alert("An error occurred while trying to generate the processed code.");
		}
	}

	// --- Start the app ---
	init();
</script>
</body>
</html>