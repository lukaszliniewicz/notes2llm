<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JJR4734MHM"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JJR4734MHM');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code</title>
<!-- SEO Elements -->
<meta name="description" content="Notes2LLM: A free tool for post-processing HTML, CSS, and JavaScript generated in a chat interface with AI. Edit text, change image sources, add comments for LLMs and refine code.">
<meta name="keywords" content="notes2llm, ai coding, html editor, css editor, javascript editor, llm, large language model, code refining, web development, ai assistant, code editing">
<meta name="author" content="Luke Liniewicz">
<meta property="og:title" content="Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code">
<meta property="og:description" content="Edit and refine code generated by AI language models with this free, browser-based tool. Add comments, modify elements, and send back for further refinement.">
<meta property="og:image" content="https://notes2llm.liniewicz.info/logo.png">
<meta property="og:url" content="https://notes2llm.liniewicz.info">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Notes2LLM - HTML/CSS/JS Editor for LLM-Generated Code">
<meta name="twitter:description" content="Edit and refine code generated by AI language models with this free, browser-based tool.">
<meta name="twitter:image" content="https://notes2llm.liniewicz.info/logo.png">
<link rel="canonical" href="https://notes2llm.liniewicz.info">
<style>
/* Basic Reset & Body Styling */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { 
    height: 100%; 
    overflow: hidden; 
    font-family: 'Roboto', sans-serif; 
    color: #384D68;
}

/* App Layout */
.n2l-app-container {
    display: flex;
    height: 100vh;
}

/* Sidebar */
.n2l-sidebar {
    width: 350px;
    min-width: 250px;
    max-width: 60%;
    background-color: #f0f0f0;
    border-right: 1px solid #ccc;
    padding: 15px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

/* Sidebar Header with Logo */
.n2l-sidebar-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.n2l-sidebar-logo {
    height: 24px;
    margin-right: 10px;
}

/* Resizer Handle */
.n2l-resizer {
    width: 5px;
    background-color: #ccc;
    cursor: ew-resize;
    height: 100%;
}
.n2l-resizer:hover {
    background-color: #aaa;
}

/* Preview Pane */
.n2l-preview-pane {
    flex-grow: 1;
    height: 100%;
    background-color: #fff;
    position: relative; /* Needed for icon container positioning */
}

#n2l-preview-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background-color: #fff;
}

/* Controls Styling (Sidebar) */
.n2l-sidebar h3 {
    margin-top: 9px;
    margin-bottom: 5px;
    padding-bottom: 3px;
    color: #384D68;
    font-weight: 300;
}
.n2l-sidebar label {
    display: block;
    margin-top: 10px;
    font-size: 0.9em;
    font-weight: bold;
    color: #384D68;
}
.n2l-sidebar input[type="text"],
.n2l-sidebar input[type="color"],
.n2l-sidebar input[type="number"],
.n2l-sidebar textarea {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border: 1px solid #ccc;
    border-radius: 0;
    font-size: 0.9em;
    font-family: 'Roboto', sans-serif;
}

.n2l-sidebar textarea {
    min-height: 80px;
    resize: vertical;
    font-family: monospace;
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border: 1px solid #ccc;
    border-radius: 0;
    font-size: 0.9em;
}
.n2l-sidebar button {
    background-color: white;
    color: #384D68;
    border: 1px solid #384D68;
    border-radius: 0;
    padding: 8px 12px;
    margin-top: 10px;
    margin-right: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-family: 'Roboto', sans-serif;
}
.n2l-sidebar button:hover {
    background-color: #f0f0f0;
}
.n2l-sidebar button.secondary {
    background-color: white;
}
.n2l-sidebar button.secondary:hover {
    background-color: #f0f0f0;
}

.n2l-sidebar button.preview-active {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}
.n2l-sidebar button.preview-active:hover {
    background-color: #218838;
}

#n2l-controls-panel {
    margin-top: 20px;
    border-top: 2px solid #ccc;
    padding-top: 15px;
}
#n2l-element-info {
    font-size: 0.8em;
    color: #384D68;
    margin-bottom: 10px;
    word-wrap: break-word;
}
.n2l-control-group {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #e9e9e9;
    border-radius: 0;
    border: 1px solid #ddd;
}
.n2l-inline-controls label {
    display: inline-block;
    margin-right: 5px;
    width: auto;
}
.n2l-inline-controls input {
    width: 60px;
    margin-right: 10px;
}
.n2l-inline-controls input[type="color"] {
    width: 40px;
    padding: 2px;
    vertical-align: middle;
}

/* Action Toolbar (Floating) */
#n2l-action-toolbar {
    position: absolute;
    display: none;
    background-color: rgba(0, 0, 0, 0.85);
    padding: 5px 8px;
    border-radius: 0;
    border: 1px solid #ccc;
    z-index: 1000;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    white-space: nowrap;
}

/* Selector indicator above the toolbar */
#n2l-selector-indicator {
    position: absolute;
    display: none;
    background-color: rgba(56, 77, 104, 0.9);
    color: white;
    padding: 3px 6px;
    font-size: 0.8em;
    border-radius: 0;
    z-index: 1001;
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

#n2l-action-toolbar button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px 6px;
    font-size: 1.1em;
    margin: 0 3px;
    vertical-align: middle;
    transition: color 0.2s ease;
}
#n2l-action-toolbar button:hover {
    color: #384D68; /* This was a typo, should be a lighter color like #ddd or #fff */
}
#n2l-action-toolbar button:hover {
    color: #cce5ff; /* Light blue hover, or another contrasting color */
}
#n2l-action-toolbar button.danger:hover {
    color: #ff4d4d;
}

/* Style for selected element in iframe */
.N2L_EDITOR_SELECTED {
    outline: 2px dashed #384D68 !important;
    box-shadow: 0 0 10px rgba(56, 77, 104, 0.5);
}

/* CSS Rules Editor */
#n2l-css-rules-editor {
    max-height: 300px;
    overflow-y: auto;
}

/* Integrated class/ID and CSS management section */
.n2l-selector-manager {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 0;
}

.n2l-selector-inputs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.n2l-selector-inputs > div {
    flex: 1;
    min-width: 100px;
}

.n2l-selector-manager h4 {
    margin-bottom: 8px;
    color: #384D68;
}

.n2l-css-rule-item {
    margin-bottom: 10px;
    padding: 8px;
    background-color: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 0;
}

.n2l-css-selector {
    font-weight: bold;
    color: #384D68;
    margin-bottom: 4px;
}

.n2l-css-properties {
    width: 100%;
    font-family: monospace;
    height: 60px;
    margin-bottom: 5px;
}

.n2l-rule-actions {
    display: flex;
    justify-content: flex-end;
}

.n2l-rule-actions button {
    padding: 3px 8px;
    font-size: 0.8em;
    margin-left: 5px;
}

/* Checkbox slider for "Apply to element" */
.n2l-slider-container {
    display: flex;
    align-items: center;
    margin-top: 8px;
	display:none;
}

.n2l-slider {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
    margin-right: 8px;
}

.n2l-slider input {
    opacity: 0;
    width: 0;
    height: 0;
}

.n2l-slider-switch {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 20px;
}

.n2l-slider-switch:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .n2l-slider-switch {
    background-color: #384D68;
}

input:checked + .n2l-slider-switch:before {
    transform: translateX(20px);
}

.n2l-slider-label {
    font-size: 0.8em;
    color: #555;
}

/* Modal buttons */
.modal-button {
    background-color: white;
    color: #384D68;
    border: 1px solid #384D68;
    border-radius: 0;
    padding: 5px 10px;
    margin-top: 10px;
    margin-right: 10px;
    cursor: pointer;
}
.modal-button:hover {
    background-color: #f0f0f0;
}

/* Preview mode indicator */
.preview-mode-frame {
    border: 3px solid #28a745 !important;
}

/* Preview mode notification */
#n2l-preview-mode-indicator {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background-color: rgba(40, 167, 69, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
    z-index: 1000;
    display: none;
}

/* Terms Modal Styles */
.n2l-modal {
    display: none; 
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.n2l-modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 25px;
    border: 1px solid #888;
    width: 75%;
    max-width: 800px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    border-radius: 0;
}

.n2l-modal-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 15px;
}

.n2l-logo {
    height: 60px;
    margin-right: 20px;
}

.n2l-modal-header h2 {
    color: #384D68;
    margin: 0;
    font-size: 28px;
    font-weight: 400;
}

.n2l-modal-body {
    margin-bottom: 25px;
}

.n2l-modal-body p {
    line-height: 1.6;
    margin-bottom: 20px;
    color: #384D68;
}

.n2l-modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    font-size: 14px;
    color: #666;
}

.n2l-close {
    position: absolute;
    top: 15px;
    right: 20px;
    color: #999;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.n2l-close:hover {
    color: #555;
}

/* Welcome Page Styles - COMPLETELY REDESIGNED */
.n2l-welcome-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 2000;
    overflow-y: auto;
}

.n2l-welcome-container {
    width: 100%;
    height: 100%;
    max-width: 1800px;
    margin: 0 auto;
    background-color: white;
}

.n2l-welcome-content-wrapper {
    display: flex;
    height: 100%;
    overflow-y: auto;
}

.n2l-welcome-left {
    flex: 2;
    padding: 40px;
    background-color: white;
    border-right: 1px solid #ddd;
}

.n2l-welcome-right {
    flex: 1;
    padding: 40px;
    background-color: #f5f5f5;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
}

/* Welcome header */
.n2l-welcome-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 40px;
}

.n2l-welcome-logo {
    width: 150px;
    height: auto;
    margin-right: 30px;
}

.n2l-title-container {
    flex: 1;
}

.n2l-welcome-left h1 {
    font-size: 48px;
    color: #384D68;
    font-weight: 300;
    margin: 0 0 10px 0;
    line-height: 1.1;
}

.n2l-subtitle {
    font-size: 18px;
    color: #666;
    margin-bottom: 20px;
}

/* External links */
.n2l-external-links {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.n2l-external-links a {
    color: #384D68;
    text-decoration: none;
    font-size: 14px;
    display: flex;
    align-items: center;
    border: 1px solid #384D68;
    padding: 6px 12px;
    transition: all 0.2s ease;
}

.n2l-external-links a:hover {
    background-color: #384D68;
    color: white;
}

.n2l-external-links a i {
    margin-right: 6px;
}

/* Tab system */
.n2l-tabs {
    margin-top: 40px;
}

.n2l-tab-buttons {
    display: flex;
    border-bottom: 2px solid #ddd;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.n2l-tab-button {
    padding: 12px 20px;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
}

.n2l-tab-button:hover {
    color: #384D68;
    background-color: #f5f5f5;
}

.n2l-tab-button.active {
    color: #384D68;
    font-weight: 500;
    border-bottom-color: #384D68;
    background-color: transparent;
}

.n2l-tab-panel {
    display: none;
}

.n2l-tab-panel.active {
    display: block;
}

/* Content sections */
.n2l-section {
    margin-bottom: 40px;
}

.n2l-section h2 {
    color: #384D68;
    font-size: 28px;
    font-weight: 400;
    margin-bottom: 20px;
}

.n2l-section p {
    line-height: 1.6;
    margin-bottom: 15px;
    color: #444;
    font-size: 16px;
}

/* Component cards - now more compact and placed after first paragraph */
.n2l-components {
    margin: 25px 0;
}

.n2l-component-cards {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
}

.n2l-component-card {
    flex: 1;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 20px;
    display: flex;
    align-items: flex-start;
    gap: 15px;
}

.n2l-component-card i {
    font-size: 24px;
    color: #384D68;
    flex-shrink: 0;
    margin-top: 3px;
}

.n2l-component-card div {
    flex: 1;
}

.n2l-component-card h3 {
    color: #384D68;
    font-size: 18px;
    margin-bottom: 5px;
}

.n2l-component-card p {
    color: #666;
    font-size: 14px;
    margin: 0;
    line-height: 1.4;
}

/* Compact cards for lists */
.n2l-compact-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    margin: 20px 0;
}

.n2l-compact-card {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 15px;
    color: #444;
}

.n2l-compact-card i {
    color: #28a745;
    font-size: 14px;
    flex-shrink: 0;
}

.n2l-compact-cards.negative .n2l-compact-card i {
    color: #dc3545;
}

/* Simplified workflow visualization */
.n2l-workflow-container {
    position: relative;
    margin: 40px 0;
    padding: 0 20px;
}

.n2l-workflow-step {
    position: relative;
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 25px;
    margin-bottom: 30px;
    margin-left: 40px;
}

.n2l-workflow-step:before {
    content: '';
    position: absolute;
    left: -20px;
    top: 50%;
    width: 2px;
    height: calc(100% + 32px);
    background-color: #384D68;
    transform: translateY(-50%);
}

.n2l-workflow-step:last-child:before {
    display: none;
}

.n2l-workflow-step.final {
    background-color: #e8f5e9;
    border-color: #4caf50;
	display:none;
}

.n2l-step-number {
    position: absolute;
    left: -40px;
    top: 50%;
    transform: translateY(-50%);
    background-color: #384D68;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
}

.n2l-step-content h3 {
    color: #384D68;
    font-size: 20px;
    margin-bottom: 8px;
}

.n2l-step-content p {
    color: #666;
    font-size: 15px;
    margin: 0;
}

.n2l-cycle-indicator {
    position: absolute;
    right: 20px;
    top: 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
    background-color: #fff3e0;
    padding: 5px 10px;
    border: 1px solid #ffecb5;
}

.n2l-cycle-indicator i {
    color: #ff9800;
}

/* Method sections */
.n2l-method-section {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 25px;
    margin-bottom: 20px;
}

.n2l-method-section h3 {
    color: #384D68;
    font-size: 20px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.n2l-method-section h3 i {
    margin-right: 10px;
    font-size: 18px;
}

.n2l-numbered-list {
    padding-left: 25px;
    margin: 15px 0;
}

.n2l-numbered-list li {
    margin-bottom: 10px;
    color: #444;
    font-size: 15px;
    line-height: 1.5;
}

/* Email clients grid */
.n2l-email-clients {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.n2l-email-client {
    background-color: white;
    border: 1px solid #e0e0e0;
    padding: 15px;
}

.n2l-email-client h4 {
    color: #384D68;
    font-size: 16px;
    margin-bottom: 8px;
}

.n2l-email-client p {
    color: #666;
    font-size: 14px;
    margin: 0;
}

/* LLM cards */
.n2l-llm-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.n2l-llm-card {
    background-color: #f9f9f9;
    border: 1px solid #e0e0e0;
    padding: 25px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.n2l-llm-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.n2l-llm-card h3 {
    color: #384D68;
    font-size: 20px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
}

.n2l-llm-card h3 i {
    margin-right: 10px;
}

.n2l-llm-cost {
    color: #666;
    font-size: 14px;
    font-style: italic;
    margin-bottom: 10px;
}

.n2l-llm-card p {
    color: #444;
    font-size: 14px;
    margin: 0;
}

/* Tips and warnings */
.n2l-tip,
.n2l-warning {
    padding: 15px 20px;
    margin: 20px 0;
    display: flex;
    align-items: flex-start;
}

.n2l-tip {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.n2l-warning {
    background-color: #fff3e0;
    border-left: 4px solid #ff9800;
}

.n2l-tip i,
.n2l-warning i {
    margin-right: 12px;
    font-size: 18px;
    margin-top: 2px;
}

.n2l-tip i {
    color: #2196f3;
}

.n2l-warning i {
    color: #ff9800;
}

.n2l-tip p,
.n2l-warning p {
    margin: 0;
    font-size: 14px;
}

/* Privacy notice */
.n2l-privacy-notice {
    background-color: #e8f5e9;
    border: 1px solid #4caf50;
    padding: 15px 20px;
    margin-top: 40px;
    display: flex;
    align-items: flex-start;
}

.n2l-privacy-notice i {
    color: #4caf50;
    font-size: 20px;
    margin-right: 12px;
    margin-top: 2px;
}

.n2l-privacy-notice p {
    margin: 0;
    font-size: 14px;
    color: #2e7d32;
}

/* Footer */
.n2l-footer-links {
    margin-top: 60px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #666;
}

.n2l-footer-links a {
    color: #384D68;
    text-decoration: none;
}

.n2l-footer-links a:hover {
    text-decoration: underline;
}

/* Right panel specific styles */
.n2l-welcome-right h2 {
    color: #384D68;
    font-size: 32px;
    margin-bottom: 25px;
    font-weight: 400;
}

/* Quick start steps */
.n2l-quick-start {
    background-color: white;
    border: 1px solid #e0e0e0;
    padding: 20px;
    margin-bottom: 30px;
	display:none;
}

.n2l-quick-step {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.n2l-quick-step:last-child {
    margin-bottom: 0;
}

.n2l-quick-number {
    background-color: #384D68;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    margin-right: 12px;
    flex-shrink: 0;
}

.n2l-quick-step span:last-child {
    font-size: 15px;
    color: #444;
}

/* Prompt generator container */
.n2l-prompt-gen-container {
    background-color: white;
    border: 1px solid #e0e0e0;
    padding: 20px;
    margin-bottom: 30px;
}

.n2l-prompt-gen-container h3 {
    color: #384D68;
    font-size: 20px;
    margin-bottom: 10px;
}

.n2l-prompt-gen-container p {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
}

.n2l-prompt-gen-btn {
    background-color: #384D68;
    color: white;
    border: none;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
}

.n2l-prompt-gen-btn:hover {
    background-color: #2a3a4d;
}

.n2l-prompt-gen-btn i {
    margin-right: 8px;
}

/* Code input container */
.n2l-code-input-container {
    background-color: white;
    border: 1px solid #e0e0e0;
    padding: 20px;
}

#n2l-welcome-code-input {
    width: 100%;
    min-height: 300px;
    padding: 15px;
    border: 1px solid #ddd;
    font-family: monospace;
    font-size: 14px;
    resize: vertical;
    margin-bottom: 20px;
}

.n2l-input-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.n2l-welcome-btn {
    padding: 10px 20px;
    cursor: pointer;
    font-size: 15px;
    border: 1px solid #384D68;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
}

.n2l-welcome-btn i {
    margin-right: 8px;
}

.n2l-welcome-btn.primary {
    background-color: #384D68;
    color: white;
}

.n2l-welcome-btn.primary:hover {
    background-color: #2a3a4d;
}

.n2l-welcome-btn.secondary {
    background-color: white;
    color: #384D68;
}

.n2l-welcome-btn.secondary:hover {
    background-color: #f0f0f0;
}

/* New CSS Rule form */
.n2l-new-rule-form {
    background-color: #f0f0f0;
    padding: 10px;
    border: 1px dashed #ccc;
    margin-top: 10px;
}

.n2l-new-rule-form input,
.n2l-new-rule-form textarea {
    width: 100%;
    margin-bottom: 8px;
}

.n2l-new-rule-form label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9em;
}

.n2l-add-rule-btn {
    display: block;
    width: 100%;
    text-align: center;
    padding: 8px;
    margin-top: 8px;
    background-color: #f0f0f0;
    border: 1px dashed #384D68;
    color: #384D68;
    cursor: pointer;
}

.n2l-add-rule-btn:hover {
    background-color: #e0e0e0;
}

/* Prompt Generator Modal Styles */
.n2l-prompt-modal-content {
    width: 90%;
    max-width: 1200px;
    height: 85vh;
    max-height: 85vh;
    overflow: hidden;
    padding: 20px;
}

#n2l-prompt-generator-iframe {
    width: 100%;
    height: calc(100% - 70px);
    border: none;
    overflow: auto;
}

.n2l-prompt-generator-container {
    padding: 0;
    height: calc(100% - 70px);
    overflow: hidden;
}

/* Comment Indicator Icon Style */
.n2l-comment-indicator {
    position: absolute;
    width: 20px;
    height: 20px;
    background-color: #2196F3; /* Blue */
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    z-index: 1002; /* Above selected outline, potentially below toolbar if toolbar needs to be higher */
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
    border: 1px solid #0d47a1; /* Darker blue border */
    transition: transform 0.1s ease-out;
}
.n2l-comment-indicator:hover {
    transform: scale(1.1);
}
.n2l-comment-indicator i {
    pointer-events: none; /* So clicks go to the div itself */
}


/* Responsive adjustments */
@media (max-width: 1200px) {
    .n2l-compact-cards {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .n2l-welcome-content-wrapper {
        flex-direction: column;
    }
    
    .n2l-welcome-left,
    .n2l-welcome-right {
        padding: 20px;
    }
    
    .n2l-welcome-right {
        position: relative;
        height: auto;
    }
    
    .n2l-component-cards {
        flex-direction: column;
    }
}

/* Getting Started Section */
.n2l-getting-started {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0;
    padding: 12px;
    margin: 15px 0;
    font-size: 0.9em;
	margin-top: 0;
}

.n2l-getting-started h4 {
    margin: 0 0 8px 0;
    color: #384D68;
    font-size: 1.1em;
    font-weight: 500;
}

.n2l-getting-started p {
    margin: 0 0 8px 0;
    color: #555;
}

.n2l-getting-started ul {
    margin: 0;
    padding-left: 20px;
    list-style-type: disc;
}

.n2l-getting-started li {
    margin-bottom: 5px;
    color: #555;
    line-height: 1.4;
}

.n2l-getting-started li:last-child {
    margin-bottom: 0;
}

.n2l-getting-started strong {
    color: #384D68;
    font-weight: 500;
}

</style>
<!-- Include Font Awesome for Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Include Roboto font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
   
</head>
<body>
<!-- Welcome Page -->
<div id="n2l-welcome-page" class="n2l-welcome-page">
    <div class="n2l-welcome-container">
        <div class="n2l-welcome-content-wrapper">
            <div class="n2l-welcome-left">
                <!-- Updated header with logo and title/links -->
                <div class="n2l-welcome-header">
                    <img src="logo.png" alt="Notes2LLM Logo" class="n2l-welcome-logo">
                    <div class="n2l-title-container">
                        <h1>Notes2LLM</h1>
                        <p class="n2l-subtitle">Visual Code Editor & Prompt Generator for AI-Assisted Web Development</p>
                        
                        <!-- External links container -->
                        <div class="n2l-external-links">
                            <a href="https://github.com/lukaszliniewicz/notes2llm" class="n2l-github-link" target="_blank">
                                <i class="fab fa-github"></i> View on GitHub
                            </a>
                            <a href="https://iarf.net/support-us/" class="n2l-donation-link" target="_blank">
                                <i class="fas fa-heart"></i> Support this project
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Tabbed content -->
                <div class="n2l-tabs">
                    <div class="n2l-tab-buttons">
                        <button class="n2l-tab-button active" data-tab="overview">Overview</button>
                        <button class="n2l-tab-button" data-tab="workflow">Workflow</button>
                        <button class="n2l-tab-button" data-tab="wordpress">WordPress</button>
                        <button class="n2l-tab-button" data-tab="email">Email</button>
                        <button class="n2l-tab-button" data-tab="website">Website</button>
                        <button class="n2l-tab-button" data-tab="llms">LLMs</button>
                    </div>
                    
                    <div class="n2l-tab-content">
                        <!-- Overview Tab -->
                        <div class="n2l-tab-panel active" id="overview-tab">
                            <div class="n2l-section">
                                <h2>About Notes2LLM</h2>
                                <p>Notes2LLM is a browser-based tool consisting of a visual code editor/annotator workspace and a prompt generator. It assists inexperienced users in creating advanced HTML/CSS/JS projects through AI-powered chat interfaces.</p>
                                
                                <!-- Components moved here -->
                                <div class="n2l-components">
                                    <div class="n2l-component-cards">
                                        <div class="n2l-component-card">
                                            <i class="fas fa-magic"></i>
                                            <div>
                                                <h3>Prompt Generator</h3>
                                                <p>Create well-structured prompts with purpose selection, styling options, and accessibility features.</p>
                                            </div>
                                        </div>
                                        <div class="n2l-component-card">
                                            <i class="fas fa-edit"></i>
                                            <div>
                                                <h3>Workspace Editor</h3>
                                                <p>Visual editor for previewing code, direct text editing, adding comments for LLMs, and manipulating elements.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <p>Perfect for creating:</p>
                                <div class="n2l-compact-cards">
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-check"></i>
                                        <span>Static websites and web pages</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-check"></i>
                                        <span>WordPress posts, pages, and custom widgets</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-check"></i>
                                        <span>Emails, email signatures and newsletters</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-check"></i>
                                        <span>Data visualizations (tables, diagrams)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="n2l-section">
                                <h2>The Problem We Solve</h2>
                                <p>With models like Gemini 2.5 Pro available for free, web development has become more accessible. However, getting results just right without browsing nested HTML or writing very specific prompts remains a lenghty and imprecise process.</p>
                                
                                <p>Notes2LLM eliminates the need to:</p>
                                <div class="n2l-compact-cards negative">
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-times"></i>
                                        <span>Manually edit text in nested HTML tags</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-times"></i>
                                        <span>Go back-and-forth with AI multiple times</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-times"></i>
                                        <span>Lose track of changes in lengthy conversations</span>
                                    </div>
                                    <div class="n2l-compact-card">
                                        <i class="fas fa-times"></i>
                                        <span>Write very specific, detailed follow-up prompts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Workflow Tab -->
                        <div class="n2l-tab-panel" id="workflow-tab">
                            <h2>Workflow</h2>
                            <div class="n2l-workflow-container">
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">1</div>
                                    <div class="n2l-step-content">
                                        <h3>Prepare Content</h3>
                                        <p>Gather your text or data that needs to be presented on the web</p>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">2</div>
                                    <div class="n2l-step-content">
                                        <h3>Generate Prompt</h3>
                                        <p>Use the Notes2LLM prompt generator to create a structured prompt - or just write your own prompt</p>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">3</div>
                                    <div class="n2l-step-content">
                                        <h3>Get LLM Response</h3>
                                        <p>Submit the prompt to your preferred LLM and receive generated code</p>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">4</div>
                                    <div class="n2l-step-content">
                                        <h3>Review & Edit</h3>
                                        <p>Load the code into Notes2LLM workspace to preview and make adjustments</p>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">5</div>
                                    <div class="n2l-step-content">
                                        <h3>Add Comments</h3>
                                        <p>Insert specific comments about changes needed using the editor or the comment icon next to elements.</p>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step">
                                    <div class="n2l-step-number">6</div>
                                    <div class="n2l-step-content">
                                        <h3>Refine with LLM</h3>
                                        <p>Send the edited code with comments back to the LLM</p>
                                    </div>
                                    <div class="n2l-cycle-indicator">
                                        <i class="fas fa-sync-alt"></i>
                                        <span>Repeat as needed</span>
                                    </div>
                                </div>
                                
                                <div class="n2l-workflow-step final">
                                    <div class="n2l-step-number">7</div>
                                    <div class="n2l-step-content">
                                        <h3>Export Final Code</h3>
                                        <p>Extract the production-ready code for your project</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- WordPress Tab -->
                        <div class="n2l-tab-panel" id="wordpress-tab">
                            <h2>Using with WordPress</h2>
                            
                            <div class="n2l-method-section">
                                <h3><i class="fas fa-cube"></i> Gutenberg Custom HTML Block</h3>
                                <ol class="n2l-numbered-list">
                                    <li>In your WordPress editor, add a "Custom HTML" block</li>
                                    <li>Paste your final Notes2LLM-processed code into the block</li>
                                    <li>Switch between "HTML" and "Preview" modes to verify appearance</li>
                                    <li>Publish or update your page/post</li>
                                </ol>
                            </div>
                            
                            <div class="n2l-method-section">
                                <h3><i class="fas fa-layer-group"></i> Elementor or Other Page Builders</h3>
                                <ol class="n2l-numbered-list">
                                    <li>Add an "HTML" or "Custom Code" widget to your page layout</li>
                                    <li>Paste your final code from Notes2LLM</li>
                                    <li>Most page builders will render the preview instantly</li>
                                    <li>Save or update your page</li>
                                </ol>
                            </div>
                            
                            <div class="n2l-tip">
                                <i class="fas fa-lightbulb"></i>
                                <p><strong>Pro Tip:</strong> Use the prompt generator with "WordPress" as the purpose for optimized code generation.</p>
                            </div>
                        </div>
                        
                        <!-- Email Tab -->
                        <div class="n2l-tab-panel" id="email-tab">
                            <h2>Using for Email</h2>
                            
                            <div class="n2l-method-section">
                                <h3><i class="fas fa-envelope"></i> Creating Email Signatures or Templates</h3>
                                <ol class="n2l-numbered-list">
                                    <li>Use the prompt generator with "Email" as the purpose</li>
                                    <li>Specify "Email Signature" or "Newsletter" as appropriate</li>
                                    <li>The generated code will use table-based layouts and inline CSS for maximum compatibility</li>
                                </ol>
                            </div>
                            
                            <div class="n2l-method-section">
                                <h3><i class="fas fa-mail-bulk"></i> Implementing in Email Clients</h3>
                                <div class="n2l-email-clients">
                                    <div class="n2l-email-client">
                                        <h4>Thunderbird</h4>
                                        <p>Account Settings > Composition & Addressing > HTML Editor</p>
                                    </div>
                                    <div class="n2l-email-client">
                                        <h4>Outlook</h4>
                                        <p>Settings > Mail > Compose and reply > HTML editor option</p>
                                    </div>
                                    <div class="n2l-email-client">
                                        <h4>Gmail</h4>
                                        <p>Limited HTML editing – use signature managers like WiseStamp</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="n2l-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <p><strong>Note:</strong> Email HTML requires special considerations due to limited CSS support across email clients.</p>
                            </div>
                        </div>
                        
                        <!-- Website Tab -->
                        <div class="n2l-tab-panel" id="website-tab">
                            <h2>Using for Websites</h2>
                            
                            <div class="n2l-method-section">
                                <h3><i class="fas fa-globe"></i> Standalone Websites or Web Pages</h3>
                                <ol class="n2l-numbered-list">
                                    <li>Use the prompt generator with "Full Website," "Web Page," or "Web App" as the purpose</li>
                                    <li>Load the generated code into the Notes2LLM workspace</li>
                                    <li>Make visual edits and add comments for refinement</li>
                                    <li>After refinement with the LLM, extract the final code</li>
                                    <li>Deploy to your hosting provider</li>
                                </ol>
                            </div>
                            
                            <div class="n2l-tip">
                                <i class="fas fa-rocket"></i>
                                <p><strong>Deployment Options:</strong> Copy files directly to your server or use the HTML in a site builder.</p>
                            </div>
                        </div>
                        
                        <!-- LLMs Tab -->
                        <div class="n2l-tab-panel" id="llms-tab">
                            <h2>Recommended LLMs</h2>
                            
                            <div class="n2l-llm-cards">
                                <div class="n2l-llm-card">
                                    <h3><i class="fas fa-brain"></i> Claude 3.7 Sonnet</h3>
                                    <p class="n2l-llm-cost">Requires Claude Pro subscription ($20/month)</p>
                                    <p>Exceptional for complex layouts and maintaining visual consistency. The "thinking" mode significantly improves code quality.</p>
                                </div>
                                
                                <div class="n2l-llm-card">
                                    <h3><i class="fas fa-gem"></i> Gemini 2.5 Pro</h3>
                                    <p class="n2l-llm-cost">Free in Google AI Studio</p>
                                    <p>Very high quality code generation with good visual design sense. Requires more specific prompts than Claude but handles large projects well.</p>
                                </div>
                                
                                <div class="n2l-llm-card">
                                    <h3><i class="fas fa-code"></i> Deepseek v3</h3>
                                    <p class="n2l-llm-cost">Various pricing options</p>
                                    <p>Strong code generation capabilities, particularly good at implementing specific technical requirements.</p>
                                </div>
                            </div>
                            
                            <div class="n2l-tip">
                                <i class="fas fa-chart-bar"></i>
                                <p><strong>Compare Models:</strong> Visit <a href="https://web.lmarena.ai/leaderboard" target="_blank">lmarena.ai WebDev Leaderboard</a> for comprehensive benchmarks.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy Notice -->
                <div class="n2l-privacy-notice">
                    <i class="fas fa-shield-alt"></i>
                    <p><strong>Privacy:</strong> All processing happens locally in your browser. No data is sent to any server.</p>
                </div>
                
                <!-- Footer -->
                <div class="n2l-footer-links">
                    <a href="#" id="n2l-terms-link">Terms and Conditions</a>
                    <span>MIT License &copy; Luke Liniewicz, 2025</span>
                </div>
            </div>
            <div class="n2l-welcome-right">
                <h2>Get Started</h2>
                
                <!-- Quick Start Steps -->
                <div class="n2l-quick-start">
                    <div class="n2l-quick-step">
                        <span class="n2l-quick-number">1</span>
                        <span>Create a prompt with our generator or paste existing code</span>
                    </div>
                    <div class="n2l-quick-step">
                        <span class="n2l-quick-number">2</span>
                        <span>Load the code into the workspace</span>
                    </div>
                    <div class="n2l-quick-step">
                        <span class="n2l-quick-number">3</span>
                        <span>Edit visually and export refined code</span>
                    </div>
                </div>
                
                <!-- Prompt Generator section -->
                <div class="n2l-prompt-gen-container">
                    <h3>Need help creating code?</h3>
                    <p>Our prompt generator helps you create effective prompts for LLMs to generate exactly the code you need.</p>
                    <button id="n2l-open-prompt-gen-btn" class="n2l-prompt-gen-btn">
                        <i class="fas fa-magic"></i> Generate LLM Prompt for Code
                    </button>
                </div>
                
                <div class="n2l-code-input-container">
                    <textarea id="n2l-welcome-code-input" placeholder="Paste your HTML, CSS (<style>), and JS (<script>) here..."></textarea>
                    <div class="n2l-input-buttons">
                        <button id="n2l-use-example-btn" class="n2l-welcome-btn secondary"><i class="fas fa-lightbulb"></i> Use Example Code</button>
                        <button id="n2l-welcome-load-btn" class="n2l-welcome-btn primary"><i class="fas fa-play"></i> Load & Render Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div id="n2l-terms-modal" class="n2l-modal">
	<div class="n2l-modal-content">
		<span class="n2l-close">&times;</span>
		<div class="n2l-modal-header">
			<h2>Terms and Conditions</h2>
		</div>
		<div class="n2l-modal-body">
			<p>This tool is made available for use as-is, free of charge, without any warranties or guarantees of any kind, either expressed or implied. The author is not liable for any damages or issues arising from the use of this tool.</p>
			<p>No data whatsoever is collected when using Notes2LLM. All processing happens entirely in your browser.</p>
		</div>
	</div>
</div>

<!-- Prompt Generator Modal -->
<div id="n2l-prompt-generator-modal" class="n2l-modal">
	<div class="n2l-modal-content n2l-prompt-modal-content">
		<span class="n2l-close">&times;</span>
		<div class="n2l-modal-header">
			<h2>Notes2LLM Prompt Generator</h2>
		</div>
		<div class="n2l-modal-body n2l-prompt-generator-container">
			<iframe id="n2l-prompt-generator-iframe" src="prompt_generator.html" frameborder="0"></iframe>
		</div>
	</div>
</div>

<div class="n2l-app-container">
<div class="n2l-sidebar" id="n2l-sidebar">
<!-- Added sidebar header with logo -->
<div class="n2l-sidebar-header">
	<img src="logo.png" alt="Notes2LLM Logo" class="n2l-sidebar-logo">
	<h3>Notes2LLM</h3>
</div>

<!-- New getting started section -->
<div class="n2l-getting-started">
	<h4>Getting Started</h4>
	<p>To begin editing:</p>
	<ul>
		<li><strong>Click</strong> on any element to select and edit it</li>
		<li>Enter <strong>Preview Mode</strong> to interact with dynamic content (expandable sections, lightboxes, etc.)</li>
		<li>Exit Preview Mode to continue editing newly revealed elements</li>
	</ul>
</div>

<button id="n2l-get-code-btn" class="secondary">Get Processed Code</button>
<button id="n2l-preview-mode-btn">Enter Preview Mode</button>

	 <div id="n2l-controls-panel" style="display: none;">
			<h3>Selected Element</h3>
			<div id="n2l-element-info">Tag: N/A</div>

			<!-- Text Editing - Reorganized -->
			<div id="n2l-text-edit-control" class="n2l-control-group" style="display: none;">
				<h3>Text</h3>
				<p>Edit text content directly:</p>
				<textarea id="n2l-text-editor"></textarea>
				<button id="n2l-apply-text-change">Apply Text</button>
			</div>

			 <!-- Image Source Editing - Reorganized -->
			<div id="n2l-image-src-control" class="n2l-control-group" style="display: none;">
				<h3>Image</h3>
				<label for="n2l-image-src-input">Image Source (URL):</label>
				<input type="text" id="n2l-image-src-input">
				<button id="n2l-apply-src-change">Apply Source</button>
			</div>

			<!-- CSS Control - Reorganized -->
			<div id="n2l-css-control" class="n2l-control-group">
				<h3>Style</h3>
				
				<!-- Selector inputs (was part of selector manager) -->
				<div class="n2l-selector-inputs">
					<div>
						<label for="n2l-element-class">Classes:</label>
						<input type="text" id="n2l-element-class" placeholder="e.g. btn primary">
					</div>
					<div>
						<label for="n2l-element-id">ID:</label>
						<input type="text" id="n2l-element-id" placeholder="e.g. main-header">
					</div>
				</div>
				
				<!-- Two buttons for operations -->
				<div style="display: flex; gap: 5px;">
					<button id="n2l-apply-class-id">Add/Modify Selector</button>
					<button id="n2l-add-css-rule-btn">Add Rule</button>
				</div>
				
				<!-- CSS rules editor -->
				<div id="n2l-css-rules-editor" style="margin-top: 15px;">
					<!-- CSS rules will be populated here -->
					<div class="n2l-no-rules-message">No CSS rules found for this element.</div>
				</div>
			</div>

			<!-- Full HTML Editor -->
			<div id="n2l-html-control" class="n2l-control-group">
				<h3>HTML</h3>
				<label for="n2l-element-html-editor">Edit Element HTML:</label>
				<textarea id="n2l-element-html-editor"></textarea>
				<button id="n2l-apply-html-changes">Apply HTML</button>
			</div>
		</div>
	</div>

	<div class="n2l-resizer" id="n2l-resizer"></div>

	<div class="n2l-preview-pane">
		<iframe id="n2l-preview-iframe"></iframe>
		<div id="n2l-preview-mode-indicator">Preview Mode: Click elements to interact</div>
	</div>
</div>

<!-- Selector Indicator (appears above toolbar) -->
<div id="n2l-selector-indicator"></div>

<!-- Floating Action Toolbar -->
<div id="n2l-action-toolbar">
	<button id="n2l-copy-above-btn" title="Copy Above"><i class="fas fa-arrow-up"></i> <i class="far fa-copy"></i></button>
	<button id="n2l-copy-below-btn" title="Copy Below"><i class="far fa-copy"></i> <i class="fas fa-arrow-down"></i></button>
	<button id="n2l-add-comment-above-btn" title="Comment Above"><i class="fas fa-arrow-up"></i> <i class="far fa-comment-dots"></i></button>
	<button id="n2l-add-comment-below-btn" title="Comment Below"><i class="far fa-comment-dots"></i> <i class="fas fa-arrow-down"></i></button>
	<button id="n2l-toggle-state-btn" title="Toggle Element State"><i class="fas fa-exchange-alt"></i></button>
	<button id="n2l-remove-btn" class="danger" title="Remove Element"><i class="fas fa-trash-alt"></i></button>
</div>


<script>
	// CSS Parser and Manager
	class Notes2LLMCssManager {
		constructor() {
			this.cssRules = [];
			this.originalCssText = '';
		}
		
		parseCss(cssText) {
			this.originalCssText = cssText;
			this.cssRules = [];
			
			// Simple CSS parser - handles most common cases
			const ruleRegex = /([\s\S]*?)\s*\{([\s\S]*?)\}/g;
			let match;
			
			while ((match = ruleRegex.exec(cssText)) !== null) {
				const selector = match[1].trim();
				const cssProperties = match[2].trim();
				
				if (selector && cssProperties) {
					this.cssRules.push({
						selector: selector,
						properties: cssProperties
					});
				}
			}
			
			return this.cssRules;
		}
		
		getMatchingRules(element) {
			if (!element) return [];
			
			const matchingRules = [];
			
			this.cssRules.forEach(rule => {
				try {
					// Special case for selectors that contain a comma (multiple selectors in one rule)
					const selectors = rule.selector.split(',').map(s => s.trim());
					
					// Check each selector in the rule
					for (const selector of selectors) {
						try {
							// Check if this single selector matches the element
							if (element.matches(selector)) {
								matchingRules.push({...rule, matchedBy: selector});
								break; // One match within the comma-separated list is enough
							}
						} catch (selectorError) {
							console.warn(`Invalid selector part "${selector}" in rule "${rule.selector}"`, selectorError);
						}
					}
				} catch (error) {
					console.warn(`Error checking if element matches selector "${rule.selector}"`, error);
				}
			});
			
			return matchingRules;
		}
		
		updateRule(selector, newProperties) {
			const ruleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (ruleIndex !== -1) {
				this.cssRules[ruleIndex].properties = newProperties;
			}
		}
		
		addRule(selector, properties) {
			// Check if rule with this selector already exists
			const existingRuleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (existingRuleIndex !== -1) {
				// Merge with existing rule
				this.cssRules[existingRuleIndex].properties = properties;
			} else {
				// Add new rule
				this.cssRules.push({
					selector: selector,
					properties: properties
				});
			}
		}
		
		deleteRule(selector) {
			const ruleIndex = this.cssRules.findIndex(rule => rule.selector === selector);
			
			if (ruleIndex !== -1) {
				this.cssRules.splice(ruleIndex, 1);
			}
		}
		
		generateCss() {
			let cssText = '';
			
			this.cssRules.forEach(rule => {
				cssText += `${rule.selector} {\n`;
				
				// Format properties with each on new line and indented
				const formattedProperties = rule.properties
					.split(';')
					.map(prop => prop.trim())
					.filter(prop => prop) // Remove empty properties
					.map(prop => `    ${prop};`)
					.join('\n');
				
				cssText += `${formattedProperties}\n}\n\n`;
			});
			
			return cssText;
		}
	}

	// DOM Elements
	const welcomeCodeInput = document.getElementById('n2l-welcome-code-input');
	const welcomeLoadBtn = document.getElementById('n2l-welcome-load-btn');
	const useExampleBtn = document.getElementById('n2l-use-example-btn');
	const getCodeBtn = document.getElementById('n2l-get-code-btn');
	const previewIframe = document.getElementById('n2l-preview-iframe');
	const sidebar = document.getElementById('n2l-sidebar');
	const resizer = document.getElementById('n2l-resizer');
	const controlsPanel = document.getElementById('n2l-controls-panel');
	const elementInfo = document.getElementById('n2l-element-info');
	const actionToolbar = document.getElementById('n2l-action-toolbar');
	const selectorIndicator = document.getElementById('n2l-selector-indicator');
	const previewModeBtn = document.getElementById('n2l-preview-mode-btn');
	const previewModeIndicator = document.getElementById('n2l-preview-mode-indicator');
	const welcomePage = document.getElementById('n2l-welcome-page');
	const termsModal = document.getElementById('n2l-terms-modal');
	const termsLink = document.getElementById('n2l-terms-link');
	const closeButtons = document.querySelectorAll('.n2l-close');
	const promptGeneratorModal = document.getElementById('n2l-prompt-generator-modal');
	const openPromptGenBtn = document.getElementById('n2l-open-prompt-gen-btn');

	// Control Elements
	const elementClassInput = document.getElementById('n2l-element-class');
	const elementIdInput = document.getElementById('n2l-element-id');
	const applyClassIdBtn = document.getElementById('n2l-apply-class-id');
	const textEditControl = document.getElementById('n2l-text-edit-control');
	const textEditor = document.getElementById('n2l-text-editor');
	const applyTextChange = document.getElementById('n2l-apply-text-change');
	const imageSrcControl = document.getElementById('n2l-image-src-control');
	const imageSrcInput = document.getElementById('n2l-image-src-input');
	const applySrcChange = document.getElementById('n2l-apply-src-change');
	const cssRulesEditor = document.getElementById('n2l-css-rules-editor');
	const addCssRuleBtn = document.getElementById('n2l-add-css-rule-btn');
	const htmlControl = document.getElementById('n2l-html-control');
	const elementHtmlEditor = document.getElementById('n2l-element-html-editor');
	const applyHtmlChangesBtn = document.getElementById('n2l-apply-html-changes');

	// Action Toolbar Buttons
	const copyAboveBtn = document.getElementById('n2l-copy-above-btn');
	const copyBelowBtn = document.getElementById('n2l-copy-below-btn');
	const addCommentAboveBtn = document.getElementById('n2l-add-comment-above-btn');
	const addCommentBelowBtn = document.getElementById('n2l-add-comment-below-btn');
	const toggleStateBtn = document.getElementById('n2l-toggle-state-btn');
	const removeBtn = document.getElementById('n2l-remove-btn');

	// State Variables
	let iframeDoc = null;
	let iframeWin = null;
	let selectedElement = null;
	let isResizing = false;
	let originalJs = '';  // Store original JS content
	let previewModeActive = false; // Track preview mode state
	const cssManager = new Notes2LLMCssManager(); // Create CSS Manager
    let commentedElements = new Map(); // Map: element -> { commentNode: Node, iconElement: HTMLElement, position: 'above' | 'below' }

    // Global state for tracking pre-preview attributes and IDs
    let originalElementsSnapshot = new Map();
    let nextN2LId = 1; // Counter for unique IDs

	// Example code for demonstration
	const exampleCode = `
<!-- N2L_COMMENT: This is a main container for the example. -->
<div class="example-container">
  <header class="example-header">
	<h1>My Example Page</h1>
	<nav>
	  <ul>
		<li><a href="#">Home</a></li>
		<li><a href="#">About</a></li>
		<li><a href="#">Contact</a></li>
	  </ul>
	</nav>
  </header>
  
  <main>
	<section class="hero">
	  <h2>Welcome to My Page</h2>
	  <p>This is a simple example to demonstrate Notes2LLM features.</p>
	  <button id="demo-btn">Click Me</button>
	</section>
	
	<section class="content">
	  <div class="card">
		<img src="https://via.placeholder.com/150" alt="Placeholder">
		<h3>Feature One</h3>
		<p>Description of feature one goes here.</p>
	  </div>
	  <!-- N2L_COMMENT: Another card here. -->
	  <div class="card">
		<img src="https://via.placeholder.com/150" alt="Placeholder">
		<h3>Feature Two</h3>
		<p>Description of feature two goes here.</p>
	  </div>
	</section>
  </main>
  
  <footer>
	<p>© 2025 Example Page</p>
  </footer>
</div>

<style>
body {
  font-family: 'Arial', sans-serif;
  margin: 0;
  padding: 0;
  color: #333;
}

.example-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.example-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 0;
  border-bottom: 1px solid #eee;
}

nav ul {
  display: flex;
  list-style: none;
  gap: 20px;
}

nav a {
  text-decoration: none;
  color: #384D68;
  font-weight: bold;
}

.hero {
  text-align: center;
  padding: 60px 0;
  background-color: #f5f7fa;
  margin: 20px 0;
}

.hero h2 {
  color: #384D68;
  margin-bottom: 15px;
}

#demo-btn {
  background-color: #384D68;
  color: white;
  border: none;
  padding: 10px 20px;
  margin-top: 20px;
  cursor: pointer;
}

.content {
  display: flex;
  gap: 30px;
  margin: 40px 0;
}

.card {
  flex: 1;
  border: 1px solid #eee;
  padding: 20px;
  text-align: center;
}

.card img {
  max-width: 100%;
  margin-bottom: 15px;
}

.card h3 {
  color: #384D68;
}

footer {
  text-align: center;
  padding: 20px 0;
  border-top: 1px solid #eee;
  margin-top: 40px;
}
</style>

<script>
  if (document.getElementById('demo-btn')) {
    document.getElementById('demo-btn').addEventListener('click', function() {
	  alert('Button clicked! This is a simple JavaScript demo.');
    });
  }
<\/script>
`;
    // Helper function to ensure an element has a data-n2l-id
    function ensureN2LId(element) {
        // Ensure element is a valid HTML element and not e.g. a text node
        if (!element || typeof element.setAttribute !== 'function') {
            return;
        }
        if (!element.hasAttribute('data-n2l-id')) {
            element.setAttribute('data-n2l-id', `n2l-id-${nextN2LId++}`);
        }
    }

    // Helper function to assign data-n2l-id to all elements under a root
    function assignN2LIdsToDom(rootNode) {
        if (!rootNode || typeof rootNode.querySelectorAll !== 'function') return;

        // If rootNode itself is an element (e.g. newElement in applyHtmlChanges), it needs an ID.
        if (rootNode.nodeType === Node.ELEMENT_NODE) {
            ensureN2LId(rootNode);
        }
        // Assign IDs to all children
        rootNode.querySelectorAll('*').forEach(el => ensureN2LId(el));
    }

    // Captures the state of elements (their classes and inline styles) before JS interactions in preview mode
    function capturePreviewStartState() {
        if (!iframeDoc || !iframeDoc.body) return;
        originalElementsSnapshot.clear(); // Clear previous snapshot

        // Query for all elements that have our tracking ID
        const elements = iframeDoc.body.querySelectorAll('[data-n2l-id]');
        elements.forEach(el => {
            const id = el.getAttribute('data-n2l-id');
            if (id) { // Ensure ID is not null/empty, though setAttribute should prevent this
                originalElementsSnapshot.set(id, {
                    className: el.className,
                    styleCssText: el.style.cssText
                    // Potentially add other attributes like 'open' for <details> if needed
                });
            }
        });
    }

	// --- Initialization ---
	function init() {
		// Show welcome page on load
		welcomePage.style.display = 'block';
		
		// Initialize tabs
		initWelcomeTabs();
		
		// Add event listener for "Use example code" button
		useExampleBtn.addEventListener('click', function() {
			welcomeCodeInput.value = exampleCode.trim();
		});
		
		// Modal events
		welcomeLoadBtn.addEventListener('click', function() {
			if (welcomeCodeInput.value.trim() === '') {
				alert('Please paste some code first or use the example code.');
				return;
			}
			loadCodeIntoIframe();
			welcomePage.style.display = 'none';
		});
		
		termsLink.addEventListener('click', function(e) {
			e.preventDefault();
			termsModal.style.display = 'block';
		});
		
		closeButtons.forEach(button => {
			button.addEventListener('click', function() {
				this.closest('.n2l-modal').style.display = 'none';
			});
		});
		
		// Open prompt generator modal
		openPromptGenBtn.addEventListener('click', function() {
			promptGeneratorModal.style.display = 'block';
		});
		
		// Close modals when clicking outside
		window.addEventListener('click', function(e) {
			if (e.target === termsModal) {
				termsModal.style.display = 'none';
			}
			if (e.target === promptGeneratorModal) {
				promptGeneratorModal.style.display = 'none';
			}
		});
		
		getCodeBtn.addEventListener('click', showProcessedCode);
		resizer.addEventListener('mousedown', startResize);
		document.addEventListener('mousemove', resizeSidebar);
		document.addEventListener('mouseup', stopResize);
		previewModeBtn.addEventListener('click', togglePreviewMode);

		// Add listeners for sidebar control panel actions
		applyClassIdBtn.addEventListener('click', applyClassAndId);
		applyTextChange.addEventListener('click', applyText);
		applySrcChange.addEventListener('click', applyImageSource);
		applyHtmlChangesBtn.addEventListener('click', applyHtmlChanges);
		addCssRuleBtn.addEventListener('click', showAddCssRuleForm);

		// Add listeners for action toolbar buttons
		removeBtn.addEventListener('click', removeSelectedElement);
		copyAboveBtn.addEventListener('click', () => copyElement(true));
		copyBelowBtn.addEventListener('click', () => copyElement(false));
		addCommentAboveBtn.addEventListener('click', () => addCommentForElement(true));
		addCommentBelowBtn.addEventListener('click', () => addCommentForElement(false));
		toggleStateBtn.addEventListener('click', toggleElementState);

		// Hide toolbar if clicking outside the iframe
		document.addEventListener('click', (e) => {
			if (previewIframe && !previewIframe.contains(e.target) && actionToolbar && !actionToolbar.contains(e.target) && selectedElement) {
				// Basic check; might need refinement if sidebar interaction should keep toolbar open
			}
		});

		// Hide toolbar on main window scroll
		window.addEventListener('scroll', () => {
            hideActionToolbar();
            updateAllCommentIconsPositions(); // Update icon positions relative to main window scroll
        });
        window.addEventListener('resize', () => {
            positionActionToolbar();
            updateAllCommentIconsPositions();
        });
	}

	function initWelcomeTabs() {
		const tabButtons = document.querySelectorAll('.n2l-tab-button');
		const tabPanels = document.querySelectorAll('.n2l-tab-panel');
		
		tabButtons.forEach(button => {
			button.addEventListener('click', () => {
				const targetTab = button.getAttribute('data-tab');
				
				// Remove active class from all buttons and panels
				tabButtons.forEach(btn => btn.classList.remove('active'));
				tabPanels.forEach(panel => panel.classList.remove('active'));
				
				// Add active class to clicked button and corresponding panel
				button.classList.add('active');
				document.getElementById(`${targetTab}-tab`).classList.add('active');
			});
		});
	}

	// --- Resizing Logic ---
	function startResize(e) {
		isResizing = true;
		document.body.style.userSelect = 'none';
		document.body.style.pointerEvents = 'none'; // Prevent interaction with iframe during resize
        if (previewIframe) previewIframe.style.pointerEvents = 'none';
		hideActionToolbar();
	}
	
	function resizeSidebar(e) {
		if (!isResizing) return;
		const sidebarWidth = e.clientX;
		const minWidth = parseInt(getComputedStyle(sidebar).minWidth, 10);
		const maxWidth = window.innerWidth * (parseInt(getComputedStyle(sidebar).maxWidth, 10) / 100);
		
		if (sidebarWidth > minWidth && sidebarWidth < maxWidth) {
			sidebar.style.width = `${sidebarWidth}px`;
		}
	}
	
	function stopResize(e) {
		if (isResizing) {
			isResizing = false;
			document.body.style.userSelect = '';
			document.body.style.pointerEvents = '';
            if (previewIframe) previewIframe.style.pointerEvents = '';
            updateAllCommentIconsPositions(); // Update positions after resize
            positionActionToolbar();
		}
	}

	// --- Code Loading & Iframe Setup ---
	function loadCodeIntoIframe() {
		const rawCode = welcomeCodeInput.value;
		selectedElement = null;
		hideControls();
		hideActionToolbar();
		originalJs = ''; // Reset stored JS content

		// Clear existing comment icons and data
		if (iframeDoc) {
			const existingIconContainer = iframeDoc.getElementById('n2l-comment-icon-container');
			if (existingIconContainer) {
				existingIconContainer.innerHTML = ''; 
			}
		}
		commentedElements.clear();
		
		// Exit preview mode if active
		if (previewModeActive) {
			togglePreviewMode();
		}

		let htmlContent = rawCode;
		let extractedCss = '';
		let extractedJs = '';

		// Extract <style> blocks and store content
		const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
		htmlContent = htmlContent.replace(styleRegex, (match, css) => {
			extractedCss += css + '\n';
			return ''; // Remove from HTML source for initial render
		});

		// Extract <script> blocks (inline only) and store content
		const scriptRegex = /<script[^>]*>([\s\S]*?)<\/script>/gi;
		htmlContent = htmlContent.replace(scriptRegex, (match, js) => {
			if (!match.toLowerCase().includes('src=')) { // Basic check for inline scripts
				extractedJs += js + '\n';
				return ''; // Remove inline script from HTML source for initial render
			}
			return match; // Keep external scripts in HTML part
		});
		originalJs = extractedJs.trim(); // Store the extracted JS

		// Parse CSS with our manager
		cssManager.parseCss(extractedCss.trim());

		// Prepare iframe content
		const iframeContent = `
			<!DOCTYPE html>
			<html>
			<head>
				<meta charset="UTF-8">
				<title>Preview</title>
				<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
				<link rel="preconnect" href="https://fonts.googleapis.com">
				<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
				<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Open+Sans&display=swap" rel="stylesheet">
				<style>
					/* Basic iframe body style */
					body { margin: 8px; padding: 0; font-family: 'Roboto', sans-serif; position: relative; /* For icon container */ }
					/* Editor selection style */
					.N2L_EDITOR_SELECTED { 
						outline: 2px dashed #384D68 !important; 
						box-shadow: 0 0 10px rgba(56, 77, 104, 0.5); 
						cursor: default; /* Indicate it's selectable */
					}
					/* Prevent link navigation in editor mode */
					a { pointer-events: none; } 

					/* Comment Indicator Icon Style (copied from main styles for iframe context) */
					.n2l-comment-indicator {
						position: absolute; /* Will be positioned by JS */
						width: 20px;
						height: 20px;
						background-color: #2196F3; /* Blue */
						color: white;
						border-radius: 50%;
						display: flex;
						align-items: center;
						justify-content: center;
						font-size: 10px;
						cursor: pointer;
						z-index: 1002; 
						box-shadow: 0 1px 3px rgba(0,0,0,0.4);
						border: 1px solid #0d47a1; /* Darker blue border */
						transition: transform 0.1s ease-out;
					}
					.n2l-comment-indicator:hover {
						transform: scale(1.1);
					}
					.n2l-comment-indicator i {
						pointer-events: none;
					}
					
					/* Inject parsed CSS rules */
					${cssManager.generateCss()}
				</style>
				<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>
			</head>
			<body>
				${htmlContent.trim()}
			</body>
			</html>
		`;

		previewIframe.srcdoc = iframeContent;

		previewIframe.onload = () => {
			try {
				iframeWin = previewIframe.contentWindow;
				iframeDoc = previewIframe.contentDocument || iframeWin.document;

				if (!iframeDoc || !iframeDoc.body) {
					console.error("Could not access iframe document or body.");
					alert("Error: Could not initialize preview iframe.");
					return;
				}

                // ***** MODIFIED: Assign initial IDs and clear snapshot *****
                assignN2LIdsToDom(iframeDoc.body);
                originalElementsSnapshot.clear(); // Reset snapshot, new content loaded


				iframeDoc.body.addEventListener('click', handleIframeClick, true);

				// Prevent navigation but allow internal anchors
				const links = iframeDoc.getElementsByTagName('a');
				for (const link of links) {
					link.addEventListener('click', (event) => {
						event.preventDefault();
						const href = link.getAttribute('href');
						if (href && href.startsWith('#')) {
							// Allow internal anchor navigation
							const targetId = href.substring(1);
							const targetElement = iframeDoc.getElementById(targetId);
							if (targetElement) {
								targetElement.scrollIntoView({ behavior: 'smooth' });
							}
						}
					});
					link.style.pointerEvents = 'auto';
				}
				
				ensureIconContainer();
				scanForExistingComments();
				updateAllCommentIconsPositions();

				iframeWin.addEventListener('scroll', () => {
					positionActionToolbar();
					updateAllCommentIconsPositions();
				}, true);

			} catch (e) {
				console.error("Error accessing iframe content:", e);
				alert("Error initializing iframe: " + e.message);
			}
		};
	}

	 // --- Element Selection & Control/Toolbar Management ---
	 function handleIframeClick(event) {
		if (previewModeActive) return; // If in preview mode, don't handle clicks for selection
		
        // Don't select if a comment icon was clicked
        if (event.target.classList && event.target.classList.contains('n2l-comment-indicator')) {
            return;
        }

		event.preventDefault();
		event.stopPropagation();
		const clickedElement = event.target;

		if (clickedElement === iframeDoc.body || clickedElement === iframeDoc.documentElement || clickedElement.id === 'n2l-comment-icon-container') {
			deselectElement();
			return;
		}
		selectElement(clickedElement);
	 }

	 function selectElement(element) {
		 if (previewModeActive) return; // Ignore selection in preview mode
		 
		 if (selectedElement === element) {
			 positionActionToolbar(); 
             updateAllCommentIconsPositions(); // Refresh icon positions too
			 return;
		 }

		 deselectElement();

		 selectedElement = element;
		 selectedElement.classList.add('N2L_EDITOR_SELECTED');

		 populateControls(selectedElement);
		 controlsPanel.style.display = 'block';
		 positionActionToolbar(); 
		 actionToolbar.style.display = 'block';
		 positionSelectorIndicator();
         updateAllCommentIconsPositions(); // Update icon positions on selection change
	 }

	 function deselectElement() {
		 if (selectedElement) {
			 selectedElement.classList.remove('N2L_EDITOR_SELECTED');
		 }
		 selectedElement = null;
		 hideControls();
		 hideActionToolbar();
		 selectorIndicator.style.display = 'none';
         // Icons for non-selected elements should remain, so no specific call here unless needed
	 }

	 function hideControls() {
		 controlsPanel.style.display = 'none';
	 }

	 function hideActionToolbar() {
		actionToolbar.style.display = 'none';
		selectorIndicator.style.display = 'none';
	 }

	function positionActionToolbar() {
		if (!selectedElement || previewModeActive || !actionToolbar) {
			hideActionToolbar();
			return;
		}

		const iframeRect = previewIframe.getBoundingClientRect(); 
		const elementRect = selectedElement.getBoundingClientRect(); 

		const toolbarHeight = actionToolbar.offsetHeight;
        const mainScrollY = window.scrollY;
        const mainScrollX = window.scrollX;

		let top = iframeRect.top + elementRect.top - toolbarHeight - 5 + mainScrollY;
		let left = iframeRect.left + elementRect.left + mainScrollX;

		if (top < mainScrollY + 5) {
			top = iframeRect.top + elementRect.bottom + 5 + mainScrollY;
		}

		left = Math.max(mainScrollX + 5, left);
		left = Math.min(mainScrollX + window.innerWidth - actionToolbar.offsetWidth - 5, left);

		actionToolbar.style.top = `${top}px`;
		actionToolbar.style.left = `${left}px`;
		actionToolbar.style.display = 'block';
		
		positionSelectorIndicator();
	}
	
	function positionSelectorIndicator() {
		if (!selectedElement || previewModeActive || !selectorIndicator || !actionToolbar.style.display || actionToolbar.style.display === 'none') {
            if(selectorIndicator) selectorIndicator.style.display = 'none';
			return;
		}
		
		const tagName = selectedElement.tagName.toLowerCase();
		const id = selectedElement.id ? `#${selectedElement.id}` : '';
		const classes = selectedElement.classList.length > 0 ? 
			Array.from(selectedElement.classList)
				.filter(c => c !== 'N2L_EDITOR_SELECTED')
				.map(c => `.${c}`)
				.join('') : '';
				
		let selectorText = id ? id : (classes ? `${tagName}${classes}` : tagName);
		
		selectorIndicator.textContent = selectorText;
		
		const toolbarRect = actionToolbar.getBoundingClientRect(); // Relative to viewport
        const indicatorHeight = selectorIndicator.offsetHeight > 0 ? selectorIndicator.offsetHeight : 22; // Approx height
        
        // Position relative to actionToolbar's absolute position
		selectorIndicator.style.top = `${parseFloat(actionToolbar.style.top) - indicatorHeight - 2}px`;
		selectorIndicator.style.left = actionToolbar.style.left;
		selectorIndicator.style.display = 'block';
	}

	function populateControls(el) {
		const tagName = el.tagName.toLowerCase();
		const id = el.id ? `#${el.id}` : '';
		const classes = el.classList.length > 0 ? 
			`.${Array.from(el.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
		elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;

		elementClassInput.value = Array.from(el.classList)
			.filter(c => c !== 'N2L_EDITOR_SELECTED')
			.join(' ');
		elementIdInput.value = el.id || '';

		const textEditableTags = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'a', 'span', 'div', 'td', 'th', 'button', 'label'];
		if (textEditableTags.includes(tagName) || (el.hasChildNodes() && Array.from(el.childNodes).some(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== ''))) {
			let directText = Array.from(el.childNodes)
				.filter(node => node.nodeType === Node.TEXT_NODE)
				.map(node => node.textContent)
				.join('')
				.trim();
			if (!directText && el.innerText && !el.children.length) { 
				directText = el.innerText.trim(); 
			}
			else if (!directText && tagName === 'textarea') { 
				directText = el.value; 
			}
			textEditor.value = directText;
			textEditControl.style.display = 'block';
            imageSrcControl.style.display = 'none';
		} else if (tagName === 'img') {
			imageSrcInput.value = el.src || '';
			imageSrcControl.style.display = 'block';
            textEditControl.style.display = 'none';
		} else {
			textEditControl.style.display = 'none';
            imageSrcControl.style.display = 'none';
		}

		populateCssRules(el);

		const tempEl = el.cloneNode(true);
		tempEl.classList.remove('N2L_EDITOR_SELECTED');
		if (tempEl.classList.length === 0) {
			tempEl.removeAttribute('class');
		}
		let cleanHtml = tempEl.outerHTML;
		
		cleanHtml = cleanHtml.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ').replace(/class="\s*"/g, '').replace(/class='\s*'/g, '').replace(/\s+class=""/g, '').replace(/\s+class=''/g, '');

		elementHtmlEditor.value = cleanHtml;
		htmlControl.style.display = 'block';
	}

	function applyHtmlChanges() {
		if (!selectedElement) return;
		
        // If selected element had a comment, remove its icon and map entry
        if (commentedElements.has(selectedElement)) {
            const entry = commentedElements.get(selectedElement);
            if (entry.iconElement && entry.iconElement.parentNode) entry.iconElement.remove();
            // The comment node itself might be part of selectedElement.outerHTML or a sibling.
            // If it's a sibling, it might be picked up by scanForExistingComments later.
            commentedElements.delete(selectedElement);
        }

		const parentNode = selectedElement.parentNode;
		if (!parentNode) return;
		
		let cleanHtml = elementHtmlEditor.value.trim();
		cleanHtml = cleanHtml.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ').replace(/class="\s*"/g, '').replace(/class='\s*'/g, '').replace(/\s+class=""/g, '').replace(/\s+class=''/g, '');
		
		const temp = iframeDoc.createElement('div');
		temp.innerHTML = cleanHtml;
		
		if (temp.firstChild) {
			const oldElement = selectedElement;
            const newElement = temp.firstChild;
			parentNode.replaceChild(newElement, selectedElement);
			
            // ***** MODIFIED: Assign IDs to new structure and clear snapshot *****
            assignN2LIdsToDom(newElement); 
            originalElementsSnapshot.clear(); // DOM structure significantly changed

            selectElement(newElement); // Select the new element
            scanForExistingComments(); // Re-scan for comments that might now associate with new structure
            updateAllCommentIconsPositions();
		} else {
			console.error('Invalid HTML: No element created');
			alert('The HTML is invalid or empty.');
		}
	}

	// --- Toggle Element State ---
	function toggleElementState() {
		if (!selectedElement) return;
		const currentElement = selectedElement;
		iframeDoc.body.removeEventListener('click', handleIframeClick, true);
		const clickEvent = new MouseEvent('click', { bubbles: true, cancelable: true, view: iframeWin });
		currentElement.dispatchEvent(clickEvent);
		setTimeout(() => {
			if (!previewModeActive) { 
				iframeDoc.body.addEventListener('click', handleIframeClick, true);
				selectElement(currentElement); // Re-select
			}
		}, 100);
	}

	// --- Preview Mode Toggle ---
	function togglePreviewMode() {
		if (!iframeDoc || !iframeDoc.body) {
			previewModeActive = false;
			previewModeBtn.textContent = 'Enter Preview Mode';
			previewModeBtn.classList.remove('preview-active');
			return;
		}

		// Capture state BEFORE entering preview mode
		if (!previewModeActive) { // This block executes when we are ABOUT to enter preview mode
			// Ensure all elements have IDs before taking the snapshot
			assignN2LIdsToDom(iframeDoc.body); // Ensures any elements added by user (e.g. via HTML edit) get IDs
			capturePreviewStartState();
		}
		
		previewModeActive = !previewModeActive;
		const iconContainer = iframeDoc.getElementById('n2l-comment-icon-container');
		
		if (previewModeActive) {
			// ENTERING PREVIEW MODE
			iframeDoc.body.removeEventListener('click', handleIframeClick, true);
			deselectElement();
			if (iconContainer) iconContainer.style.display = 'none';

			// Handle links more carefully
			const links = iframeDoc.getElementsByTagName('a');
			for (const link of links) {
				link.style.pointerEvents = 'auto';
				
				// Store reference to new handler so we can remove it later
				link._previewClickHandler = function(event) {
					const href = this.getAttribute('href');
					if (href && href.startsWith('http')) {
						// External link - prevent navigation
						event.preventDefault();
						console.log(`External link clicked but navigation prevented: ${href}`);
					} else if (href && href.startsWith('#')) {
						// Internal anchor - let it work normally but prevent full page reload
						event.preventDefault();
						const targetId = href.substring(1);
						const targetElement = iframeDoc.getElementById(targetId);
						if (targetElement) {
							targetElement.scrollIntoView({ behavior: 'smooth' });
						}
					}
					// For other links (like javascript: or relative paths), let them work normally
				};
				link.addEventListener('click', link._previewClickHandler);
			}
			
			// Re-execute JavaScript to restore interactive functionality
			if (originalJs && originalJs.trim() !== '') {
				try {
					// Execute JavaScript in the global scope of the iframe
					const scriptElement = iframeDoc.createElement('script');
					scriptElement.textContent = originalJs;
					iframeDoc.body.appendChild(scriptElement);
					
					// Also dispatch a DOMContentLoaded event in case scripts are waiting for it
					const domLoadedEvent = new Event('DOMContentLoaded', {
						bubbles: true,
						cancelable: true
					});
					iframeDoc.dispatchEvent(domLoadedEvent);
					
				} catch (error) {
					console.error("Error executing user JavaScript in preview mode:", error);
				}
			}
			
			previewModeBtn.textContent = 'Exit Preview Mode';
			previewModeBtn.classList.add('preview-active');
			previewIframe.classList.add('preview-mode-frame');
			previewModeIndicator.style.display = 'block';
		} else {
			// EXITING PREVIEW MODE - Keep current state, just restore editor functionality
			
			// Remove dynamically added script elements
			const dynamicScripts = iframeDoc.querySelectorAll('script:not([src])');
			dynamicScripts.forEach(script => {
				if (originalJs && script.textContent.includes(originalJs)) {
					script.remove();
				}
			});
			
			iframeDoc.body.addEventListener('click', handleIframeClick, true);
			if (iconContainer) iconContainer.style.display = 'block';

			// Restore link prevention for editor mode
			const links = iframeDoc.getElementsByTagName('a');
			for (const link of links) {
				// Remove preview mode handler
				if (link._previewClickHandler) {
					link.removeEventListener('click', link._previewClickHandler);
					delete link._previewClickHandler;
				}
				
				// Add editor mode handler
				link._editorClickHandler = function(event) {
					event.preventDefault();
					const href = link.getAttribute('href');
					if (href && href.startsWith('#')) {
						// Allow internal anchor navigation even in editor mode
						const targetId = href.substring(1);
						const targetElement = iframeDoc.getElementById(targetId);
						if (targetElement) {
							targetElement.scrollIntoView({ behavior: 'smooth' });
						}
					}
				};
				link.addEventListener('click', link._editorClickHandler);
				link.style.pointerEvents = 'auto';
			}
			
			previewModeBtn.textContent = 'Enter Preview Mode';
			previewModeBtn.classList.remove('preview-active');
			previewIframe.classList.remove('preview-mode-frame');
			previewModeIndicator.style.display = 'none';
			// Note: We don't revert DOM changes here. Reversion happens at export.
		}
	}

	// --- CSS Rule Handling ---
	function populateCssRules(element) {
		cssRulesEditor.innerHTML = '';
		const matchingRules = cssManager.getMatchingRules(element);
		
		if (matchingRules.length === 0) {
			cssRulesEditor.innerHTML = '<div class="n2l-no-rules-message">No CSS rules found for this element.</div>';
		} else {
			matchingRules.forEach(rule => {
				const ruleDiv = document.createElement('div');
				ruleDiv.className = 'n2l-css-rule-item';
				const selectorDiv = document.createElement('div');
				selectorDiv.className = 'n2l-css-selector';
				selectorDiv.textContent = rule.selector;
				const propertiesTextarea = document.createElement('textarea');
				propertiesTextarea.className = 'n2l-css-properties';
				propertiesTextarea.value = rule.properties;
				const actionsDiv = document.createElement('div');
				actionsDiv.className = 'n2l-rule-actions';
				const updateButton = document.createElement('button');
				updateButton.textContent = 'Update';
				updateButton.className = 'n2l-update-rule-btn';
				updateButton.addEventListener('click', () => {
					cssManager.updateRule(rule.selector, propertiesTextarea.value);
					refreshIframeStyles();
				});
				actionsDiv.appendChild(updateButton);
				ruleDiv.appendChild(selectorDiv);
				ruleDiv.appendChild(propertiesTextarea);
				ruleDiv.appendChild(actionsDiv);
				cssRulesEditor.appendChild(ruleDiv);
			});
		}
	}
	
	function showAddCssRuleForm() {
		if (!selectedElement) return;
		if (document.getElementById('n2l-new-rule-form')) return;
		
		const formDiv = document.createElement('div');
		formDiv.id = 'n2l-new-rule-form';
		formDiv.className = 'n2l-new-rule-form';
		
		let selectorSuggestion = '';
		let suggestedId = '';
		let suggestedClass = '';
		
		if (selectedElement.id) {
			selectorSuggestion = `#${selectedElement.id}`;
			suggestedId = selectedElement.id;
		} else if (selectedElement.classList.length > 0) {
			const classes = Array.from(selectedElement.classList).filter(c => c !== 'N2L_EDITOR_SELECTED');
			if (classes.length > 0) {
				selectorSuggestion = `.${classes[0]}`;
				suggestedClass = classes[0];
			}
		} else {
			const tagName = selectedElement.tagName.toLowerCase();
			suggestedClass = `${tagName}-custom`;
			selectorSuggestion = `.${suggestedClass}`;
		}
		
		formDiv.innerHTML = `
			<label for="n2l-new-rule-selector">CSS Selector:</label>
			<input type="text" id="n2l-new-rule-selector" value="${selectorSuggestion}" placeholder="e.g., .my-class, #my-id, div">
			<label for="n2l-new-rule-properties">CSS Properties:</label>
			<textarea id="n2l-new-rule-properties" placeholder="color: red;\\nfont-size: 16px;\\nmargin: 10px;"></textarea>
			<div class="n2l-slider-container">
				<label class="n2l-slider">
					<input type="checkbox" id="n2l-apply-selector-toggle" ${!suggestedId && suggestedClass ? 'checked' : ''}>
					<span class="n2l-slider-switch"></span>
				</label>
				<span class="n2l-slider-label">Apply this selector to element</span>
			</div>
			<div class="n2l-rule-actions">
				<button id="n2l-cancel-new-rule-btn">Cancel</button>
				<button id="n2l-add-new-rule-btn">Add Rule</button>
			</div>
		`;
		
		cssRulesEditor.appendChild(formDiv);
		document.getElementById('n2l-add-new-rule-btn').addEventListener('click', addNewCssRule);
		document.getElementById('n2l-cancel-new-rule-btn').addEventListener('click', () => formDiv.remove());
		document.getElementById('n2l-new-rule-properties').focus();
	}
	
	function addNewCssRule() {
		const selector = document.getElementById('n2l-new-rule-selector').value.trim();
		const properties = document.getElementById('n2l-new-rule-properties').value.trim();
		const applyToElement = document.getElementById('n2l-apply-selector-toggle').checked;
		
		if (!selector || !properties) {
			alert('Please enter both a selector and properties for the new CSS rule.');
			return;
		}
		
		cssManager.addRule(selector, properties);
		
		if (applyToElement && selectedElement) {
			if (selector.startsWith('.')) {
				const className = selector.substring(1);
				if (!selectedElement.classList.contains(className)) {
					selectedElement.classList.add(className);
					const currentClasses = elementClassInput.value.trim();
					elementClassInput.value = currentClasses ? `${currentClasses} ${className}` : className;
				}
			} else if (selector.startsWith('#')) {
				const idName = selector.substring(1);
				selectedElement.id = idName;
				elementIdInput.value = idName;
			}
			updateElementInfo();
		}
		
		refreshIframeStyles();
		document.getElementById('n2l-new-rule-form').remove();
		if (selectedElement) {
			populateCssRules(selectedElement);
			positionSelectorIndicator();
		}
	}
	
	function refreshIframeStyles() {
		if (!iframeDoc) return;
		const styleTag = iframeDoc.querySelector('style'); // Assumes first style tag is ours or can be replaced
		if (styleTag) {
			const editorStyles = `
				body { margin: 8px; padding: 0; font-family: 'Roboto', sans-serif; position: relative; }
				.N2L_EDITOR_SELECTED { 
					outline: 2px dashed #384D68 !important; 
					box-shadow: 0 0 10px rgba(56, 77, 104, 0.5); 
					cursor: default; 
				}
				a { pointer-events: none; } 
                .n2l-comment-indicator { position: absolute; width: 20px; height: 20px; background-color: #2196F3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 1002; box-shadow: 0 1px 3px rgba(0,0,0,0.4); border: 1px solid #0d47a1; transition: transform 0.1s ease-out; }
                .n2l-comment-indicator:hover { transform: scale(1.1); }
                .n2l-comment-indicator i { pointer-events: none; }
			`;
			styleTag.textContent = editorStyles + cssManager.generateCss();
		}
		if (selectedElement) populateCssRules(selectedElement);
	}

	function updateElementInfo() {
		if (!selectedElement) return;
		const tagName = selectedElement.tagName.toLowerCase();
		const id = selectedElement.id ? `#${selectedElement.id}` : '';
		const classes = selectedElement.classList.length > 0 ? 
			`.${Array.from(selectedElement.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
		elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;
	}

	// --- Control Actions ---
	function applyClassAndId() {
		if (!selectedElement) return;
		const newClasses = elementClassInput.value.trim().split(/\s+/).filter(Boolean);
		Array.from(selectedElement.classList).filter(cls => cls !== 'N2L_EDITOR_SELECTED').forEach(cls => selectedElement.classList.remove(cls));
		newClasses.forEach(cls => selectedElement.classList.add(cls));
		selectedElement.id = elementIdInput.value.trim();
		updateElementInfo();
		populateCssRules(selectedElement);
		positionSelectorIndicator();
	}
	
	function applyText() {
		if (!selectedElement) return;
		const tagName = selectedElement.tagName.toLowerCase();
		if (tagName === 'textarea') {
			selectedElement.value = textEditor.value;
		} else {
			let foundTextNode = false;
			Array.from(selectedElement.childNodes).forEach(node => {
				if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== '') {
					node.textContent = textEditor.value;
					foundTextNode = true;
				}
			});
			if (!foundTextNode || selectedElement.childNodes.length === 0) {
				selectedElement.textContent = textEditor.value;
			}
		}
	}
	
	function applyImageSource() {
		if (!selectedElement || selectedElement.tagName.toLowerCase() !== 'img') return;
		selectedElement.src = imageSrcInput.value;
	}
	

	// --- Toolbar Actions ---
	function removeSelectedElement() {
		if (!selectedElement) return;

        if (commentedElements.has(selectedElement)) {
            const entry = commentedElements.get(selectedElement);
            if (entry.commentNode && entry.commentNode.parentNode) entry.commentNode.remove();
            if (entry.iconElement && entry.iconElement.parentNode) entry.iconElement.remove();
            commentedElements.delete(selectedElement);
        }
        // Also check for sibling comments that might now be orphaned if they were associated with this element visually
        const prevSib = selectedElement.previousSibling;
        if (prevSib && prevSib.nodeType === Node.COMMENT_NODE && prevSib.nodeValue.includes('N2L_COMMENT:')) {
            // This comment might have been for 'selectedElement' (as 'above')
            // Need a more robust way to find if this comment has an icon and if that icon belongs to 'selectedElement'
            // For now, this manual removal is a bit risky without checking the map.
            // It's safer to rely on commentedElements map for managed comments.
        }

		const elementToRemove = selectedElement; 
		deselectElement(); 
		elementToRemove.remove();
        updateAllCommentIconsPositions(); // Update positions as layout might change
	}

	function copyElement(above) {
		if (!selectedElement) return;
		const clone = selectedElement.cloneNode(true);
		clone.classList.remove('N2L_EDITOR_SELECTED');
		
		// ***** MODIFIED: Strip old IDs, assign new unique ID(s) to clone, and clear snapshot *****
		function stripN2LIdsRecursive(element) {
			if (element.removeAttribute) element.removeAttribute('data-n2l-id');
			if (element.querySelectorAll) {
				element.querySelectorAll('[data-n2l-id]').forEach(child => child.removeAttribute('data-n2l-id'));
			}
		}
		stripN2LIdsRecursive(clone); // Strip existing IDs from the clone and its children
		assignN2LIdsToDom(clone);    // Assign new, unique IDs
		originalElementsSnapshot.clear(); // DOM structure changed

		if (above) {
			selectedElement.parentNode.insertBefore(clone, selectedElement);
		} else {
			selectedElement.parentNode.insertBefore(clone, selectedElement.nextSibling);
		}
        updateAllCommentIconsPositions(); // Cloned element won't have icon yet, but layout changed
	}

    // --- Comment Icon Logic ---
    function ensureIconContainer() {
        if (!iframeDoc || !iframeDoc.body) return null;
        let container = iframeDoc.getElementById('n2l-comment-icon-container');
        if (!container) {
            container = iframeDoc.createElement('div');
            container.id = 'n2l-comment-icon-container';
            container.style.position = 'absolute';
            container.style.top = '0';
            container.style.left = '0';
            container.style.pointerEvents = 'none'; 
            container.style.zIndex = '1001'; 
            iframeDoc.body.appendChild(container);
        }
        // Always update size because iframe body scrollWidth/Height can change
        container.style.width = `${iframeDoc.body.scrollWidth}px`;
        container.style.height = `${iframeDoc.body.scrollHeight}px`;
        return container;
    }

    function addCommentForElement(above) {
		if (!selectedElement) return;
		const commentText = prompt("Enter comment text for the LLM:", "TODO: Refine this section");
		if (commentText === null || commentText.trim() === "") return;

		const commentNode = iframeDoc.createComment(` N2L_COMMENT: ${commentText.trim()} `);
		const targetElement = selectedElement; 

		if (above) {
			targetElement.parentNode.insertBefore(commentNode, targetElement);
		} else {
			targetElement.parentNode.insertBefore(commentNode, targetElement.nextSibling);
		}
		createOrUpdateCommentIcon(targetElement, commentNode, above ? 'above' : 'below');
        updateAllCommentIconsPositions();
	}

    function createOrUpdateCommentIcon(element, commentNode, position) {
        const iconContainer = ensureIconContainer();
        if (!iconContainer) return;

        // If element already has an icon, remove the old one first
        if (commentedElements.has(element)) {
            const oldEntry = commentedElements.get(element);
            if (oldEntry.iconElement && oldEntry.iconElement.parentNode) {
                oldEntry.iconElement.remove();
            }
            // Keep old commentNode if it's different, or let the new one replace it.
            // The current logic implies new commentNode is always used.
        }

        const iconElement = iframeDoc.createElement('div');
        iconElement.className = 'n2l-comment-indicator';
        iconElement.innerHTML = '<i class="fas fa-comment-dots"></i>';
        iconElement.title = "Edit/View Comment";
        iconContainer.appendChild(iconElement);
        iconElement.style.pointerEvents = 'auto';

        commentedElements.set(element, { commentNode, iconElement, position });
        // positionCommentIcon(element, iconElement); // Called by updateAllCommentIconsPositions

        iconElement.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent iframe click selection
            handleCommentIconClick(element);
        });
    }

    function handleCommentIconClick(element) {
        const entry = commentedElements.get(element);
        if (!entry) return;

        const currentCommentText = entry.commentNode.nodeValue.replace(/^ N2L_COMMENT: /, '').replace(/ $/, '').trim();
        const newCommentText = prompt("Edit comment (leave empty to delete):", currentCommentText);

        if (newCommentText === null) return; // User cancelled

        if (newCommentText.trim() === "") { 
            if(entry.commentNode.parentNode) entry.commentNode.remove();
            if(entry.iconElement.parentNode) entry.iconElement.remove();
            commentedElements.delete(element);
        } else { 
            entry.commentNode.nodeValue = ` N2L_COMMENT: ${newCommentText.trim()} `;
        }
        // updateAllCommentIconsPositions(); // Position might not change, but good for consistency
    }

    function positionCommentIcon(element, iconElement) {
        if (!element || !iconElement || !element.parentNode || !iconElement.parentNode) {
            if (iconElement && iconElement.parentNode) iconElement.remove();
            if (commentedElements.has(element)) commentedElements.delete(element);
            return;
        }
        // Get bounding rects relative to viewport
        // const iframeRect = previewIframe.getBoundingClientRect(); // Not needed if icon container is full body
        const elementRect = element.getBoundingClientRect(); 
        
        const iconWidth = 20;
        const iconHeight = 20;
        const H_OFFSET = -iconWidth / 2; 
        const V_OFFSET = -iconHeight / 2; 

        // Position relative to iframe's viewport, then account for iframe scroll
        const iframeScrollTop = iframeWin.pageYOffset || iframeDoc.documentElement.scrollTop;
        const iframeScrollLeft = iframeWin.pageXOffset || iframeDoc.documentElement.scrollLeft;

        let top = elementRect.top + iframeScrollTop + V_OFFSET;
        let left = elementRect.right + iframeScrollLeft + H_OFFSET;
        
        // Ensure icon is within visible bounds of its container (iconContainer)
        const container = iconElement.parentNode; // Should be n2l-comment-icon-container
        if (container) {
            top = Math.max(0, Math.min(top, container.scrollHeight - iconHeight));
            left = Math.max(0, Math.min(left, container.scrollWidth - iconWidth));
        }


        iconElement.style.top = `${top}px`;
        iconElement.style.left = `${left}px`;
        iconElement.style.display = 'flex'; // Ensure it's visible
    }

    function updateAllCommentIconsPositions() {
        if (!iframeDoc || !iframeDoc.body) return;
        const iconContainer = ensureIconContainer(); // Ensure container exists and is sized
        if (!iconContainer) return;

        for (const [element, entry] of commentedElements) {
            if (element.isConnected && entry.iconElement.isConnected) {
                positionCommentIcon(element, entry.iconElement);
            } else {
                // Element or icon was removed from DOM, clean up map entry
                if (entry.iconElement.isConnected) entry.iconElement.remove();
                // Don't remove commentNode here, it might be intentionally removed with element
                commentedElements.delete(element);
            }
        }
    }

    function scanForExistingComments() {
        if (!iframeDoc || !iframeDoc.body) return;
        ensureIconContainer(); // Make sure container is ready

        const treeWalker = iframeDoc.createTreeWalker(iframeDoc.body, NodeFilter.SHOW_COMMENT, null, false);
        let commentNode;
        const newCommentEntries = new Map(); // To avoid modifying map while iterating and handle multiple comments per element

        while (commentNode = treeWalker.nextNode()) {
            if (commentNode.nodeValue.includes('N2L_COMMENT:')) {
                let associatedElement = null;
                let position = null;

                if (commentNode.nextSibling && commentNode.nextSibling.nodeType === Node.ELEMENT_NODE) {
                    associatedElement = commentNode.nextSibling;
                    position = 'above';
                } else if (commentNode.previousSibling && commentNode.previousSibling.nodeType === Node.ELEMENT_NODE) {
                    associatedElement = commentNode.previousSibling;
                    position = 'below';
                }

                if (associatedElement) {
                    // If we already have a comment for this element, prefer 'above' or the first one found.
                    // This simple logic means one icon per element.
                    if (!commentedElements.has(associatedElement) && !newCommentEntries.has(associatedElement)) {
                         // Store to add after loop to avoid issues if createOrUpdate modifies commentedElements directly
                        newCommentEntries.set(associatedElement, { commentNode, position });
                    }
                }
            }
        }
        // Now create icons for the found comments
        for (const [element, data] of newCommentEntries) {
            createOrUpdateCommentIcon(element, data.commentNode, data.position);
        }
        updateAllCommentIconsPositions(); // Position all icons after scanning
    }


	// --- Get Processed Code ---
	function showProcessedCode() {
		if (!iframeDoc || !iframeDoc.body) {
			alert("Please load some code first.");
			return;
		}

		try {
			const processedBody = iframeDoc.body.cloneNode(true);
            
            const iconContainerClone = processedBody.querySelector('#n2l-comment-icon-container');
            if (iconContainerClone) iconContainerClone.remove();
				
			processedBody.querySelectorAll('.N2L_EDITOR_SELECTED').forEach(el => {
				el.classList.remove('N2L_EDITOR_SELECTED');
				if (el.classList.length === 0) el.removeAttribute('class');
			});
				
            // --- MODIFIED LOGIC FOR REVERTING JS CHANGES AND REMOVING DYNAMIC CONTENT ---
            const elementsToRemove = [];
            const allElementsInClone = Array.from(processedBody.querySelectorAll('*')); // Get static list before modifications

            allElementsInClone.forEach(el => {
                const id = el.getAttribute('data-n2l-id');
                if (id && originalElementsSnapshot.has(id)) {
                    // This element existed before preview: revert its class and style attributes
                    const snapshot = originalElementsSnapshot.get(id);
                    el.className = snapshot.className;       // Revert class
                    el.style.cssText = snapshot.styleCssText; // Revert style
                } else if (id) { // Has an ID, but it's not in the snapshot (i.e., added during preview)
                    elementsToRemove.push(el);
                } else { 
                    // No ID - this element might be dynamically generated content that wasn't assigned an ID, or part of a larger user edit.
                    // This logic assumes dynamically generated content for removal *must* have been given an ID by our system.
                    // If JS creates elements without our system assigning IDs, they might remain.
                    // For safety, let's stick to removing only identified new elements.
                    // If an element has no ID but also is not in the snapshot, it's harder to classify without more complex diffing.
                    // The current strategy focuses on elements that *did* get an ID but were not in the original snapshot.
                    // Let's refine: if an element has a data-n2l-id, it *must* be in snapshot or it's new.
                    // If it *doesn't* have a data-n2l-id, it's either user-pasted HTML without IDs,
                    // or JS generated it and we didn't catch it to assign an ID (less likely with assignN2LIdsToDom).
                    // The safest is to only remove elements with a data-n2l-id that is *not* in the snapshot.
                }
            });

            elementsToRemove.forEach(el => {
                if (el.parentNode) { // Ensure element is still in DOM before removing
                     el.remove();
                }
            });

            // Remove all data-n2l-id attributes from the final output
            processedBody.querySelectorAll('[data-n2l-id]').forEach(el => el.removeAttribute('data-n2l-id'));
            // --- END OF MODIFIED LOGIC ---
				
			let processedHTML = processedBody.innerHTML.trim();
			
			processedHTML = processedHTML.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ').replace(/class="\s*"/g, '').replace(/class='\s*'/g, '').replace(/\s+class=""/g, '').replace(/\s+class=''/g, '').replace(/class="\s+/g, 'class="').replace(/class='\s+/g, "class='");

			const processedCSS = cssManager.generateCss();
			let finalCode = processedHTML;

			if (processedCSS) finalCode += `\n\n<style>\n${processedCSS.trim()}\n</style>`;
			if (originalJs) finalCode += `\n\n<script>\n${originalJs.trim()}\n<\/script>`;

			const outputArea = document.createElement('textarea');
			outputArea.style.width = '90%';
			outputArea.style.height = '400px';
			outputArea.style.fontFamily = 'monospace';
			outputArea.value = finalCode;
			outputArea.id = "processed-code-textarea";

			const dialog = document.createElement('div');
			dialog.style.position = 'fixed';
			dialog.style.top = '5vh'; // Use vh for better centering
			dialog.style.left = '50%';
			dialog.style.transform = 'translateX(-50%)';
			dialog.style.backgroundColor = 'white';
			dialog.style.padding = '20px';
			dialog.style.border = '1px solid black';
			dialog.style.zIndex = '1001';
			dialog.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            dialog.style.width = '80%'; // Make dialog wider
            dialog.style.maxHeight = '90vh'; // Max height
            dialog.style.overflowY = 'auto'; // Scroll if content too tall
			dialog.innerHTML = '<h3>Processed Code (Modified HTML + CSS/JS):</h3>';

            // Add the LLM prompt suggestion
            const promptSuggestion = document.createElement('p');
            promptSuggestion.style.fontStyle = 'italic';
            promptSuggestion.style.fontSize = '0.9em';
            promptSuggestion.style.marginBottom = '10px';
            promptSuggestion.style.padding = '8px';
            promptSuggestion.style.backgroundColor = '#e9e9e9'; // Lighter grey
            promptSuggestion.style.border = '1px solid #ccc';
            promptSuggestion.style.borderRadius = '3px';
            promptSuggestion.innerHTML = "<b>A prompt you can use to ask the LLM to work on this according to your comments:</b><br>Please review the code and the comments I added for you. Edit it guided by the comments. Provide the full code with no placeholders or omissions, and make sure that all functionalities remain intact.";
            dialog.appendChild(promptSuggestion);
			
			dialog.appendChild(outputArea);
			
			const buttonContainer = document.createElement('div');
			buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'flex-end'; // Align buttons to the right
			buttonContainer.style.marginTop = '10px';
			
			const copyBtn = document.createElement('button');
			copyBtn.textContent = 'Copy to Clipboard';
			copyBtn.className = 'modal-button';
			copyBtn.onclick = () => {
				const textarea = document.getElementById('processed-code-textarea');
				textarea.select();
				try {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => { copyBtn.textContent = 'Copy to Clipboard'; }, 2000);
                    }).catch(err => {
                        console.warn('Async clipboard copy failed, falling back to execCommand.');
                        document.execCommand('copy'); // Fallback for older browsers / non-secure contexts
                        copyBtn.textContent = 'Copied! (fallback)';
                        setTimeout(() => { copyBtn.textContent = 'Copy to Clipboard'; }, 2000);
                    });
                } catch (e) {
                    console.warn('Clipboard API not available, falling back to execCommand.');
                    document.execCommand('copy');
                    copyBtn.textContent = 'Copied! (fallback)';
                    setTimeout(() => { copyBtn.textContent = 'Copy to Clipboard'; }, 2000);
                }
			};
			buttonContainer.appendChild(copyBtn);
			
			const closeBtn = document.createElement('button');
			closeBtn.textContent = 'Close';
			closeBtn.className = 'modal-button';
			closeBtn.onclick = () => document.body.removeChild(dialog);
			buttonContainer.appendChild(closeBtn);
			
			dialog.appendChild(buttonContainer);

			const existingDialog = document.querySelector('.n2l-output-dialog');
			if (existingDialog) document.body.removeChild(existingDialog);
			dialog.classList.add('n2l-output-dialog');
			document.body.appendChild(dialog);

		} catch (e) {
			console.error("Error generating processed code:", e);
			alert("An error occurred while trying to generate the processed code: " + e.message);
		}
	}

	// --- Start the app ---
	init();
</script>