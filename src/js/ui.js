import state from './state.js';
import logoUrl from '../assets/logo.webp';
import { assignN2LIdsToDom } from './domUtils.js';
import { handleIframeClick, handleIframeMouseOver, handleIframeMouseOut, selectElement, deselectElement, addCommentForElement, refreshIframeStyles, scanForExistingComments, updateAllCommentIconsPositions, togglePreviewMode, removeSelectedElement, copyElement, moveElementUp, moveElementDown, toggleElementState, toggleHoverState, rebuildOriginalElementsSnapshot, positionActionToolbar, ensureSelectedElementIsVisible } from './editor.js';
import { TextChangeCommand, HTMLChangeCommand, AddCSSRuleCommand, CSSRuleChangeCommand, RemoveCSSRuleCommand, JSChangeCommand, AiCssUpdateCommand, RemoveElementCommand, CopyElementCommand, MoveElementCommand, FullHtmlChangeCommand, FullCssChangeCommand } from './commands.js';
import { initPromptGenerator } from './promptGenerator.js';
import * as aiService from './aiService.js';
import { PROVIDERS } from './config.js';
import CodeMirror from 'codemirror';
import 'codemirror/mode/xml/xml.js';
import 'codemirror/mode/css/css.js';
import 'codemirror/mode/javascript/javascript.js';
import 'codemirror/mode/htmlmixed/htmlmixed.js';
import 'codemirror/addon/search/searchcursor.js';
import html2canvas from 'html2canvas';

const welcomePageHTML = `
<div id="n2l-welcome-page" class="n2l-welcome-page">
    <div class="n2l-welcome-container">
        <div class="n2l-welcome-header">
            <img src="${logoUrl}" alt="Notes2LLM Logo" class="n2l-welcome-logo">
            <div class="n2l-title-container">
                <h1>Notes2LLM</h1>
                <p class="n2l-subtitle">Visual Editor for AI-Generated Web Code</p>
            </div>
            <div class="n2l-header-actions">
                <a href="https://github.com/lukaszliniewicz/notes2llm" class="n2l-donation-link" target="_blank">
                    <i class="fab fa-github"></i> GitHub
                </a>
                 <a href="https://iarf.net/support-us/" class="n2l-donation-link" target="_blank">
                    <i class="fas fa-heart"></i> Support this project
                </a>
            </div>
        </div>

        <div class="n2l-welcome-main-content">
            <div class="n2l-welcome-intro">
                <p class="n2l-intro-lead">Refine HTML, CSS, and JavaScript generated by Large Language Models. Edit visually, add comments for the AI, and iterate quickly.</p>
                
                <div class="n2l-use-cases-grid">
                    <div class="n2l-use-case">
                        <i class="fas fa-laptop-code"></i>
                        <h4>Websites & Mockups</h4>
                        <p>Ask an LLM for a "modern landing page" or "dashboard layout". Paste it here to tweak spacing, colors, and content before finalizing.</p>
                    </div>
                    <div class="n2l-use-case">
                        <i class="fab fa-wordpress"></i>
                        <h4>WordPress Widgets</h4>
                        <p>Generate custom HTML/CSS widgets for your site. Use Notes2LLM to ensure they look perfect before pasting into WordPress.</p>
                    </div>
                    <div class="n2l-use-case">
                        <i class="fas fa-envelope-open-text"></i>
                        <h4>Email Templates</h4>
                        <p>Create responsive email layouts or signatures. Visually edit the text and styles to match your brand identity.</p>
                    </div>
                </div>
            </div>

            <div class="n2l-start-widget">
                <div class="n2l-start-tabs">
                    <button class="n2l-start-tab active" data-target="start-ai">
                        <i class="fas fa-robot"></i> Generate with AI
                    </button>
                    <button class="n2l-start-tab" data-target="start-paste">
                        <i class="fas fa-paste"></i> Paste Code
                    </button>
                    <button class="n2l-start-tab" data-target="start-file">
                        <i class="fas fa-folder-open"></i> Open File
                    </button>
                </div>
                
                <div class="n2l-start-content">
                    <!-- AI Panel -->
                    <div id="start-ai" class="n2l-start-panel active">
                        <h3>Generate with AI</h3>
                        <p>Use your own API key (OpenAI, Google, OpenRouter) to generate and edit code directly within the app.</p>
                        <div class="n2l-panel-actions">
                            <button id="n2l-generate-with-ai-btn" class="n2l-welcome-btn primary">Start Generation</button>
                            <button id="n2l-ai-settings-btn" class="n2l-welcome-btn secondary" title="AI Settings"><i class="fas fa-cog"></i> Configure API</button>
                        </div>
                    </div>

                    <!-- Paste Panel -->
                    <div id="start-paste" class="n2l-start-panel">
                        <h3>Paste Code</h3>
                        <p>Paste HTML/CSS/JS from ChatGPT, Claude, or any other LLM chat interface.</p>
                        <textarea id="n2l-welcome-code-input" placeholder="Paste your code here..."></textarea>
                        <div class="n2l-panel-actions">
                            <button id="n2l-welcome-load-btn" class="n2l-welcome-btn primary">Load Workspace</button>
                            <button id="n2l-use-example-btn" class="n2l-welcome-btn secondary">Try Example</button>
                        </div>
                    </div>

                    <!-- File Panel -->
                    <div id="start-file" class="n2l-start-panel">
                        <h3>Open File</h3>
                        <p>Open a saved Notes2LLM project (.json) or an HTML file to continue working.</p>
                        <div class="n2l-panel-actions column-layout">
                            <button id="n2l-welcome-load-project-btn" class="n2l-welcome-btn secondary"><i class="fas fa-file-import"></i> Load Project JSON</button>
                            <button id="n2l-welcome-load-html-btn" class="n2l-welcome-btn secondary"><i class="fas fa-code"></i> Load HTML File</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="n2l-tools-section">
                <h3>Tools</h3>
                <div class="n2l-tool-item">
                    <p>Need a better prompt? Use the <strong>Prompt Generator</strong> to create detailed specifications for your LLM.</p>
                    <button id="n2l-open-prompt-gen-btn" class="n2l-welcome-btn secondary">Open Prompt Generator</button>
                </div>
            </div>
        </div>

        <div class="n2l-welcome-footer">
             <div class="n2l-privacy-notice">
                <i class="fas fa-shield-alt"></i> All processing happens locally in your browser. Your API keys are stored in local storage.
            </div>
            <div class="n2l-footer-links">
                <a href="https://github.com/lukaszliniewicz/notes2llm" target="_blank"><i class="fab fa-github"></i> GitHub</a>
                <a href="#" id="n2l-terms-link">Terms</a>
            </div>
        </div>
    </div>
</div>
`;

const exampleCode = `
<div class="test-suite-container">
  <h1>Preview Mode Robustness Test</h1>
  <p>This example contains several scenarios to test the preview mode logic.</p>

  <!-- N2L_COMMENT: This is a tab system. In preview, click a tab to see its content. After exiting preview, you should be able to edit the visible content. Exported code should show Tab 1 by default. -->
  <div class="tabs-container">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="1">Tab 1</button>
      <button class="tab-btn" data-tab="2">Tab 2</button>
      <button class="tab-btn" data-tab="3">Tab 3</button>
    </div>
    <div class="tab-content">
      <div class="tab-panel active" id="tab-1">
        <h2>Content for Tab 1</h2>
        <p>This is the initial visible content.</p>
      </div>
      <div class="tab-panel" id="tab-2">
        <h2>Content for Tab 2</h2>
        <p>You should only see this after clicking "Tab 2" in preview mode.</p>
      </div>
      <div class="tab-panel" id="tab-3">
        <h2>Content for Tab 3</h2>
        <p>Some more content here for the third tab.</p>
      </div>
    </div>
  </div>

  <!-- N2L_COMMENT: Accordion test. Click headers in preview mode to expand/collapse. -->
  <div class="accordion-container">
    <div class="accordion-item">
      <h3 class="accordion-header">Accordion Item 1</h3>
      <div class="accordion-content">
        <p>This is the content of the first accordion item. It starts collapsed.</p>
      </div>
    </div>
    <div class="accordion-item">
      <h3 class="accordion-header">Accordion Item 2</h3>
      <div class="accordion-content">
        <p>And here is the content for the second item.</p>
      </div>
    </div>
  </div>

  <!-- N2L_COMMENT: Hover effect test. The box should change color on hover in preview. You can also use the hover simulation button in the editor. -->
  <div class="hover-test-container">
      <h2>Hover Test</h2>
      <div class="hover-box">Hover over me!</div>
  </div>

  <!-- N2L_COMMENT: Modal test. The button should show a hidden modal dialog in preview. -->
  <div class="modal-test-container">
      <h2>Modal Test</h2>
      <button id="show-modal-btn">Show Modal</button>
      <div id="test-modal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
              <h3>This is a modal</h3>
              <p>It should disappear when you exit preview mode.</p>
              <button id="close-modal-btn">Close</button>
          </div>
      </div>
  </div>

  <!-- N2L_COMMENT: Form input test. Text typed here should not persist after exiting preview mode. -->
  <div class="form-test-container">
    <h2>Form Input Test</h2>
    <input type="text" placeholder="Type something here...">
    <textarea placeholder="And here..."></textarea>
  </div>

  <!-- N2L_COMMENT: Dynamic style test. Button adds a new style tag to the head. This change should be reverted. -->
  <div class="dynamic-style-container">
    <h2>Dynamic Style Tag Test</h2>
    <p class="dynamic-style-target">This text will turn orange.</p>
    <button id="add-style-tag-btn">Add Dynamic Style</button>
  </div>

  <!-- N2L_COMMENT: Dynamic element test. Use buttons in preview to add/remove items. Added items should be gone on export. -->
  <div class="dynamic-list-container">
    <h2>Dynamic List</h2>
    <ul id="dynamic-list">
      <li>Initial item 1</li>
      <li>Initial item 2</li>
    </ul>
    <button id="add-item-btn">Add Item</button>
    <button id="remove-item-btn">Remove Last Item</button>
  </div>
  
  <!-- N2L_COMMENT: Style modification test. The button below will change the style of this box. This change should be reverted on export. -->
  <div class="style-box-container">
    <h2>Style Modifier</h2>
    <div id="style-box">
      <p>This box will change style.</p>
    </div>
    <button id="change-style-btn">Change Style</button>
  </div>

</div>

<style>
  body { font-family: sans-serif; color: #333; }
  .test-suite-container { max-width: 800px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; transition: border-color 0.3s; }
  .test-suite-container > div { margin-bottom: 30px; padding: 15px; border: 1px solid #eee; }
  
  /* Tabs */
  .tab-buttons { border-bottom: 1px solid #ccc; margin-bottom: 10px; display: flex; }
  .tab-btn { padding: 10px 15px; border: 1px solid transparent; border-bottom: none; background: #f0f0f0; cursor: pointer; }
  .tab-btn.active { background: #fff; border-color: #ccc; border-bottom-color: #fff; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }
  
  /* Accordion */
  .accordion-header { background: #f0f0f0; padding: 10px; cursor: pointer; border: 1px solid #ccc; margin-top: 5px; }
  .accordion-content { display: none; padding: 10px; border: 1px solid #ccc; border-top: none; }
  .accordion-item.open .accordion-content { display: block; }
  .accordion-item.open .accordion-header { background: #e0e0e0; }
  
  /* Hover Test */
  .hover-box { padding: 20px; background-color: #e9e9e9; transition: background-color 0.3s; text-align: center; }
  .hover-box:hover { background-color: #d0d0d0; font-weight: bold; }

  /* Modal Test */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;}
  .modal-content { background: white; padding: 20px; border-radius: 5px; text-align: center; }

  /* Dynamic Style Target */
  .dynamic-style-target { font-weight: bold; }

  /* Style Box */
  #style-box { border: 2px solid #3498db; padding: 15px; transition: all 0.3s ease; }
  #style-box.highlight { background-color: #f1c40f; border-color: #f39c12; }

  button { padding: 8px 12px; margin-right: 5px; cursor: pointer; }
  input, textarea { width: 100%; padding: 8px; margin-top: 5px; }

  /* Media query test */
  @media (max-width: 600px) {
    .test-suite-container {
      border-color: #e74c3c; /* Red border on small screens */
      padding: 10px;
    }
    .tab-buttons {
      flex-direction: column;
    }
    h1 { font-size: 1.5em; }
    h2 { font-size: 1.2em; }
  }
</style>

<script>
  // Tab functionality
  const tabContainer = document.querySelector('.tabs-container');
  if (tabContainer) {
    tabContainer.addEventListener('click', function(e) {
      if (e.target.matches('.tab-btn')) {
        const tabNumber = e.target.dataset.tab;
        tabContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        
        tabContainer.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        const newActivePanel = tabContainer.querySelector('#tab-' + tabNumber);
        if (newActivePanel) {
          newActivePanel.classList.add('active');
        }
      }
    });
  }

  // Accordion functionality
  const accordionContainer = document.querySelector('.accordion-container');
  if (accordionContainer) {
    accordionContainer.addEventListener('click', function(e) {
      if (e.target.matches('.accordion-header')) {
        e.target.parentElement.classList.toggle('open');
      }
    });
  }
  
  // Modal functionality
  const showModalBtn = document.getElementById('show-modal-btn');
  const closeModalBtn = document.getElementById('close-modal-btn');
  const modal = document.getElementById('test-modal');

  if (showModalBtn && modal) {
    showModalBtn.addEventListener('click', () => {
      modal.style.display = 'flex';
    });
  }
  if (closeModalBtn && modal) {
    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });
  }

  // Dynamic Style Tag
  const addStyleTagBtn = document.getElementById('add-style-tag-btn');
  if(addStyleTagBtn) {
    addStyleTagBtn.addEventListener('click', () => {
      const newStyle = document.createElement('style');
      newStyle.textContent = '.dynamic-style-target { color: orange; }';
      document.head.appendChild(newStyle);
      addStyleTagBtn.textContent = 'Style Added!';
      addStyleTagBtn.disabled = true;
    });
  }

  // Dynamic list functionality
  const addItemBtn = document.getElementById('add-item-btn');
  const removeItemBtn = document.getElementById('remove-item-btn');
  const dynamicList = document.getElementById('dynamic-list');
  let itemCounter = 3;

  if (addItemBtn && dynamicList) {
    addItemBtn.addEventListener('click', function() {
      const newItem = document.createElement('li');
      newItem.textContent = 'Dynamically added item ' + itemCounter++;
      dynamicList.appendChild(newItem);
    });
  }
  
  if (removeItemBtn && dynamicList) {
    removeItemBtn.addEventListener('click', function() {
      if (dynamicList.lastElementChild) {
        dynamicList.removeChild(dynamicList.lastElementChild);
      }
    });
  }

  // Style changer functionality
  const changeStyleBtn = document.getElementById('change-style-btn');
  const styleBox = document.getElementById('style-box');
  if (changeStyleBtn && styleBox) {
    changeStyleBtn.addEventListener('click', function() {
      styleBox.style.backgroundColor = 'lightblue';
      styleBox.classList.add('highlight');
      const p = styleBox.querySelector('p');
      if (p) {
        p.textContent = 'My style was changed by JS!';
      }
    });
  }
<\/script>
`;

function populateWelcomePage() {
    document.body.insertAdjacentHTML('afterbegin', welcomePageHTML);
}

function initWelcomePage() {
    populateWelcomePage();
    const { uiElements } = state;
    uiElements.welcomeCodeInput = document.getElementById('n2l-welcome-code-input');
	uiElements.welcomeLoadBtn = document.getElementById('n2l-welcome-load-btn');
	uiElements.useExampleBtn = document.getElementById('n2l-use-example-btn');
    uiElements.welcomePage = document.getElementById('n2l-welcome-page');
    uiElements.termsLink = document.getElementById('n2l-terms-link');
    uiElements.openPromptGenBtn = document.getElementById('n2l-open-prompt-gen-btn');
    uiElements.generateWithAiBtn = document.getElementById('n2l-generate-with-ai-btn');
    uiElements.aiSettingsBtn = document.getElementById('n2l-ai-settings-btn');

    // Welcome Widget Tabs Logic
    const startTabs = document.querySelectorAll('.n2l-start-tab');
    const startPanels = document.querySelectorAll('.n2l-start-panel');

    startTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            startTabs.forEach(t => t.classList.remove('active'));
            startPanels.forEach(p => p.classList.remove('active'));
            
            tab.classList.add('active');
            const targetId = tab.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
        });
    });

    document.getElementById('n2l-welcome-load-project-btn').addEventListener('click', () => {
        document.getElementById('n2l-import-project-input').click();
    });

    document.getElementById('n2l-welcome-load-html-btn').addEventListener('click', () => {
        document.getElementById('n2l-import-html-input').click();
    });

    uiElements.useExampleBtn.addEventListener('click', () => {
        uiElements.welcomeCodeInput.value = exampleCode.trim();
    });
    
    uiElements.welcomeLoadBtn.addEventListener('click', () => {
        const codeToLoad = uiElements.welcomeCodeInput.value;
        if (codeToLoad.trim() === '') {
            alert('Please paste some code first or use the example code.');
            return;
        }
        loadCodeIntoIframe(codeToLoad);
        uiElements.welcomePage.style.display = 'none';
        state.uiElements.topBar.style.display = 'flex';
    });
}

function setEditingMode(mode) {
    state.editingMode = mode;

    const { uiElements } = state;
    const guiBtn = document.getElementById('n2l-mode-gui-btn');
    const snapBtn = document.getElementById('n2l-mode-snap-btn');
    
    if (guiBtn) guiBtn.classList.toggle('active', mode === 'gui');
    if (snapBtn) snapBtn.classList.toggle('active', mode === 'snap-to-code');

    // Deselect any element when switching modes
    deselectElement();

    if (mode === 'gui') {
        if (uiElements.snapToCodePanel) uiElements.snapToCodePanel.style.display = 'none';
        
        const gettingStarted = document.querySelector('.n2l-getting-started');
        if (gettingStarted) {
            gettingStarted.style.display = 'block';
            state.gettingStartedVisible = true;
        }
    } else { // snap-to-code
        if (uiElements.controlsPanel) uiElements.controlsPanel.style.display = 'none';
        if (uiElements.snapToCodePanel) uiElements.snapToCodePanel.style.display = 'flex';
        
        const gettingStarted = document.querySelector('.n2l-getting-started');
        if (gettingStarted) {
            gettingStarted.style.display = 'none';
            state.gettingStartedVisible = false;
        }

        // Populate editors if they are empty
        if (state.iframeDoc && state.iframeDoc.body) {
            let fullBodyHtml = '';
            state.iframeDoc.body.childNodes.forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE) {
                    fullBodyHtml += getFormattedHtml(node, true) + '\n';
                }
            });
            uiElements.cmSnapHtml.setValue(fullBodyHtml.trim());
        }
        uiElements.cmSnapCss.setValue(state.cssManager.generateCss());
        uiElements.cmSnapJs.setValue(state.originalJs);

        // Refresh all CMs
        setTimeout(() => {
            uiElements.cmSnapHtml.refresh();
            uiElements.cmSnapCss.refresh();
            uiElements.cmSnapJs.refresh();
        }, 1);
    }
}

function initSidebarTabs() {
    const tabContainer = document.querySelector('#n2l-controls-panel .n2l-sidebar-tabs');
    if (!tabContainer) return;

    tabContainer.addEventListener('click', (e) => {
        if (e.target.matches('.n2l-sidebar-tab')) {
            const button = e.target;
            const controlPanel = document.getElementById('n2l-controls-panel');
            const tabButtons = tabContainer.querySelectorAll('.n2l-sidebar-tab');
            const tabPanels = controlPanel.querySelectorAll('.n2l-sidebar-tab-panel');

            const targetTabId = button.getAttribute('data-tab');
            state.activeSidebarTab = targetTabId;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanels.forEach(panel => panel.classList.remove('active'));

            button.classList.add('active');
            const targetPanel = document.getElementById(targetTabId);
            if (targetPanel) {
                targetPanel.classList.add('active');

                // Refresh any CodeMirror instances in the new active tab
                if (targetTabId === 'n2l-html-tab' && state.uiElements.showFullHtmlCheckbox.checked) {
                    setTimeout(() => state.uiElements.cmFullHtmlEditor.refresh(), 1);
                } else if (targetTabId === 'n2l-js-tab') {
                    setTimeout(() => state.uiElements.cmFullJsEditor.refresh(), 1);
                } else if (targetTabId === 'n2l-style-tab' && state.uiElements.showFullCssCheckbox.checked) {
                    setTimeout(() => state.uiElements.cmFullCssEditor.refresh(), 1);
                }
            }
        }
    });
}

function initCollapsibleSections() {
    const cssControl = document.getElementById('n2l-css-control');
    if (!cssControl) return;

    cssControl.addEventListener('click', (e) => {
        const header = e.target.closest('.n2l-collapsible-header');
        if (header) {
            const section = header.closest('.n2l-collapsible-section');
            if (section) {
                section.classList.toggle('open');
            }
        }
    });
}

let promptGeneratorInitialized = false;

function initModals() {
    const { uiElements } = state;
    uiElements.termsModal = document.getElementById('n2l-terms-modal');
    uiElements.promptGeneratorModal = document.getElementById('n2l-prompt-generator-modal');
    uiElements.fullCssModal = document.getElementById('n2l-full-css-modal');
    uiElements.fullHtmlModal = document.getElementById('n2l-full-html-modal');
    uiElements.fullJsModal = document.getElementById('n2l-full-js-modal');
    uiElements.simplePromptModal = document.getElementById('n2l-simple-prompt-modal');
    uiElements.aiSettingsModal = document.getElementById('n2l-ai-settings-modal');
    uiElements.aiEditModal = document.getElementById('n2l-ai-edit-modal');
    const closeButtons = document.querySelectorAll('.n2l-close');

    uiElements.termsLink.addEventListener('click', (e) => {
        e.preventDefault();
        uiElements.termsModal.style.display = 'block';
    });

    closeButtons.forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.n2l-modal').style.display = 'none';
        });
    });

    uiElements.openPromptGenBtn.addEventListener('click', () => {
        uiElements.promptGeneratorModal.style.display = 'block';
        if (!promptGeneratorInitialized) {
            initPromptGenerator();
            promptGeneratorInitialized = true;
        }
    });

    // AI Modals
    if (uiElements.generateWithAiBtn) {
        uiElements.generateWithAiBtn.addEventListener('click', () => {
            uiElements.simplePromptModal.style.display = 'block';
        });
    }
    if (uiElements.simplePromptGenerateBtn) {
        uiElements.simplePromptGenerateBtn.addEventListener('click', () => {
            const promptText = document.getElementById('n2l-simple-prompt-textarea').value;
            if (promptText.trim()) {
                handleAiGeneration(promptText);
            } else {
                alert('Please enter a prompt.');
            }
        });
    }
    const openSettings = () => {
        if (uiElements.aiSettingsModal) uiElements.aiSettingsModal.style.display = 'block';
    }
    if (uiElements.aiSettingsBtn) uiElements.aiSettingsBtn.addEventListener('click', openSettings);
    if (uiElements.sidebarSettingsBtn) uiElements.sidebarSettingsBtn.addEventListener('click', openSettings);
    initAiSettings();


    if (uiElements.openFullCssModalBtn) {
        uiElements.openFullCssModalBtn.addEventListener('click', () => {
            state.uiElements.cmFullCssEditorModal.setValue(state.uiElements.cmFullCssEditor.getValue());
            state.uiElements.cmFullCssEditorModal.setOption('readOnly', false);
            uiElements.applyFullCssModalBtn.style.display = 'block';
            uiElements.fullCssModal.style.display = 'block';
            setTimeout(() => state.uiElements.cmFullCssEditorModal.refresh(), 1);
        });
        uiElements.applyFullCssModalBtn.addEventListener('click', () => {
            state.uiElements.cmFullCssEditor.setValue(state.uiElements.cmFullCssEditorModal.getValue());
            uiElements.applyFullCssBtn.click();
            uiElements.fullCssModal.style.display = 'none';
        });
    }
    
    if (uiElements.openFullHtmlModalBtn) {
        uiElements.openFullHtmlModalBtn.addEventListener('click', () => {
            if (state.uiElements.cmFullHtmlEditor) {
                state.uiElements.cmFullHtmlEditorModal.setValue(state.uiElements.cmFullHtmlEditor.getValue());
            }
            state.uiElements.cmFullHtmlEditorModal.setOption('readOnly', false);
            uiElements.applyFullHtmlModalBtn.style.display = 'block';
            uiElements.fullHtmlModal.style.display = 'block';
            setTimeout(() => state.uiElements.cmFullHtmlEditorModal.refresh(), 1);
        });
        uiElements.applyFullHtmlModalBtn.addEventListener('click', () => {
            state.uiElements.cmFullHtmlEditor.setValue(state.uiElements.cmFullHtmlEditorModal.getValue());
            uiElements.applyFullHtmlBtn.click();
            uiElements.fullHtmlModal.style.display = 'none';
        });
    }

    if (uiElements.openFullJsModalBtn) {
        uiElements.openFullJsModalBtn.addEventListener('click', () => {
            state.uiElements.cmFullJsEditorModal.setValue(state.uiElements.cmFullJsEditor.getValue());
            state.uiElements.cmFullJsEditorModal.setOption('readOnly', false);
            uiElements.applyFullJsModalBtn.style.display = 'block';
            uiElements.fullJsModal.style.display = 'block';
            setTimeout(() => state.uiElements.cmFullJsEditorModal.refresh(), 1);
        });
        uiElements.applyFullJsModalBtn.addEventListener('click', () => {
            state.uiElements.cmFullJsEditor.setValue(state.uiElements.cmFullJsEditorModal.getValue());
            uiElements.applyFullJsBtn.click();
            uiElements.fullJsModal.style.display = 'none';
        });
    }

    window.addEventListener('click', (e) => {
        if (e.target === uiElements.termsModal) {
            uiElements.termsModal.style.display = 'none';
        }
        if (e.target === uiElements.promptGeneratorModal) {
            uiElements.promptGeneratorModal.style.display = 'none';
        }
        if (e.target === uiElements.fullCssModal) {
            uiElements.fullCssModal.style.display = 'none';
        }
        if (e.target === uiElements.fullHtmlModal) {
            uiElements.fullHtmlModal.style.display = 'none';
        }
        if (e.target === uiElements.fullJsModal) {
            uiElements.fullJsModal.style.display = 'none';
        }
        if (e.target === uiElements.simplePromptModal) {
            uiElements.simplePromptModal.style.display = 'none';
        }
        if (e.target === uiElements.aiSettingsModal) {
            uiElements.aiSettingsModal.style.display = 'none';
        }
        if (e.target === uiElements.aiEditModal) {
            uiElements.aiEditModal.style.display = 'none';
        }
    });
}

function startResize(e) {
    state.isResizing = true;
    document.body.style.userSelect = 'none';
    document.body.style.pointerEvents = 'none';
    if (state.uiElements.previewIframe) state.uiElements.previewIframe.style.pointerEvents = 'none';
}

function resizeSidebar(e) {
    if (!state.isResizing) return;
    const sidebarWidth = e.clientX;
    const { sidebar } = state.uiElements;
    const minWidth = parseInt(getComputedStyle(sidebar).minWidth, 10);
    const maxWidth = window.innerWidth * (parseInt(getComputedStyle(sidebar).maxWidth, 10) / 100);
    
    if (sidebarWidth > minWidth && sidebarWidth < maxWidth) {
        sidebar.style.width = `${sidebarWidth}px`;
    }
}

function stopResize(e) {
    if (state.isResizing) {
        state.isResizing = false;
        document.body.style.userSelect = '';
        document.body.style.pointerEvents = '';
        if (state.uiElements.previewIframe) state.uiElements.previewIframe.style.pointerEvents = '';
        updateAllCommentIconsPositions();
    }
}

function initWYSIWYG() {
    const { wysiwygToolbar, wysiwygEditor } = state.uiElements;
    wysiwygToolbar.addEventListener('click', (e) => {
        const button = e.target.closest('.n2l-wysiwyg-button');
        if (!button) return;
        
        e.preventDefault();
        const command = button.getAttribute('data-command');
        
        if (command === 'createLink') {
            const url = prompt('Enter URL:', 'https://');
            if (url) {
                document.execCommand(command, false, url);
            }
        } else {
            document.execCommand(command, false, null);
        }
        
        updateWYSIWYGButtonStates();
        wysiwygEditor.focus();
    });
    
    wysiwygEditor.addEventListener('mouseup', updateWYSIWYGButtonStates);
    wysiwygEditor.addEventListener('keyup', updateWYSIWYGButtonStates);
    
    wysiwygEditor.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.execCommand('insertHTML', false, '<br><br>');
        }
    });
}

function updateWYSIWYGButtonStates() {
    const buttons = state.uiElements.wysiwygToolbar.querySelectorAll('.n2l-wysiwyg-button');
    buttons.forEach(button => {
        const command = button.getAttribute('data-command');
        if (command === 'createLink' || command === 'unlink' || command === 'removeFormat') return;
        
        if (document.queryCommandState(command)) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    });
}

function loadCodeIntoIframe(rawCode) {
    if (rawCode === null || rawCode === undefined) {
        console.error("loadCodeIntoIframe called with no code.");
        return;
    }
    state.selectedElement = null;
    state.originalJs = '';
    state.userScriptHasRun = false;

    state.commandHistory.clear();

    if (state.iframeDoc) {
        const existingIconContainer = state.iframeDoc.getElementById('n2l-comment-icon-container');
        if (existingIconContainer) {
            existingIconContainer.innerHTML = ''; 
        }
    }
    state.commentedElements.clear();
    
    if (state.previewModeActive) {
        togglePreviewMode();
    }

    let htmlContent = rawCode;
    let extractedCss = '';
    let extractedJs = '';

    const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
    htmlContent = htmlContent.replace(styleRegex, (match, css) => {
        extractedCss += css + '\n';
        return '';
    });

    const scriptRegex = /<script[^>]*>([\s\S]*?)<\/script>/gi;
    htmlContent = htmlContent.replace(scriptRegex, (match, js) => {
        if (!match.toLowerCase().includes('src=')) {
            extractedJs += js + '\n';
            return '';
        }
        return match;
    });
    state.originalJs = extractedJs.trim();

    state.cssManager.parseCss(extractedCss.trim());

    const iframeContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Preview</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans&family=Roboto:wght@300;400;700&display=swap">
            
	        <!-- Improvement B: Tailwind CSS Support -->
	        <script src="https://cdn.tailwindcss.com"></script>
	        <script>
	            tailwind.config = {
	                corePlugins: {
	                    preflight: false // This prevents Tailwind from resetting browser defaults
	                }
	            }
	        </script>
	        
            <style id="n2l-styles"></style>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>
        </head>
        <body>
            ${htmlContent.trim()}
        </body>
        </html>
    `;

    state.uiElements.previewIframe.srcdoc = iframeContent;

    state.uiElements.previewIframe.onload = () => {
        try {
            state.iframeWin = state.uiElements.previewIframe.contentWindow;
            state.iframeDoc = state.uiElements.previewIframe.contentDocument || state.iframeWin.document;

            if (!state.iframeDoc || !state.iframeDoc.body) {
                console.error("Could not access iframe document or body.");
                alert("Error: Could not initialize preview iframe.");
                return;
            }

            refreshIframeStyles();
            assignN2LIdsToDom(state.iframeDoc.body);
            rebuildOriginalElementsSnapshot();
            
            state.iframeDoc.body.addEventListener('click', handleIframeClick, true);
            state.iframeDoc.body.addEventListener('mouseover', handleIframeMouseOver, true);
            state.iframeDoc.body.addEventListener('mouseout', handleIframeMouseOut, true);
            
            scanForExistingComments();
            updateAllCommentIconsPositions();

            state.iframeWin.addEventListener('scroll', () => {
                updateAllCommentIconsPositions();
            }, true);

        } catch (e) {
            console.error("Error accessing iframe content:", e);
            alert("Error initializing iframe: " + e.message);
        }
    };
}

// Helper function to generate clean, formatted HTML for the editor view
function getFormattedHtml(el, keepIds = false) {
    const tempEl = el.cloneNode(true);

    // Clean up editor-specific attributes and classes from the clone
    tempEl.classList.remove('N2L_EDITOR_SELECTED');
    if (!keepIds) {
        tempEl.removeAttribute('data-n2l-id');
        tempEl.querySelectorAll('[data-n2l-id]').forEach(child => child.removeAttribute('data-n2l-id'));
    }
    if (tempEl.classList.length === 0) {
        tempEl.removeAttribute('class');
    }

    // Basic recursive formatting
    function format(node, level) {
        let indent = '  '.repeat(level);
        let output = '';
        const selfClosingTags = ['img', 'br', 'hr', 'input', 'link', 'meta'];

        if (node.nodeType === Node.TEXT_NODE) {
            if (node.textContent.trim()) {
                output += indent + node.textContent.trim() + '\n';
            }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            const tagName = node.tagName.toLowerCase();
            
            output += indent + '<' + tagName;
            for (let i = 0; i < node.attributes.length; i++) {
                const attr = node.attributes[i];
                // remove empty class attributes that might be left
                if (attr.name === 'class' && !attr.value) continue;
                output += ` ${attr.name}="${attr.value}"`;
            }
            
            if (selfClosingTags.includes(tagName)) {
                output += '>\n';
            } else {
                // Heuristic: if only child is text, keep it on one line.
                if (node.childNodes.length === 1 && node.childNodes[0].nodeType === Node.TEXT_NODE && node.childNodes[0].textContent.trim()) {
                    output += '>' + node.childNodes[0].textContent.trim() + `</${tagName}>\n`;
                } else if (node.childNodes.length > 0) {
                    output += '>\n';
                    node.childNodes.forEach(child => {
                        output += format(child, level + 1);
                    });
                    output += indent + `</${tagName}>\n`;
                } else {
                    output += `></${tagName}>\n`;
                }
            }
        }
        return output;
    }

    return format(tempEl, 0).trim();
}

// Helper function to get relevant JS snippets as a string for an element
function getJsSnippets(el) {
    if (!state.originalJs) return '';
    const id = el.id;
    const classes = Array.from(el.classList).filter(c => c !== 'N2L_EDITOR_SELECTED');

    if (!id && classes.length === 0) {
        return '';
    }

    const searchTerms = [];
    if (id) searchTerms.push(id);
    classes.forEach(c => searchTerms.push(c));

    const scriptLines = state.originalJs.split('\n');
    const relevantLines = new Set();
    const contextLines = 3; 

    scriptLines.forEach((line, index) => {
        for (const term of searchTerms) {
            if (!term) continue;
            const regex = new RegExp(`(^|\\W)${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}(\\W|$)`);
            if (regex.test(line)) {
                for (let i = Math.max(0, index - contextLines); i <= Math.min(scriptLines.length - 1, index + contextLines); i++) {
                    relevantLines.add(i);
                }
                break;
            }
        }
    });

    if (relevantLines.size === 0) {
        return '';
    }

    const sortedLines = Array.from(relevantLines).sort((a, b) => a - b);
    let result = '';
    let lastLine = -2;

    sortedLines.forEach((lineIndex) => {
        if (lineIndex > lastLine + 1 && result !== '') {
            result += '// ...\n';
        }
        result += scriptLines[lineIndex] + '\n';
        lastLine = lineIndex;
    });

    return result.trim();
}


// Helper function to find and display relevant JS snippets for an element
function populateJsSnippets(el) {
    const { jsSnippetsView } = state.uiElements;
    jsSnippetsView.innerHTML = ''; // Clear previous snippets

    const id = el.id;
    const classes = Array.from(el.classList).filter(c => c !== 'N2L_EDITOR_SELECTED');

    if (!id && classes.length === 0) {
        jsSnippetsView.innerHTML = '<div class="n2l-no-rules-message">Element has no ID or classes to search for in the script.</div>';
        return;
    }

    const searchTerms = [];
    if (id) searchTerms.push(id);
    classes.forEach(c => searchTerms.push(c));

    const scriptLines = state.originalJs.split('\n');
    const relevantLines = new Set();
    const contextLines = 3; // Number of lines before and after to show

    scriptLines.forEach((line, index) => {
        for (const term of searchTerms) {
            if (!term) continue; // Skip empty/invalid terms
            // Use a regex to avoid matching parts of words. Escape term for safety.
            const regex = new RegExp(`(^|\\W)${term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}(\\W|$)`);
            if (regex.test(line)) {
                for (let i = Math.max(0, index - contextLines); i <= Math.min(scriptLines.length - 1, index + contextLines); i++) {
                    relevantLines.add(i);
                }
                break; // Move to next line once a match is found
            }
        }
    });

    if (relevantLines.size === 0) {
        jsSnippetsView.innerHTML = '<div class="n2l-no-rules-message">No relevant JS snippets found for this element\'s ID or classes.</div>';
        return;
    }

    const sortedLines = Array.from(relevantLines).sort((a, b) => a - b);
    let currentSnippet = '';
    let lastLine = -2;

    sortedLines.forEach((lineIndex) => {
        if (lineIndex > lastLine + 1) {
            // If there's a gap, close the previous snippet and start a new one
            if (currentSnippet) {
                const pre = document.createElement('pre');
                pre.className = 'n2l-js-snippet';
                pre.textContent = currentSnippet.trim();
                jsSnippetsView.appendChild(pre);
            }
            currentSnippet = `// ... (line ${lineIndex + 1})\n`;
        }
        currentSnippet += scriptLines[lineIndex] + '\n';
        lastLine = lineIndex;
    });

    // Append the last snippet
    if (currentSnippet) {
        const pre = document.createElement('pre');
        pre.className = 'n2l-js-snippet';
        pre.textContent = currentSnippet.trim();
        jsSnippetsView.appendChild(pre);
    }
}

// Helper to get CSS rules for an element and all its descendants
function getCssForElementAndChildren(element) {
    const allElements = [element, ...element.querySelectorAll('*')];
    const allRules = new Map();

    allElements.forEach(el => {
        const rules = state.cssManager.getMatchingRules(el);
        rules.forEach(rule => {
            // Create a unique key for each rule to avoid duplicates
            const key = `${rule.selector}|${rule.media || ''}`;
            if (!allRules.has(key)) {
                allRules.set(key, rule);
            }
        });
    });

    return Array.from(allRules.values());
}


// --- AI Feature Functions ---

async function openAiEditModal() {
    if (!state.selectedElement) {
        alert('Please select an element to edit first.');
        return;
    }

    const { uiElements } = state;
    const modal = uiElements.aiEditModal;

    // Get modal elements
    const promptTextarea = document.getElementById('n2l-ai-edit-prompt-textarea');
    const cssContextRadios = document.querySelectorAll('input[name="ai-css-context"]');
    const htmlContextViewer = document.getElementById('n2l-ai-context-html');
    const cssContextViewer = document.getElementById('n2l-ai-context-css');
    const jsContextViewer = document.getElementById('n2l-ai-context-js');
    const runBtn = document.getElementById('n2l-run-ai-edit-btn');
    const screenshotCheckbox = document.getElementById('n2l-ai-include-screenshot');
    const screenshotPreviewContainer = document.getElementById('n2l-screenshot-preview-container');
    const screenshotPreviewImg = document.getElementById('n2l-screenshot-preview');
    
    // Reset state
    promptTextarea.value = '';
    document.getElementById('n2l-ai-css-context-children').checked = true;
    screenshotCheckbox.checked = true;
    screenshotPreviewContainer.style.display = 'none';
    screenshotPreviewImg.src = '';
    let screenshotDataUrl = null;

    const generateAndShowScreenshot = async () => {
        if (screenshotCheckbox.checked) {
            try {
                // Temporarily remove selection outline for clean screenshot
                state.selectedElement.classList.remove('N2L_EDITOR_SELECTED');

                const canvas = await html2canvas(state.iframeDoc.body, {
                    logging: false,
                });
                screenshotDataUrl = canvas.toDataURL('image/jpeg', 0.9); // Use jpeg for smaller size
                screenshotPreviewImg.src = screenshotDataUrl;
                screenshotPreviewContainer.style.display = 'block';

                // Restore selection outline
                state.selectedElement.classList.add('N2L_EDITOR_SELECTED');
            } catch (error) {
                console.error("Error generating screenshot:", error);
                screenshotPreviewContainer.style.display = 'none';
                screenshotCheckbox.checked = false;
                screenshotDataUrl = null;
            }
        } else {
            screenshotPreviewContainer.style.display = 'none';
            screenshotPreviewImg.src = '';
            screenshotDataUrl = null;
        }
    };

    screenshotCheckbox.onchange = generateAndShowScreenshot;

    const html = getFormattedHtml(state.selectedElement);
    
    // Populate static context
    htmlContextViewer.textContent = html;

    // Function to update JS and CSS context based on controls
    const updateAiContext = () => {
        // --- JS Context ---
        jsContextViewer.textContent = state.originalJs || 'No JavaScript on this page.';
        
        // --- CSS Context ---
        const cssContextMode = document.querySelector('input[name="ai-css-context"]:checked').value;
        let cssContext;
        if (cssContextMode === 'all') {
            cssContext = state.cssManager.cssRules.filter(r => r.selector !== '@raw');
        } else if (cssContextMode === 'children') {
            cssContext = getCssForElementAndChildren(state.selectedElement);
        } else { // 'matching'
            cssContext = state.cssManager.getMatchingRules(state.selectedElement);
        }
        
        const cssText = cssContext.map(rule => `${rule.media ? `${rule.media} { ` : ''}${rule.selector} { ${rule.properties} }${rule.media ? ` }` : ''}`).join('\n');
        cssContextViewer.textContent = cssText || 'No CSS rules found for this selection.';

        return {
            html,
            css: cssContext,
            js: state.originalJs, // ALWAYS send the full script to the AI to match the system prompt's contract.
            screenshot: screenshotCheckbox.checked ? screenshotDataUrl : null
        };
    };

    // Initial context population
    updateAiContext();

    // Generate screenshot on modal open
    await generateAndShowScreenshot();

    // Update context when controls change
    cssContextRadios.forEach(radio => {
        radio.onchange = updateAiContext;
    });

    modal.style.display = 'block';

    // Handle accordion
    const header = modal.querySelector('.n2l-collapsible-header');
    const section = modal.querySelector('.n2l-collapsible-section');
    if (header && section) {
        section.classList.remove('open');
        header.onclick = () => { // Use onclick to avoid multiple listeners
            section.classList.toggle('open');
        };
    }

    // Attach listener for the run button
    runBtn.onclick = () => {
        // Get the latest context in case controls were toggled
        const finalContext = updateAiContext();
        handleAiEdit(finalContext);
    };
}

async function handleAiEdit(context) {
    const prompt = document.getElementById('n2l-ai-edit-prompt-textarea').value;
    if (!prompt.trim()) {
        alert('Please enter a prompt describing your desired changes.');
        return;
    }

    const loader = document.getElementById('n2l-ai-edit-loading-overlay');
    loader.style.display = 'flex';

    try {
        const provider = localStorage.getItem('n2l-ai-provider') || 'openai';
        const model = localStorage.getItem('n2l-ai-model');
        const customModel = localStorage.getItem('n2l-ai-custom-model');
        const baseURL = localStorage.getItem('n2l-ai-base-url');

        if (!model) {
            alert('Please configure your AI provider and model in the settings first.');
            loader.style.display = 'none';
            return;
        }

        const config = {
            provider,
            model: model === 'custom' ? customModel : model,
            baseURL: provider === 'local' ? baseURL : undefined,
        };

        const result = await aiService.generateEdit(prompt, context, config);
        const jsWasChanged = result.javascript !== state.originalJs;
        
        // --- Apply JS changes (updates state, no DOM effect yet) ---
        if (jsWasChanged) {
            const command = new JSChangeCommand(state.originalJs, result.javascript);
            state.commandHistory.execute(command);
        }
        
        // --- Apply HTML change ---
        const oldHtml = state.selectedElement.outerHTML;
        // Simplified check: if AI returns HTML, apply it. The check against formatted HTML was too brittle.
        if (result.html) {
            const command = new HTMLChangeCommand(state.selectedElement, oldHtml, result.html);
            state.commandHistory.execute(command);
        }

        // --- Apply CSS changes ---
        // Use a single command to handle the batch update to preserve cascade order.
        if (result.css && context.css) {
            const command = new AiCssUpdateCommand(context.css, result.css);
            state.commandHistory.execute(command);
        }
        
        // --- Finalize and Refresh UI ---
        refreshAllUI();
        state.uiElements.aiEditModal.style.display = 'none';

        // If JS was changed, the DOM might be broken until the new script runs.
        // Automatically enter preview mode to apply the script changes.
        if (jsWasChanged && !state.previewModeActive) {
            togglePreviewMode();
        }

    } catch (error) {
        console.error('AI Edit Error:', error);
        alert(`An error occurred during AI edit: ${error.message}`);
    } finally {
        loader.style.display = 'none';
    }
}

export async function handleAiGeneration(promptText) {
    state.originalPrompt = promptText;
    const simplePromptModal = document.getElementById('n2l-simple-prompt-modal');
    let activeLoader = null;
    if (simplePromptModal && simplePromptModal.style.display === 'block') {
        activeLoader = simplePromptModal.querySelector('#n2l-ai-loading-overlay');
    }
    
    if (activeLoader) {
        activeLoader.style.display = 'flex';
    }

    try {
        const provider = localStorage.getItem('n2l-ai-provider') || 'openai';
        const model = localStorage.getItem('n2l-ai-model');
        const customModel = localStorage.getItem('n2l-ai-custom-model');
        const baseURL = localStorage.getItem('n2l-ai-base-url');

        if (!model) {
            alert('Please configure your AI provider and model in the settings first.');
            return;
        }

        const config = {
            provider,
            model: model === 'custom' ? customModel : model,
            baseURL: provider === 'local' ? baseURL : undefined,
        };

        const generatedCodeObject = await aiService.generateNewCode(promptText, config);
        
        let finalCode = generatedCodeObject.html || '';
        if (generatedCodeObject.css && generatedCodeObject.css.trim()) {
            finalCode += `\n\n<style>\n${generatedCodeObject.css.trim()}\n</style>`;
        }
        if (generatedCodeObject.javascript && generatedCodeObject.javascript.trim()) {
            const safeJs = generatedCodeObject.javascript.replace(/<\/script>/gi, '<\\/script>');
            finalCode += `\n\n<script>\n${safeJs.trim()}\n<\/script>`;
        }

        state.uiElements.welcomeCodeInput.value = finalCode;
        loadCodeIntoIframe(finalCode);
        
        // Hide modals
        if (simplePromptModal) simplePromptModal.style.display = 'none';
        if (state.uiElements.promptGeneratorModal) state.uiElements.promptGeneratorModal.style.display = 'none';
        if (state.uiElements.welcomePage) {
            state.uiElements.welcomePage.style.display = 'none';
            state.uiElements.topBar.style.display = 'flex';
        }

    } catch (error) {
        console.error('AI Generation Error:', error);
        alert(`An error occurred during AI generation: ${error.message}`);
    } finally {
        if (activeLoader) {
            activeLoader.style.display = 'none';
        }
    }
}

function initAiSettings() {
    const { uiElements } = state;
    const providerSelect = document.getElementById('n2l-ai-provider');
    const modelSelect = document.getElementById('n2l-ai-model');
    const customModelInput = document.getElementById('n2l-ai-custom-model');
    const apiKeyInput = document.getElementById('n2l-ai-api-key');
    const baseUrlContainer = document.getElementById('n2l-ai-base-url-container');
    const baseUrlInput = document.getElementById('n2l-ai-base-url');
    const saveBtn = document.getElementById('n2l-save-ai-settings-btn');
    const tabs = document.querySelectorAll('#n2l-ai-settings-modal .n2l-modal-tab-button');
    const panels = document.querySelectorAll('#n2l-ai-settings-modal .n2l-modal-tab-panel');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => p.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
    });

    // Populate providers
    providerSelect.innerHTML = '';
    for (const providerKey in PROVIDERS) {
        const option = document.createElement('option');
        option.value = providerKey;
        option.textContent = PROVIDERS[providerKey].name;
        providerSelect.appendChild(option);
    }

    function populateModels(providerKey) {
        modelSelect.innerHTML = '';
        const provider = PROVIDERS[providerKey];
        if (provider) {
            provider.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name;
                modelSelect.appendChild(option);
            });
        }
        // Allow custom models
        const customOption = document.createElement('option');
        customOption.value = 'custom';
        customOption.textContent = 'Custom...';
        modelSelect.appendChild(customOption);
    }

    function loadSettings() {
        const savedProvider = localStorage.getItem('n2l-ai-provider') || 'openai';
        providerSelect.value = savedProvider;
        
        populateModels(savedProvider);
        
        const savedModel = localStorage.getItem('n2l-ai-model');
        if (savedModel) modelSelect.value = savedModel;
        
        const savedCustomModel = localStorage.getItem('n2l-ai-custom-model') || '';
        customModelInput.value = savedCustomModel;

        const savedBaseUrl = localStorage.getItem('n2l-ai-base-url') || '';
        baseUrlInput.value = savedBaseUrl;
        
        apiKeyInput.value = aiService.getApiKey(savedProvider) || '';

        baseUrlContainer.style.display = savedProvider === 'local' ? 'block' : 'none';
        customModelInput.style.display = modelSelect.value === 'custom' ? 'block' : 'none';
    }

    providerSelect.addEventListener('change', () => {
        const providerKey = providerSelect.value;
        populateModels(providerKey);
        apiKeyInput.value = aiService.getApiKey(providerKey) || '';
        baseUrlContainer.style.display = providerKey === 'local' ? 'block' : 'none';
        customModelInput.style.display = modelSelect.value === 'custom' ? 'block' : 'none';
    });

    modelSelect.addEventListener('change', () => {
        customModelInput.style.display = modelSelect.value === 'custom' ? 'block' : 'none';
    });

    saveBtn.addEventListener('click', () => {
        const provider = providerSelect.value;
        const model = modelSelect.value;
        const customModel = customModelInput.value;
        const apiKey = apiKeyInput.value;
        const baseUrl = baseUrlInput.value;

        localStorage.setItem('n2l-ai-provider', provider);
        localStorage.setItem('n2l-ai-model', model);
        if (model === 'custom') localStorage.setItem('n2l-ai-custom-model', customModel);
        if (provider === 'local') localStorage.setItem('n2l-ai-base-url', baseUrl);

        if (apiKey) {
            aiService.saveApiKey(provider, apiKey);
        }

        alert('Settings saved!');
        state.uiElements.aiSettingsModal.style.display = 'none';
    });

    // Initial load
    loadSettings();
}


export function populateControls(el) {
    const { elementInfo, elementClassInput, elementIdInput, wysiwygEditor, textEditControl, imageSrcControl, imageSrcInput, cssRulesEditor, elementHtmlEditor, htmlControl } = state.uiElements;
    
    // Improvement C: Build Breadcrumbs
    const breadcrumbsContainer = document.getElementById('n2l-breadcrumbs');
    if (breadcrumbsContainer) {
        breadcrumbsContainer.innerHTML = '';
        const path = [];
        let current = el;
        while (current && current !== state.iframeDoc.body) {
            path.unshift(current);
            current = current.parentElement;
        }
        path.unshift(state.iframeDoc.body); // Add body

        path.forEach((node, index) => {
            const span = document.createElement('span');
            span.className = 'n2l-crumb';
            let name = node.tagName.toLowerCase();
            if (node.id) name += `#${node.id}`;
            else if (node.classList.length > 0 && !node.classList.contains('N2L_EDITOR_SELECTED')) {
                name += `.${node.classList[0]}`;
            }
            span.textContent = name;
            span.title = "Select parent";
            span.onclick = () => selectElement(node);
            
            breadcrumbsContainer.appendChild(span);
            
            if (index < path.length - 1) {
                const sep = document.createElement('span');
                sep.className = 'n2l-crumb-separator';
                sep.innerHTML = '<i class="fas fa-chevron-right"></i>';
                breadcrumbsContainer.appendChild(sep);
            }
        });
    }

    // Scenario 2: Show JS Warning
    const jsWarning = document.getElementById('n2l-js-warning');
    if (jsWarning) {
        // Heuristic: if ID or class suggests interaction
        const likelyInteractive = (el.id && (el.id.includes('btn') || el.id.includes('toggle'))) || 
                                  (el.tagName === 'BUTTON' || el.tagName === 'A');
        if (likelyInteractive && state.originalJs && state.originalJs.length > 0) {
            jsWarning.style.display = 'block';
        } else {
            jsWarning.style.display = 'none';
        }
    }

    const tagName = el.tagName.toLowerCase();
    const id = el.id ? `#${el.id}` : '';
    const classes = el.classList.length > 0 ? 
        `.${Array.from(el.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
    elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;

    elementClassInput.value = Array.from(el.classList)
        .filter(c => c !== 'N2L_EDITOR_SELECTED')
        .join(' ');
    elementIdInput.value = el.id || '';

    const inlineStyleInput = document.getElementById('n2l-inline-style-input');
    inlineStyleInput.value = el.style.cssText;

    const textEditableTags = ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'li', 'a', 'span', 'div', 'td', 'th', 'button', 'label'];
    
    // Tab visibility logic
    const contentTabButton = document.querySelector('.n2l-sidebar-tab[data-tab="n2l-content-tab"]');
    const jsTabButton = document.querySelector('.n2l-sidebar-tab[data-tab="n2l-js-tab"]');

    let isContentEditable = false;

    if (textEditableTags.includes(tagName) || (el.hasChildNodes() && Array.from(el.childNodes).some(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== ''))) {
        if (tagName === 'textarea') {
            wysiwygEditor.innerText = el.value;
        } else {
            wysiwygEditor.innerHTML = el.innerHTML;
        }
        textEditControl.style.display = 'block';
        imageSrcControl.style.display = 'none';
        updateWYSIWYGButtonStates();
        isContentEditable = true;
    } else if (tagName === 'img') {
        imageSrcInput.value = el.src || '';
        imageSrcControl.style.display = 'block';
        textEditControl.style.display = 'none';
        isContentEditable = true;
    } else {
        textEditControl.style.display = 'none';
        imageSrcControl.style.display = 'none';
        isContentEditable = false;
    }
    
    // Show/hide content and JS tabs based on context
    contentTabButton.style.display = isContentEditable ? '' : 'none';
    const hasJs = state.originalJs && state.originalJs.trim() !== '';
    jsTabButton.style.display = hasJs ? '' : 'none';


    // Set active tab, preserving the current selection if possible
    const allTabs = document.querySelectorAll('.n2l-sidebar-tab');
    const allPanels = document.querySelectorAll('.n2l-sidebar-tab-panel');
    allTabs.forEach(t => t.classList.remove('active'));
    allPanels.forEach(p => p.classList.remove('active'));

    let tabToActivate = state.activeSidebarTab;
    let targetButton = document.querySelector(`.n2l-sidebar-tab[data-tab="${tabToActivate}"]`);

    // If the preferred tab is hidden (e.g., Content tab for a non-editable element), find a visible fallback.
    if (!targetButton || targetButton.style.display === 'none') {
        const preferredOrder = ['n2l-content-tab', 'n2l-style-tab', 'n2l-html-tab', 'n2l-js-tab'];
        let foundVisibleTab = false;
        for (const tabId of preferredOrder) {
            const button = document.querySelector(`.n2l-sidebar-tab[data-tab="${tabId}"]`);
            if (button && button.style.display !== 'none') {
                tabToActivate = tabId;
                foundVisibleTab = true;
                break;
            }
        }
        if (!foundVisibleTab) { // Fallback if all preferred are hidden
            const firstVisible = document.querySelector('.n2l-sidebar-tab:not([style*="display: none"])');
            if (firstVisible) tabToActivate = firstVisible.getAttribute('data-tab');
        }
    }
    
    // Activate the chosen tab
    const finalButton = document.querySelector(`.n2l-sidebar-tab[data-tab="${tabToActivate}"]`);
    const finalPanel = document.getElementById(tabToActivate);
    if (finalButton && finalPanel) {
        finalButton.classList.add('active');
        finalPanel.classList.add('active');
        state.activeSidebarTab = tabToActivate; // Update state in case of fallback

        // Refresh any CodeMirror instance in the new active tab
        if (tabToActivate === 'n2l-html-tab' && state.uiElements.showFullHtmlCheckbox.checked) {
            setTimeout(() => state.uiElements.cmFullHtmlEditor.refresh(), 1);
        } else if (tabToActivate === 'n2l-js-tab') {
            setTimeout(() => state.uiElements.cmFullJsEditor.refresh(), 1);
        } else if (tabToActivate === 'n2l-style-tab' && state.uiElements.showFullCssCheckbox.checked) {
            setTimeout(() => state.uiElements.cmFullCssEditor.refresh(), 1);
        }
    }

    populateCssRules(el);

    const tempEl = el.cloneNode(true);
    tempEl.classList.remove('N2L_EDITOR_SELECTED');
    if (tempEl.classList.length === 0) {
        tempEl.removeAttribute('class');
    }
    let cleanHtml = getFormattedHtml(el, true);

    elementHtmlEditor.value = cleanHtml;
    htmlControl.style.display = 'block';

    // Populate JS tab
    if (hasJs) {
        state.uiElements.cmFullJsEditor.setValue(state.originalJs);
        populateJsSnippets(el);
    }
}

function refreshAllUI() {
    refreshIframeStyles();
    updateAllCommentIconsPositions();
    if (state.selectedElement) {
        populateControls(state.selectedElement);
        ensureSelectedElementIsVisible();
    }
}

function saveAsHtmlFile() {
    if (!state.iframeDoc || !state.iframeDoc.body) {
        alert("Please load some code first.");
        return;
    }

    try {
        // This logic is duplicated from showProcessedCode to create a self-contained export
        const processedBody = state.iframeDoc.body.cloneNode(true);
        
        const iconContainerClone = processedBody.querySelector('#n2l-comment-icon-container');
        if (iconContainerClone) iconContainerClone.remove();

        const allElementsInClone = Array.from(processedBody.querySelectorAll('*'));

        for (const el of allElementsInClone) {
            if (!el.parentNode) continue;

            const id = el.getAttribute('data-n2l-id');
            if (id && state.originalElementsSnapshot.has(id)) {
                const snapshot = state.originalElementsSnapshot.get(id);
                if (snapshot.className) el.setAttribute('class', snapshot.className);
                else el.removeAttribute('class');
                if (snapshot.styleCssText) el.style.cssText = snapshot.styleCssText;
                else el.removeAttribute('style');
            } else {
                el.remove();
            }
        }
            
        processedBody.querySelectorAll('[data-n2l-id]').forEach(el => el.removeAttribute('data-n2l-id'));
            
        let processedHTML = processedBody.innerHTML.trim();
        processedHTML = processedHTML.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ').replace(/class="\s*"/g, '').replace(/class='\s*'/g, '').replace(/\s+class=""/g, '').replace(/\s+class=''/g, '').replace(/class="\s+/g, 'class="').replace(/class='\s+/g, "class='");

        const processedCSS = state.cssManager.generateCss();

        let finalCode = `<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <title>Exported from Notes2LLM</title>\n`;
        if (processedCSS) {
            finalCode += `  <style>\n${processedCSS.trim()}\n  </style>\n`;
        }
        finalCode += `</head>\n<body>\n${processedHTML}\n`;

        if (state.originalJs) {
            const safeJs = state.originalJs.replace(/<\/script>/gi, '<\\/script>');
            finalCode += `\n<script>\n${safeJs.trim()}\n<\/script>\n`;
        }
        finalCode += `</body>\n</html>`;

        const blob = new Blob([finalCode], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        a.href = url;
        a.download = `notes2llm-export-${date}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

    } catch (e) {
        console.error("Error generating HTML file:", e);
        alert("An error occurred while generating the HTML file: " + e.message);
    }
}

function showProcessedCode() {
    if (!state.iframeDoc || !state.iframeDoc.body) {
        alert("Please load some code first.");
        return;
    }

    try {
        const processedBody = state.iframeDoc.body.cloneNode(true);
        
        const iconContainerClone = processedBody.querySelector('#n2l-comment-icon-container');
        if (iconContainerClone) iconContainerClone.remove();

        // Get a static list of all elements in the clone BEFORE we start modifying/removing them.
        const allElementsInClone = Array.from(processedBody.querySelectorAll('*'));

        for (const el of allElementsInClone) {
            // Check if element is still in the DOM, as it might have been removed
            // if its parent was removed in a previous iteration.
            if (!el.parentNode) {
                continue;
            }

            const id = el.getAttribute('data-n2l-id');
            if (id && state.originalElementsSnapshot.has(id)) {
                // It's an original element. Revert its class and style to the snapshot,
                // which contains manual edits but not JS-driven state changes.
                const snapshot = state.originalElementsSnapshot.get(id);
                
                if (snapshot.className) {
                    el.setAttribute('class', snapshot.className);
                } else {
                    el.removeAttribute('class');
                }

                if (snapshot.styleCssText) {
                    el.style.cssText = snapshot.styleCssText;
                } else {
                    el.removeAttribute('style');
                }
            } else {
                // This element was not in the original snapshot, so it was added dynamically by JS.
                // Remove it for a clean export of the initial state.
                el.remove();
            }
        }
            
        // Remove all data-n2l-id attributes from the final output
        processedBody.querySelectorAll('[data-n2l-id]').forEach(el => el.removeAttribute('data-n2l-id'));
            
        let processedHTML = processedBody.innerHTML.trim();
        
        // Final cleanup of any stray editor classes or empty class attributes
        processedHTML = processedHTML.replace(/\s*N2L_EDITOR_SELECTED\s*/g, ' ').replace(/class="\s*"/g, '').replace(/class='\s*'/g, '').replace(/\s+class=""/g, '').replace(/\s+class=''/g, '').replace(/class="\s+/g, 'class="').replace(/class='\s+/g, "class='");

        const processedCSS = state.cssManager.generateCss();
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 20px;
            border: 1px solid black;
            z-index: 2001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 80%;
            height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
        `;
        dialog.innerHTML = '<h3>Processed Code (Modified HTML + CSS/JS):</h3>';

        const promptSuggestion = document.createElement('p');
        promptSuggestion.style.cssText = `font-size: 0.9em; margin-bottom: 10px; padding: 8px; border-radius: 3px;`;
        promptSuggestion.innerHTML = "<b>A prompt you can use to ask the LLM to work on this according to your comments:</b><br>Please review the code and the comments I added for you. Preserve the changes I made to the content and only change something if I made an obvious mistake, either in the code or the language. Edit it guided by the comments. Provide the full code with no placeholders or omissions, and make sure that all functionalities remain intact.";
        dialog.appendChild(promptSuggestion);
        
        const toggleContainer = document.createElement('div');
        toggleContainer.style.cssText = `margin-bottom: 10px; padding: 8px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 3px;`;
        const toggleLabel = document.createElement('label');
        toggleLabel.style.cssText = `display: flex; align-items: center; cursor: pointer; font-size: 0.9em;`;
        const toggleCheckbox = document.createElement('input');
        toggleCheckbox.type = 'checkbox';
        toggleCheckbox.checked = true;
        toggleCheckbox.style.marginRight = '8px';
        toggleLabel.appendChild(toggleCheckbox);
        toggleLabel.appendChild(document.createTextNode('Include prompt instructions as comment in output code'));
        toggleContainer.appendChild(toggleLabel);
        dialog.appendChild(toggleContainer);
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `display: flex; justify-content: flex-end; margin-bottom: 10px;`;
        
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy to Clipboard';
        copyBtn.className = 'modal-button';
        copyBtn.onclick = () => {
            const textarea = dialog.querySelector('textarea');
            textarea.select();
            navigator.clipboard.writeText(textarea.value).then(() => {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy to Clipboard'; }, 2000);
            });
        };
        buttonContainer.appendChild(copyBtn);
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.className = 'modal-button';
        closeBtn.onclick = () => document.body.removeChild(dialog);
        buttonContainer.appendChild(closeBtn);
        
        dialog.appendChild(buttonContainer);
        
        const outputArea = document.createElement('textarea');
        outputArea.style.cssText = `width: 100%; height: 400px; font-family: monospace;`;
        
        const updateOutputContent = () => {
            let finalCode = '';
            if (toggleCheckbox.checked) {
                finalCode += `<!--\nLLM PROMPT:\nPlease review the code and the comments I added for you. Preserve the changes I made to the content and only change something if I made an obvious mistake, either in the code or the language. Edit it guided by the comments. Provide the full code with no placeholders or omissions, and make sure that all functionalities remain intact.\n-->\n\n`;
            }
            finalCode += processedHTML;
            if (processedCSS) finalCode += `\n\n<style>\n${processedCSS.trim()}\n</style>`;
            if (state.originalJs) finalCode += `\n\n<script>\n${state.originalJs.trim()}\n<\/script>`;
            outputArea.value = finalCode;
        };
        
        toggleCheckbox.addEventListener('change', updateOutputContent);
        updateOutputContent();
        
        dialog.appendChild(outputArea);

        const existingDialog = document.querySelector('.n2l-output-dialog');
        if (existingDialog) document.body.removeChild(existingDialog);
        dialog.classList.add('n2l-output-dialog');
        document.body.appendChild(dialog);

    } catch (e) {
        console.error("Error generating processed code:", e);
        alert("An error occurred while generating the processed code: " + e.message);
    }
}

function applyClassAndId() {
    if (!state.selectedElement) return;
    const oldHtml = state.selectedElement.outerHTML;
    Array.from(state.selectedElement.classList)
        .filter(cls => cls !== 'N2L_EDITOR_SELECTED')
        .forEach(cls => state.selectedElement.classList.remove(cls));
    const newClasses = state.uiElements.elementClassInput.value.trim().split(/\s+/).filter(Boolean);
    newClasses.forEach(cls => state.selectedElement.classList.add(cls));
    state.selectedElement.id = state.uiElements.elementIdInput.value.trim();
    const newHtml = state.selectedElement.outerHTML;
    const command = new HTMLChangeCommand(state.selectedElement, oldHtml, newHtml);
    state.commandHistory.execute(command);
    
    const id = state.selectedElement.getAttribute('data-n2l-id');
    if (id) {
        const cleanClasses = Array.from(state.selectedElement.classList)
            .filter(c => c !== 'N2L_EDITOR_SELECTED')
            .join(' ');
        state.originalElementsSnapshot.set(id, {
            className: cleanClasses,
            styleCssText: state.selectedElement.style.cssText
        });
    }
    refreshAllUI();
}

function applyText() {
    if (!state.selectedElement) return;
    const oldContent = state.selectedElement.tagName.toLowerCase() === 'textarea' ? 
        state.selectedElement.value : state.selectedElement.innerHTML;
    const newContent = state.uiElements.wysiwygEditor.innerHTML;
    const command = new TextChangeCommand(state.selectedElement, oldContent, newContent, true);
    state.commandHistory.execute(command);
    refreshAllUI();
}

function applyImageSource() {
    if (!state.selectedElement || state.selectedElement.tagName.toLowerCase() !== 'img') return;
    state.selectedElement.onload = () => {
        refreshAllUI();
        state.selectedElement.onload = null;
    };
    state.selectedElement.src = state.uiElements.imageSrcInput.value;
}

function applyHtmlChanges() {
    if (!state.selectedElement) return;
    const oldHtml = state.selectedElement.outerHTML;
    const newHtml = state.uiElements.elementHtmlEditor.value.trim();
    const command = new HTMLChangeCommand(state.selectedElement, oldHtml, newHtml);
    state.commandHistory.execute(command);
    refreshAllUI();
}

function applyInlineStyle() {
    if (!state.selectedElement) return;
    const oldHtml = state.selectedElement.outerHTML;
    state.selectedElement.style.cssText = document.getElementById('n2l-inline-style-input').value;
    const newHtml = state.selectedElement.outerHTML;
    const command = new HTMLChangeCommand(state.selectedElement, oldHtml, newHtml);
    state.commandHistory.execute(command);
    const id = state.selectedElement.getAttribute('data-n2l-id');
    if (id) {
        const cleanClasses = Array.from(state.selectedElement.classList)
            .filter(c => c !== 'N2L_EDITOR_SELECTED')
            .join(' ');
        state.originalElementsSnapshot.set(id, {
            className: cleanClasses,
            styleCssText: state.selectedElement.style.cssText
        });
    }
    refreshAllUI();
}

function populateCssRules(element) {
    const { cssRulesEditor } = state.uiElements;
    cssRulesEditor.innerHTML = '';
    const matchingRules = state.cssManager.getMatchingRules(element);
    
    if (matchingRules.length === 0) {
        cssRulesEditor.innerHTML = '<div class="n2l-no-rules-message">No CSS rules found for this element.</div>';
    } else {
        matchingRules.forEach(rule => {
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'n2l-css-rule-item';
            const mediaHeader = rule.media ? `<div class="n2l-css-media-query">${rule.media}</div>` : '';
            ruleDiv.innerHTML = `
                ${mediaHeader}
                <div class="n2l-css-selector">${rule.selector}</div>
                <textarea class="n2l-css-properties">${rule.properties}</textarea>
                <div class="n2l-rule-actions"><button>Update</button></div>
            `;
            ruleDiv.querySelector('button').addEventListener('click', () => {
                const newProps = ruleDiv.querySelector('textarea').value;
                state.cssManager.updateRule(rule.selector, newProps, rule.media);
                refreshIframeStyles();
                populateCssRules(element);
            });
            cssRulesEditor.appendChild(ruleDiv);
        });
    }

    // Scenario 1: Add Computed Styles View
    const computed = element.ownerDocument.defaultView.getComputedStyle(element);
    const importantProps = ['color', 'background-color', 'font-family', 'font-size', 'display', 'margin', 'padding'];
    
    const computedDiv = document.createElement('div');
    computedDiv.className = 'n2l-computed-style-box';
    let computedHtml = '<strong>Final Computed Styles:</strong><br>';
    
    importantProps.forEach(prop => {
        computedHtml += `<div class="n2l-computed-prop"><span>${prop}:</span> <span>${computed.getPropertyValue(prop)}</span></div>`;
    });
    
    computedDiv.innerHTML = computedHtml;
    // Insert before the editor or append
    cssRulesEditor.prepend(computedDiv); 
}

function showAddCssRuleForm() {
    if (!state.selectedElement) return;
    if (document.getElementById('n2l-new-rule-form')) return;

    const formDiv = document.createElement('div');
    formDiv.id = 'n2l-new-rule-form';
    formDiv.className = 'n2l-new-rule-form';
    
    let selectorSuggestion = '';
    if (state.selectedElement.id) {
        selectorSuggestion = `#${state.selectedElement.id}`;
    } else if (state.selectedElement.classList.length > 0) {
        const classes = Array.from(state.selectedElement.classList).filter(c => c !== 'N2L_EDITOR_SELECTED');
        if (classes.length > 0) selectorSuggestion = `.${classes[0]}`;
    } else {
        selectorSuggestion = state.selectedElement.tagName.toLowerCase();
    }
    
    formDiv.innerHTML = `
        <label for="n2l-new-rule-selector">CSS Selector:</label>
        <input type="text" id="n2l-new-rule-selector" value="${selectorSuggestion}">
        <label for="n2l-new-rule-properties">CSS Properties:</label>
        <textarea id="n2l-new-rule-properties" placeholder="color: red;"></textarea>
        <div class="n2l-rule-actions">
            <button id="n2l-cancel-new-rule-btn">Cancel</button>
            <button id="n2l-add-new-rule-btn">Add Rule</button>
        </div>
    `;
    
    state.uiElements.cssRulesEditor.appendChild(formDiv);
    document.getElementById('n2l-add-new-rule-btn').addEventListener('click', addNewCssRule);
    document.getElementById('n2l-cancel-new-rule-btn').addEventListener('click', () => formDiv.remove());
}

function addNewCssRule() {
    const selector = document.getElementById('n2l-new-rule-selector').value.trim();
    const properties = document.getElementById('n2l-new-rule-properties').value.trim();
    
    if (!selector || !properties) {
        alert('Please enter both a selector and properties.');
        return;
    }
    
    const command = new AddCSSRuleCommand(selector, properties, state.selectedElement.getAttribute('data-n2l-id'), false);
    state.commandHistory.execute(command);
    
    refreshIframeStyles();
    populateCssRules(state.selectedElement);
    document.getElementById('n2l-new-rule-form').remove();
}

function updateElementInfo() {
    if (!state.selectedElement) return;
    const tagName = state.selectedElement.tagName.toLowerCase();
    const id = state.selectedElement.id ? `#${state.selectedElement.id}` : '';
    const classes = state.selectedElement.classList.length > 0 ? 
        `.${Array.from(state.selectedElement.classList).filter(c => c !== 'N2L_EDITOR_SELECTED').join('.')}` : '';
    state.uiElements.elementInfo.textContent = `Tag: ${tagName}${id}${classes}`;
}

function initViewportSwitcher() {
    const { uiElements } = state;
    const buttons = [
        uiElements.viewportDesktopBtn,
        uiElements.viewportTabletBtn,
        uiElements.viewportMobileBtn
    ];

    buttons.forEach(button => {
        button.addEventListener('click', () => {
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const mode = button.id.replace('n2l-viewport-', '');
            uiElements.iframeContainer.classList.remove('n2l-viewport-tablet', 'n2l-viewport-mobile');
            if (mode !== 'desktop') {
                uiElements.iframeContainer.classList.add(`n2l-viewport-${mode}`);
            }

            // After resizing, update positions of floating elements
            setTimeout(() => {
                updateAllCommentIconsPositions();
                if (state.selectedElement) {
                    positionActionToolbar();
                }
            }, 350); // Delay should be slightly longer than CSS transition
        });
    });
}

function initCodeMirrorInstances() {
    const { uiElements } = state;
    const cmOptions = {
        lineNumbers: true,
        theme: 'material',
        lineWrapping: true,
    };

    uiElements.cmFullHtmlEditor = CodeMirror.fromTextArea(uiElements.fullHtmlEditor, { ...cmOptions, mode: 'htmlmixed' });
    uiElements.cmFullJsEditor = CodeMirror.fromTextArea(uiElements.fullJsEditor, { ...cmOptions, mode: 'javascript' });
    uiElements.cmFullCssEditor = CodeMirror.fromTextArea(uiElements.fullCssEditor, { ...cmOptions, mode: 'css' });

    uiElements.cmFullHtmlEditorModal = CodeMirror.fromTextArea(uiElements.fullHtmlEditorModal, { ...cmOptions, mode: 'htmlmixed' });
    uiElements.cmFullJsEditorModal = CodeMirror.fromTextArea(uiElements.fullJsEditorModal, { ...cmOptions, mode: 'javascript' });
    uiElements.cmFullCssEditorModal = CodeMirror.fromTextArea(uiElements.fullCssEditorModal, { ...cmOptions, mode: 'css' });

    // Snap-to-code editors
    uiElements.cmSnapHtml = CodeMirror.fromTextArea(document.getElementById('n2l-snap-html-editor'), { ...cmOptions, mode: 'htmlmixed' });
    uiElements.cmSnapCss = CodeMirror.fromTextArea(document.getElementById('n2l-snap-css-editor'), { ...cmOptions, mode: 'css' });
    uiElements.cmSnapJs = CodeMirror.fromTextArea(document.getElementById('n2l-snap-js-editor'), { ...cmOptions, mode: 'javascript' });
}

function initSnapToCodeEditing() {
    const snapPanel = document.getElementById('n2l-snap-to-code-panel');
    if (!snapPanel) return;

    snapPanel.addEventListener('click', (e) => {
        if (e.target.matches('.n2l-apply-snap-btn') || e.target.closest('.n2l-apply-snap-btn')) {
            const button = e.target.closest('.n2l-apply-snap-btn');
            const editorType = button.dataset.editor;

            if (editorType === 'html') {
                if (!state.iframeDoc || !state.iframeDoc.body) return;
                const oldHtml = state.iframeDoc.body.innerHTML;
                const newHtml = state.uiElements.cmSnapHtml.getValue();

                // Don't execute if nothing changed
                if (oldHtml === newHtml) return;

                const command = new FullHtmlChangeCommand(oldHtml, newHtml);
                state.commandHistory.execute(command);
                
                alert('Full HTML updated.');
            } else if (editorType === 'css') {
                const oldCss = state.cssManager.generateCss();
                const newCss = state.uiElements.cmSnapCss.getValue();
                if (oldCss.trim() !== newCss.trim()) {
                    const command = new FullCssChangeCommand(oldCss, newCss);
                    state.commandHistory.execute(command);
                    
                    // FIX: Re-apply highlighting because command execution resets editor content
                    if (state.selectedElement) {
                        populateCssRules(state.selectedElement);
                        // Small delay to ensure editor content is fully set before highlighting
                        setTimeout(() => snapToCode(state.selectedElement), 10);
                    }
                    alert('CSS stylesheet updated.');
                }
            } else if (editorType === 'js') {
                const oldJs = state.originalJs;
                const newJs = state.uiElements.cmSnapJs.getValue();
                
                if (oldJs !== newJs) {
                    const command = new JSChangeCommand(oldJs, newJs);
                    state.commandHistory.execute(command);
                    alert('JavaScript updated. Changes will apply on next interaction (e.g., entering Preview Mode or simulating a click).');
                }
            }
        }
    });
}

function initSnapToCodeTabs() {
    const snapTabContainer = document.querySelector('#n2l-snap-to-code-panel .n2l-snap-tabs');
    if (!snapTabContainer) return;

    snapTabContainer.addEventListener('click', (e) => {
        if (e.target.matches('.n2l-snap-tab')) {
            const button = e.target;
            const tabButtons = snapTabContainer.querySelectorAll('.n2l-snap-tab');
            const targetTab = button.dataset.tab;

            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const editorContainer = document.querySelector('.n2l-snap-editors-container');
            if (!editorContainer) return;
            const editorSections = editorContainer.querySelectorAll('.n2l-snap-section[data-snap-editor]');
            
            editorSections.forEach(section => {
                if (targetTab === 'all' || section.dataset.snapEditor === targetTab) {
                    section.style.display = 'flex';
                } else {
                    section.style.display = 'none';
                }
            });

            // Refresh CM instances
            setTimeout(() => {
                if (state.uiElements.cmSnapHtml) state.uiElements.cmSnapHtml.refresh();
                if (state.uiElements.cmSnapCss) state.uiElements.cmSnapCss.refresh();
                if (state.uiElements.cmSnapJs) state.uiElements.cmSnapJs.refresh();
            }, 1);
        }
    });
}

// --- Snap-to-Code Functions ---
let snapCodeMarkers = [];

function clearHighlights() {
    snapCodeMarkers.forEach(marker => marker.clear());
    snapCodeMarkers = [];
}

function highlightText(cmInstance, textToFind, className, scrollToFirst) {
    if (!textToFind || !cmInstance) return false;
    // Simple text find; regex might be too slow/complex for this.
    const cleanText = textToFind.trim();
    if (!cleanText) return false;

    const cursor = cmInstance.getSearchCursor(cleanText, { line: 0, ch: 0 }, { caseFold: false });
    let found = false;

    while (cursor.findNext()) {
        const marker = cmInstance.markText(cursor.from(), cursor.to(), { className });
        snapCodeMarkers.push(marker);
        if (!found) {
            found = true;
            if (scrollToFirst) {
                cmInstance.scrollIntoView({ from: cursor.from(), to: cursor.to() }, 150);
            }
        }
    }
    return found;
}

function highlightCssSelector(cmInstance, selector, className, scrollToFirst) {
    if (!selector || !cmInstance) return false;
    
    // 1. Escape regex characters
    let escaped = selector.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
    // 2. Normalize whitespace to single spaces
    escaped = escaped.replace(/\s+/g, ' ');
    
    // 3. Handle combinators: allow flexible whitespace around them
    escaped = escaped.replace(/\s*>\s*/g, '\\s*>\\s*');
    escaped = escaped.replace(/\s*~\s*/g, '\\s*~\\s*');
    escaped = escaped.replace(/\s*,\s*/g, '\\s*,\\s*');
    // Handle + (escaped as \+)
    escaped = escaped.replace(/\s*\\\+\s*/g, '\\s*\\+\\s*');
    
    // 4. Handle attribute selectors flexibility [attr=val] vs [attr="val"]
    // Replace literal [ with \[\s*
    escaped = escaped.replace(/\\\[/g, '\\[\\s*');
    // Replace literal = with \s*=\s*["']?
    escaped = escaped.replace(/=/g, '\\s*=\\s*["\']?');
    // Replace literal ] with ["']?\s*\]
    escaped = escaped.replace(/\\\]/g, '["\']?\\s*\\]');
    // Replace existing quotes in selector with optional quotes pattern
    escaped = escaped.replace(/\\['"]/g, '["\']?');

    // 5. Replace remaining single spaces (descendant combinators) with \s+
    escaped = escaped.replace(/ /g, '\\s+');
    
    try {
        const regex = new RegExp(escaped, 'i');
        const cursor = cmInstance.getSearchCursor(regex, { line: 0, ch: 0 });
        let found = false;

        while (cursor.findNext()) {
            const marker = cmInstance.markText(cursor.from(), cursor.to(), { className });
            snapCodeMarkers.push(marker);
            if (!found) {
                found = true;
                if (scrollToFirst) {
                    cmInstance.scrollIntoView({ from: cursor.from(), to: cursor.to() }, 150);
                }
            }
        }
        return found;
    } catch (e) {
        // Fallback to simple text search if regex fails
        return highlightText(cmInstance, selector, className, scrollToFirst);
    }
}

export function snapToCode(element) {
    clearHighlights();
    const { cmSnapHtml, cmSnapCss, cmSnapJs } = state.uiElements;

    // --- 1. Snap to HTML ---
    const elementHtmlFirstLine = getFormattedHtml(element, true).split('\n')[0];
    highlightText(cmSnapHtml, elementHtmlFirstLine, 'n2l-cm-highlight-main', true);

    // --- 2. Snap to CSS ---
    const matchingRules = state.cssManager.getMatchingRules(element);
    if (matchingRules.length > 0) {
        // Snap to the most specific/last rule
        const mainRule = matchingRules[matchingRules.length - 1];
        highlightCssSelector(cmSnapCss, mainRule.selector, 'n2l-cm-highlight-main', true);

        // Highlight other rules
        matchingRules.slice(0, -1).forEach(rule => {
            highlightCssSelector(cmSnapCss, rule.selector, 'n2l-cm-highlight-secondary', false);
        });
    }

    // --- 3. Highlight in JS ---
    const id = element.id;
    const classes = Array.from(element.classList).filter(c => c !== 'N2L_EDITOR_SELECTED');
    const searchTerms = [];
    if (id) searchTerms.push(`'${id}'`, `"${id}"`);
    classes.forEach(c => searchTerms.push(`'.${c}'`, `"${c}"`));

    let scrolledToJs = false;
    searchTerms.forEach(term => {
        if (highlightText(cmSnapJs, term, 'n2l-cm-highlight-secondary', !scrolledToJs)) {
            scrolledToJs = true;
        }
    });
}

export function clearSnapToCodeHighlights() {
    clearHighlights();
}

// --- Project Import/Export ---

function rehydrateCommand(data) {
    const commandMap = {
        TextChangeCommand, HTMLChangeCommand, AddCSSRuleCommand, 
        CSSRuleChangeCommand, RemoveCSSRuleCommand, JSChangeCommand, 
        AiCssUpdateCommand, RemoveElementCommand, CopyElementCommand,
        MoveElementCommand, FullCssChangeCommand
    };

    const CommandClass = commandMap[data.type];
    if (!CommandClass) {
        console.error(`Unknown command type during import: ${data.type}`);
        return null;
    }

    // Create a new instance and populate its properties from the JSON data.
    const instance = Object.create(CommandClass.prototype);
    Object.assign(instance, data);
    
    return instance;
}

function importHtmlFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("Importing an HTML file will overwrite your current work. Are you sure you want to continue?")) {
        event.target.value = ''; // Reset file input
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const htmlContent = e.target.result;
            loadCodeIntoIframe(htmlContent);
            if (state.uiElements.welcomePage) {
                state.uiElements.welcomePage.style.display = 'none';
                state.uiElements.topBar.style.display = 'flex';
            }
        } catch (error) {
            console.error("Failed to import HTML file:", error);
            alert(`Failed to import HTML file. Error: ${error.message}`);
        } finally {
            event.target.value = ''; // Reset file input
        }
    };
    reader.readAsText(file);
}

function exportProject() {
    if (!state.iframeDoc || !state.iframeDoc.body) {
        alert("Please load some code first to export a project.");
        return;
    }

    // We need to get the "original" raw code, not the current state of the DOM
    // The original snapshot helps reconstruct the initial state.
    const processedBody = state.iframeDoc.body.cloneNode(true);
    const allElementsInClone = Array.from(processedBody.querySelectorAll('[data-n2l-id]'));

    for (const el of allElementsInClone) {
        const id = el.getAttribute('data-n2l-id');
        if (id && state.originalElementsSnapshot.has(id)) {
            const snapshot = state.originalElementsSnapshot.get(id);
            if (snapshot.className) el.setAttribute('class', snapshot.className);
            else el.removeAttribute('class');
            if (snapshot.styleCssText) el.style.cssText = snapshot.styleCssText;
            else el.removeAttribute('style');
        }
    }
    processedBody.querySelectorAll('[data-n2l-id]').forEach(el => el.removeAttribute('data-n2l-id'));


    const projectData = {
        version: '1.0.1',
        timestamp: new Date().toISOString(),
        settings: {
            aiProvider: localStorage.getItem('n2l-ai-provider'),
            aiModel: localStorage.getItem('n2l-ai-model'),
            aiCustomModel: localStorage.getItem('n2l-ai-custom-model'),
            aiBaseUrl: localStorage.getItem('n2l-ai-base-url'),
        },
        code: {
            html: processedBody.innerHTML, // Export the initial state HTML
            css: state.cssManager.originalCssText,
            js: state.originalJs,
        },
        originalPrompt: state.originalPrompt,
        history: {
            undoStack: state.commandHistory.undoStack,
            redoStack: state.commandHistory.redoStack,
        }
    };

    const jsonString = JSON.stringify(projectData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    a.href = url;
    a.download = `n2l-project-${date}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importProject(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("Importing a project will overwrite your current work. Are you sure you want to continue?")) {
        event.target.value = ''; // Reset file input
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const projectData = JSON.parse(e.target.result);

            // Basic validation
            if (!projectData.version || !projectData.code) {
                throw new Error("Invalid project file format.");
            }

            // 1. Restore settings
            const { settings } = projectData;
            if (settings) {
                if(settings.aiProvider) localStorage.setItem('n2l-ai-provider', settings.aiProvider);
                if(settings.aiModel) localStorage.setItem('n2l-ai-model', settings.aiModel);
                if(settings.aiCustomModel) localStorage.setItem('n2l-ai-custom-model', settings.aiCustomModel);
                if(settings.aiBaseUrl) localStorage.setItem('n2l-ai-base-url', settings.aiBaseUrl);
            }
            
            // 2. Restore prompt
            state.originalPrompt = projectData.originalPrompt || '';
            
            // 3. Prepare full code
            const { code } = projectData;
            let fullCode = code.html || '';
            if (code.css) fullCode += `\n\n<style>\n${code.css}\n</style>`;
            if (code.js) {
                const safeJs = code.js.replace(/<\/script>/gi, '<\\/script>');
                fullCode += `\n\n<script>\n${safeJs}\n<\/script>`;
            }

            // 4. Load code into iframe. This is async.
            if (state.uiElements.welcomePage) {
                state.uiElements.welcomePage.style.display = 'none';
                state.uiElements.topBar.style.display = 'flex';
            }
            loadCodeIntoIframe(fullCode);

            // 5. Restore history AFTER iframe has loaded.
            const originalOnload = state.uiElements.previewIframe.onload;
            state.uiElements.previewIframe.onload = () => {
                if (originalOnload) originalOnload.apply(state.uiElements.previewIframe);
                
                try {
                    const { history } = projectData;
                    state.commandHistory.clear();
                    if (history && history.undoStack) {
                        state.commandHistory.undoStack = history.undoStack.map(rehydrateCommand).filter(Boolean);
                    }
                    if (history && history.redoStack) {
                        state.commandHistory.redoStack = history.redoStack.map(rehydrateCommand).filter(Boolean);
                    }
                    
                    // Apply all commands in the undo stack silently to bring the DOM to the saved state
                    state.commandHistory.isExecutingCommand = true; // Prevent new commands from being added to undo stack
                    state.commandHistory.undoStack.forEach(command => {
                        command.execute();
                    });
                    state.commandHistory.isExecutingCommand = false;

                    refreshAllUI();
                    state.commandHistory.updateUI();
                    console.log("Project imported successfully.");

                } catch (historyError) {
                    console.error("Error restoring project history:", historyError);
                    alert("Project code loaded, but there was an error restoring the edit history.");
                    state.commandHistory.clear();
                } finally {
                    state.uiElements.previewIframe.onload = originalOnload;
                }
            };

        } catch (error) {
            console.error("Failed to import project:", error);
            alert(`Failed to import project. The file may be invalid or corrupt. Error: ${error.message}`);
        } finally {
            event.target.value = ''; // Reset file input
        }
    };
    reader.readAsText(file);
}

export function initUI() {
    // Populate UI elements from DOM
    const { uiElements } = state;
    uiElements.topBar = document.querySelector('.n2l-top-bar');
    uiElements.previewPane = document.getElementById('n2l-preview-pane');
    uiElements.iframeContainer = document.getElementById('n2l-iframe-container');
    uiElements.viewportDesktopBtn = document.getElementById('n2l-viewport-desktop');
    uiElements.viewportTabletBtn = document.getElementById('n2l-viewport-tablet');
    uiElements.viewportMobileBtn = document.getElementById('n2l-viewport-mobile');
    uiElements.previewIframe = document.getElementById('n2l-preview-iframe');
	uiElements.sidebar = document.getElementById('n2l-sidebar');
	uiElements.resizer = document.getElementById('n2l-resizer');
    uiElements.sidebarToggleBtn = document.getElementById('n2l-sidebar-toggle');
	uiElements.controlsPanel = document.getElementById('n2l-controls-panel');
	uiElements.elementInfo = document.getElementById('n2l-element-info');
	uiElements.actionToolbar = document.getElementById('n2l-action-toolbar');
	uiElements.selectorIndicator = document.getElementById('n2l-selector-indicator');
	uiElements.previewModeBtn = document.getElementById('n2l-preview-mode-btn');
	uiElements.previewModeIndicator = document.getElementById('n2l-preview-mode-indicator');
    uiElements.getCodeBtn = document.getElementById('n2l-get-code-btn');
    uiElements.exportProjectBtn = document.getElementById('n2l-export-project-btn');
    uiElements.importProjectInput = document.getElementById('n2l-import-project-input');
    uiElements.importHtmlInput = document.getElementById('n2l-import-html-input');
    uiElements.elementClassInput = document.getElementById('n2l-element-class');
	uiElements.elementIdInput = document.getElementById('n2l-element-id');
    uiElements.wysiwygEditor = document.getElementById('n2l-wysiwyg-editor');
	uiElements.wysiwygToolbar = document.querySelector('.n2l-wysiwyg-toolbar');
    uiElements.textEditControl = document.getElementById('n2l-text-edit-control');
	uiElements.imageSrcControl = document.getElementById('n2l-image-src-control');
	uiElements.imageSrcInput = document.getElementById('n2l-image-src-input');
	uiElements.cssRulesEditor = document.getElementById('n2l-css-rules-editor');
    uiElements.htmlControl = document.getElementById('n2l-html-control');
	uiElements.elementHtmlEditor = document.getElementById('n2l-element-html-editor');

    // Snap-to-code panel
    uiElements.snapToCodePanel = document.getElementById('n2l-snap-to-code-panel');

    // Full view elements
    uiElements.showFullCssCheckbox = document.getElementById('n2l-show-full-css');
    uiElements.elementStyleControls = document.getElementById('n2l-element-style-controls');
    uiElements.fullCssView = document.getElementById('n2l-full-css-view');
    uiElements.fullCssEditor = document.getElementById('n2l-full-css-editor');
    uiElements.applyFullCssBtn = document.getElementById('n2l-apply-full-css');
    
    uiElements.showFullHtmlCheckbox = document.getElementById('n2l-show-full-html');
    uiElements.elementHtmlView = document.getElementById('n2l-element-html-view');
    uiElements.fullHtmlView = document.getElementById('n2l-full-html-view');
    uiElements.fullHtmlEditor = document.getElementById('n2l-full-html-editor');
    uiElements.applyFullHtmlBtn = document.getElementById('n2l-apply-full-html');

    // JS view elements
    uiElements.jsSnippetsView = document.getElementById('n2l-js-snippets-view');
    uiElements.fullJsEditor = document.getElementById('n2l-full-js-editor');
    uiElements.applyFullJsBtn = document.getElementById('n2l-apply-full-js');

    // Code editor modal elements
    uiElements.openFullCssModalBtn = document.getElementById('n2l-open-full-css-modal');
    uiElements.openFullHtmlModalBtn = document.getElementById('n2l-open-full-html-modal');
    uiElements.openFullJsModalBtn = document.getElementById('n2l-open-full-js-modal');
    uiElements.applyFullCssModalBtn = document.getElementById('n2l-apply-full-css-modal');
    uiElements.applyFullHtmlModalBtn = document.getElementById('n2l-apply-full-html-modal');
    uiElements.applyFullJsModalBtn = document.getElementById('n2l-apply-full-js-modal');
    uiElements.fullCssEditorModal = document.getElementById('n2l-full-css-editor-modal');
    uiElements.fullHtmlEditorModal = document.getElementById('n2l-full-html-editor-modal');
    uiElements.fullJsEditorModal = document.getElementById('n2l-full-js-editor-modal');

    // AI Buttons
    uiElements.simplePromptGenerateBtn = document.getElementById('n2l-simple-prompt-generate-btn');
    uiElements.sidebarSettingsBtn = document.getElementById('n2l-sidebar-settings-btn');
    uiElements.aiEditBtn = document.getElementById('n2l-ai-edit-btn');


    initWelcomePage();
    if (state.uiElements.topBar) state.uiElements.topBar.style.display = 'none';
    initCodeMirrorInstances();
    initModals();
    initViewportSwitcher();
    initSidebarTabs();
    initCollapsibleSections();
    initWYSIWYG();
    initSnapToCodeTabs();
    initSnapToCodeEditing();

    document.getElementById('n2l-sidebar-logo-img').src = logoUrl;

    // Mode Switcher Logic
    document.getElementById('n2l-mode-gui-btn').addEventListener('click', () => setEditingMode('gui'));
    document.getElementById('n2l-mode-snap-btn').addEventListener('click', () => setEditingMode('snap-to-code'));

    // Top Bar Menu Logic
    document.querySelectorAll('.n2l-menu-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const content = button.nextElementSibling;
            const isVisible = content.style.display === 'block';
            // Hide all menus
            document.querySelectorAll('.n2l-menu-content').forEach(c => c.style.display = 'none');
            // Toggle current menu
            content.style.display = isVisible ? 'none' : 'block';
        });
    });
    // Hide menus if clicking elsewhere
    window.addEventListener('click', (e) => {
        if (!e.target.matches('.n2l-menu-btn')) {
            document.querySelectorAll('.n2l-menu-content').forEach(c => c.style.display = 'none');
        }
    });


    // Event Listeners
    uiElements.sidebarToggleBtn.addEventListener('click', () => {
        const isNowCollapsed = uiElements.sidebar.classList.toggle('collapsed');
        if (isNowCollapsed) {
            uiElements.sidebar.style.width = '';
        }
        // After resizing, update positions of floating elements
        setTimeout(() => {
            updateAllCommentIconsPositions();
            if (state.selectedElement) {
                positionActionToolbar();
            }
        }, 350); // Delay should be slightly longer than CSS transition
    });

    uiElements.resizer.addEventListener('mousedown', startResize);
    document.addEventListener('mousemove', resizeSidebar);
    document.addEventListener('mouseup', stopResize);

    // Wire up top bar controls
    document.getElementById('n2l-undo-btn').addEventListener('click', () => {
        state.commandHistory.undo();
        refreshAllUI();
    });
    document.getElementById('n2l-redo-btn').addEventListener('click', () => {
        state.commandHistory.redo();
        refreshAllUI();
    });
    uiElements.previewModeBtn.addEventListener('click', togglePreviewMode);
    uiElements.getCodeBtn.addEventListener('click', showProcessedCode);
    document.getElementById('n2l-save-as-file-btn').addEventListener('click', saveAsHtmlFile);
    uiElements.exportProjectBtn.addEventListener('click', exportProject);
    uiElements.importProjectInput.addEventListener('change', importProject);
    uiElements.importHtmlInput.addEventListener('change', importHtmlFile);
    
    // Control panel listeners
    document.getElementById('n2l-apply-class-id').addEventListener('click', applyClassAndId);
    document.getElementById('n2l-apply-text-change').addEventListener('click', applyText);
    document.getElementById('n2l-apply-src-change').addEventListener('click', applyImageSource);
    document.getElementById('n2l-apply-html-changes').addEventListener('click', applyHtmlChanges);
    document.getElementById('n2l-add-css-rule-btn').addEventListener('click', showAddCssRuleForm);
    document.getElementById('n2l-apply-inline-style').addEventListener('click', applyInlineStyle);

    // Full view toggles and apply buttons
    if (uiElements.showFullCssCheckbox) {
        uiElements.showFullCssCheckbox.addEventListener('change', (e) => {
            const showFull = e.target.checked;
            if (uiElements.elementStyleControls) uiElements.elementStyleControls.style.display = showFull ? 'none' : 'block';
            if (uiElements.fullCssView) uiElements.fullCssView.style.display = showFull ? 'block' : 'none';
            if (showFull) {
                state.uiElements.cmFullCssEditor.setValue(state.cssManager.generateCss());
                setTimeout(() => state.uiElements.cmFullCssEditor.refresh(), 1);
            }
        });
    }

    if (uiElements.applyFullCssBtn) {
        uiElements.applyFullCssBtn.addEventListener('click', () => {
            const oldCss = state.cssManager.generateCss();
            const newCss = state.uiElements.cmFullCssEditor.getValue();
            if (oldCss.trim() !== newCss.trim()) {
                const command = new FullCssChangeCommand(oldCss, newCss);
                state.commandHistory.execute(command);
                if (state.selectedElement) {
                    populateCssRules(state.selectedElement);
                }
            }
        });
    }

    if (uiElements.showFullHtmlCheckbox) {
        uiElements.showFullHtmlCheckbox.addEventListener('change', (e) => {
            const showFull = e.target.checked;
            if (uiElements.elementHtmlView) uiElements.elementHtmlView.style.display = showFull ? 'none' : 'block';
            if (uiElements.fullHtmlView) uiElements.fullHtmlView.style.display = showFull ? 'block' : 'none';
            if (showFull && state.iframeDoc && state.iframeDoc.body) {
                let fullBodyHtml = '';
                state.iframeDoc.body.childNodes.forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        fullBodyHtml += getFormattedHtml(node, true) + '\n';
                    } else if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                        fullBodyHtml += node.textContent.trim() + '\n';
                    } else if (node.nodeType === Node.COMMENT_NODE) {
                        fullBodyHtml += `<!--${node.nodeValue}-->\n`;
                    }
                });
                state.uiElements.cmFullHtmlEditor.setValue(fullBodyHtml.trim());
                setTimeout(() => state.uiElements.cmFullHtmlEditor.refresh(), 1);
            }
        });
    }

    if (uiElements.applyFullHtmlBtn) {
        uiElements.applyFullHtmlBtn.addEventListener('click', () => {
            if (!state.iframeDoc || !state.iframeDoc.body) return;
            const oldHtml = state.iframeDoc.body.innerHTML;
            const newHtml = state.uiElements.cmFullHtmlEditor.getValue();
            
            // Don't execute if nothing changed
            if (oldHtml === newHtml) return;

            const command = new FullHtmlChangeCommand(oldHtml, newHtml);
            state.commandHistory.execute(command);
            
            alert('Full HTML updated.');
        });
    }

    if (uiElements.applyFullJsBtn) {
        uiElements.applyFullJsBtn.addEventListener('click', () => {
            state.originalJs = state.uiElements.cmFullJsEditor.getValue();
            state.userScriptHasRun = false; // Force re-run on next interaction
            alert('JavaScript updated. Changes will apply on next interaction (e.g., entering Preview Mode or simulating a click).');
        });
    }

    // Toolbar listeners
    if (uiElements.aiEditBtn) uiElements.aiEditBtn.addEventListener('click', openAiEditModal);
    document.getElementById('n2l-remove-btn').addEventListener('click', removeSelectedElement);
    document.getElementById('n2l-copy-btn').addEventListener('click', copyElement);
    document.getElementById('n2l-add-comment-btn').addEventListener('click', addCommentForElement);
    document.getElementById('n2l-move-up-btn').addEventListener('click', moveElementUp);
    document.getElementById('n2l-move-down-btn').addEventListener('click', moveElementDown);
    document.getElementById('n2l-toggle-state-btn').addEventListener('click', toggleElementState);
    document.getElementById('n2l-toggle-hover-btn').addEventListener('click', toggleHoverState);

    window.addEventListener('scroll', updateAllCommentIconsPositions);
    window.addEventListener('resize', updateAllCommentIconsPositions);

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            state.commandHistory.undo();
        } else if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
            e.preventDefault();
            state.commandHistory.redo();
        }
    });

    // Snap-to-code fullscreen buttons
    document.querySelectorAll('.n2l-snap-fullscreen-btn').forEach(button => {
        button.addEventListener('click', () => {
            const editorType = button.dataset.editor;
            if (editorType === 'html') {
                state.uiElements.cmFullHtmlEditorModal.setValue(state.uiElements.cmSnapHtml.getValue());
                state.uiElements.cmFullHtmlEditorModal.setOption('readOnly', true);
                uiElements.applyFullHtmlModalBtn.style.display = 'none';
                uiElements.fullHtmlModal.style.display = 'block';
                setTimeout(() => state.uiElements.cmFullHtmlEditorModal.refresh(), 1);
            } else if (editorType === 'css') {
                state.uiElements.cmFullCssEditorModal.setValue(state.uiElements.cmSnapCss.getValue());
                state.uiElements.cmFullCssEditorModal.setOption('readOnly', true);
                uiElements.applyFullCssModalBtn.style.display = 'none';
                uiElements.fullCssModal.style.display = 'block';
                setTimeout(() => state.uiElements.cmFullCssEditorModal.refresh(), 1);
            } else if (editorType === 'js') {
                state.uiElements.cmFullJsEditorModal.setValue(state.uiElements.cmSnapJs.getValue());
                state.uiElements.cmFullJsEditorModal.setOption('readOnly', true);
                uiElements.applyFullJsModalBtn.style.display = 'none';
                uiElements.fullJsModal.style.display = 'block';
                setTimeout(() => state.uiElements.cmFullJsEditorModal.refresh(), 1);
            }
        });
    });

    window.handleAiGeneration = handleAiGeneration;
}
